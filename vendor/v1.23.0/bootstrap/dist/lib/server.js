"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.initHandler = exports.CONTENT_TYPE_TEXT_PLAIN = exports.CONTENT_TYPE_APPLICATION_JSON = exports.HEADER_CONTENT_TYPE = void 0;
const tslib_1 = require("tslib");
const express_1 = tslib_1.__importDefault(require("express"));
const path_1 = require("path");
const client = tslib_1.__importStar(require("prom-client"));
const index_1 = require("../index");
const cache_1 = require("./middleware/cache");
const test_payload_loader_1 = require("./config/test-payload-loader");
const errors_1 = require("./errors");
const modules_1 = require("./modules");
const metrics_1 = require("./metrics");
const config_1 = require("./middleware/rate-limit/config");
const util_1 = require("./util");
const actions_1 = require("./middleware/cache-warmer/actions");
const actions_2 = require("./middleware/error-backoff/actions");
const actions_3 = require("./middleware/ws/actions");
const app = express_1.default();
const version = util_1.getEnv('npm_package_version');
const port = parseInt(util_1.getEnv('EA_PORT'));
const baseUrl = util_1.getEnv('BASE_URL');
exports.HEADER_CONTENT_TYPE = 'Content-Type';
exports.CONTENT_TYPE_APPLICATION_JSON = 'application/json';
exports.CONTENT_TYPE_TEXT_PLAIN = 'text/plain';
const initHandler = (adapterContext, execute, middleware) => async () => {
    const name = adapterContext.name || '';
    const envDefaultOverrides = adapterContext.envDefaultOverrides;
    const context = {
        name,
        envDefaultOverrides,
        cache: null,
        rateLimit: config_1.get({
            limits: adapterContext.rateLimit || { http: {}, ws: {} },
            name,
        }, adapterContext),
    };
    const cacheOptions = cache_1.defaultOptions(undefined, context);
    if (cacheOptions.enabled) {
        cacheOptions.instance = await cacheOptions.cacheBuilder(cacheOptions.cacheImplOptions);
        context.cache = cacheOptions;
    }
    if (metrics_1.METRICS_ENABLED) {
        setupMetricsServer(name);
    }
    initExpressMiddleware(app);
    const executeWithMiddleware = await index_1.withMiddleware(execute, context, middleware);
    app.post(baseUrl, (req, res) => {
        if (!req.is(exports.CONTENT_TYPE_APPLICATION_JSON)) {
            return res
                .status(errors_1.HTTP_ERROR_UNSUPPORTED_MEDIA_TYPE)
                .send(errors_1.HTTP_ERROR_UNSUPPORTED_MEDIA_TYPE_MESSAGE);
        }
        req.body.data = {
            ...(req.body.data || {}),
            ...util_1.toObjectWithNumbers(req.query),
        };
        return index_1.executeSync(req.body, executeWithMiddleware, context, (status, result) => {
            res.status(status).json(result);
        });
    });
    app.get(path_1.join(baseUrl, 'health'), async (_, res) => {
        // TODO https://app.shortcut.com/chainlinklabs/story/23810/update-redis-server-healthcheck
        // if (cacheOptions.enabled && cacheOptions.cacheImplOptions.type === 'redis') {
        //   logger.debug('Checking if redis connection initialized')
        //   const cache = context.cache.instance as redis.RedisCache
        //   if (!cache.client.connected) {
        //     res.status(500).send({ message: 'Redis not connected', version })
        //     return
        //   }
        // }
        res.status(200).send({ message: 'OK', version });
    });
    const testPayload = test_payload_loader_1.loadTestPayload();
    app.get(path_1.join(baseUrl, 'smoke'), async (_, res) => {
        if (testPayload.isDefault) {
            return res.status(200).send('OK');
        }
        const errors = [];
        for (const index in testPayload.requests) {
            try {
                await index_1.executeSync({ data: testPayload.requests[index], id: index }, executeWithMiddleware, context, (status, result) => {
                    if (status === 400)
                        errors.push(result);
                });
            }
            catch (e) {
                errors.push(e);
            }
        }
        if (errors.length > 0)
            return res.status(500).send(errors);
        return res.status(200).send('OK');
    });
    process.on('SIGINT', () => {
        context.cache?.instance?.close();
        process.exit();
    });
    return new Promise((resolve) => {
        const server = app.listen(port, () => {
            server.on('close', () => {
                index_1.storeSlice('cacheWarmer').dispatch(actions_1.warmupShutdown());
                index_1.storeSlice('errorBackoff').dispatch(actions_2.shutdown());
                index_1.storeSlice('ws').dispatch(actions_3.WSReset());
                context.cache?.instance?.close();
            });
            modules_1.logger.info(`Listening on port ${server.address().port}!`);
            resolve(server);
        });
    });
};
exports.initHandler = initHandler;
function setupMetricsServer(name) {
    const metricsApp = express_1.default();
    const metricsPort = parseInt(util_1.getEnv('METRICS_PORT'));
    const endpoint = util_1.getEnv('METRICS_USE_BASE_URL') ? path_1.join(baseUrl, 'metrics') : '/metrics';
    metrics_1.setupMetrics(name);
    metricsApp.get(endpoint, async (_, res) => {
        res.type('txt');
        res.send(await client.register.metrics());
    });
    metricsApp.listen(metricsPort, () => modules_1.logger.info(`Monitoring listening on port ${metricsPort}!`));
}
function initExpressMiddleware(app) {
    app.set('trust proxy', 1);
    app.use(express_1.default.json({ limit: '1mb' }));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2xpYi9zZXJ2ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUNBLDhEQUE2QjtBQUU3QiwrQkFBMkI7QUFDM0IsNERBQXFDO0FBQ3JDLG9DQUFrRTtBQUNsRSw4Q0FBbUQ7QUFDbkQsc0VBQThEO0FBQzlELHFDQUdpQjtBQUNqQix1Q0FBa0M7QUFDbEMsdUNBQXlEO0FBQ3pELDJEQUEwRTtBQUMxRSxpQ0FBb0Q7QUFDcEQsK0RBQWtFO0FBQ2xFLGdFQUE2RDtBQUU3RCxxREFBaUQ7QUFFakQsTUFBTSxHQUFHLEdBQUcsaUJBQU8sRUFBRSxDQUFBO0FBQ3JCLE1BQU0sT0FBTyxHQUFHLGFBQU0sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFBO0FBQzdDLE1BQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxhQUFNLENBQUMsU0FBUyxDQUFXLENBQUMsQ0FBQTtBQUNsRCxNQUFNLE9BQU8sR0FBRyxhQUFNLENBQUMsVUFBVSxDQUFXLENBQUE7QUFFL0IsUUFBQSxtQkFBbUIsR0FBRyxjQUFjLENBQUE7QUFDcEMsUUFBQSw2QkFBNkIsR0FBRyxrQkFBa0IsQ0FBQTtBQUNsRCxRQUFBLHVCQUF1QixHQUFHLFlBQVksQ0FBQTtBQUU1QyxNQUFNLFdBQVcsR0FDdEIsQ0FBQyxjQUE4QixFQUFFLE9BQWdCLEVBQUUsVUFBd0IsRUFBRSxFQUFFLENBQy9FLEtBQUssSUFBMEIsRUFBRTtJQUMvQixNQUFNLElBQUksR0FBRyxjQUFjLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQTtJQUN0QyxNQUFNLG1CQUFtQixHQUFHLGNBQWMsQ0FBQyxtQkFBbUIsQ0FBQTtJQUM5RCxNQUFNLE9BQU8sR0FBbUI7UUFDOUIsSUFBSTtRQUNKLG1CQUFtQjtRQUNuQixLQUFLLEVBQUUsSUFBSTtRQUNYLFNBQVMsRUFBRSxZQUFrQixDQUMzQjtZQUNFLE1BQU0sRUFBRSxjQUFjLENBQUMsU0FBUyxJQUFJLEVB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LEdBQUcsQ0FBQyxpQkFBTyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUE7QUFDekMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFkYXB0ZXJDb250ZXh0LCBFeGVjdXRlLCBNaWRkbGV3YXJlIH0gZnJvbSAnQGNoYWlubGluay90eXBlcydcbmltcG9ydCBleHByZXNzIGZyb20gJ2V4cHJlc3MnXG5pbXBvcnQgaHR0cCBmcm9tICdodHRwJ1xuaW1wb3J0IHsgam9pbiB9IGZyb20gJ3BhdGgnXG5pbXBvcnQgKiBhcyBjbGllbnQgZnJvbSAncHJvbS1jbGllbnQnXG5pbXBvcnQgeyBleGVjdXRlU3luYywgc3RvcmVTbGljZSwgd2l0aE1pZGRsZXdhcmUgfSBmcm9tICcuLi9pbmRleCdcbmltcG9ydCB7IGRlZmF1bHRPcHRpb25zIH0gZnJvbSAnLi9taWRkbGV3YXJlL2NhY2hlJ1xuaW1wb3J0IHsgbG9hZFRlc3RQYXlsb2FkIH0gZnJvbSAnLi9jb25maWcvdGVzdC1wYXlsb2FkLWxvYWRlcidcbmltcG9ydCB7XG4gIEhUVFBfRVJST1JfVU5TVVBQT1JURURfTUVESUFfVFlQRSxcbiAgSFRUUF9FUlJPUl9VTlNVUFBPUlRFRF9NRURJQV9UWVBFX01FU1NBR0UsXG59IGZyb20gJy4vZXJyb3JzJ1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi9tb2R1bGVzJ1xuaW1wb3J0IHsgTUVUUklDU19FTkFCTEVELCBzZXR1cE1ldHJpY3MgfSBmcm9tICcuL21ldHJpY3MnXG5pbXBvcnQgeyBnZXQgYXMgZ2V0UmF0ZUxpbWl0Q29uZmlnIH0gZnJvbSAnLi9taWRkbGV3YXJlL3JhdGUtbGltaXQvY29uZmlnJ1xuaW1wb3J0IHsgZ2V0RW52LCB0b09iamVjdFdpdGhOdW1iZXJzIH0gZnJvbSAnLi91dGlsJ1xuaW1wb3J0IHsgd2FybXVwU2h1dGRvd24gfSBmcm9tICcuL21pZGRsZXdhcmUvY2FjaGUtd2FybWVyL2FjdGlvbnMnXG5pbXBvcnQgeyBzaHV0ZG93biB9IGZyb20gJy4vbWlkZGxld2FyZS9lcnJvci1iYWNrb2ZmL2FjdGlvbnMnXG5pbXBvcnQgeyBBZGRyZXNzSW5mbyB9IGZyb20gJ25ldCdcbmltcG9ydCB7IFdTUmVzZXQgfSBmcm9tICcuL21pZGRsZXdhcmUvd3MvYWN0aW9ucydcblxuY29uc3QgYXBwID0gZXhwcmVzcygpXG5jb25zdCB2ZXJzaW9uID0gZ2V0RW52KCducG1fcGFja2FnZV92ZXJzaW9uJylcbmNvbnN0IHBvcnQgPSBwYXJzZUludChnZXRFbnYoJ0VBX1BPUlQnKSBhcyBzdHJpbmcpXG5jb25zdCBiYXNlVXJsID0gZ2V0RW52KCdCQVNFX1VSTCcpIGFzIHN0cmluZ1xuXG5leHBvcnQgY29uc3QgSEVBREVSX0NPTlRFTlRfVFlQRSA9ICdDb250ZW50LVR5cGUnXG5leHBvcnQgY29uc3QgQ09OVEVOVF9UWVBFX0FQUExJQ0FUSU9OX0pTT04gPSAnYXBwbGljYXRpb24vanNvbidcbmV4cG9ydCBjb25zdCBDT05URU5UX1RZUEVfVEVYVF9QTEFJTiA9ICd0ZXh0L3BsYWluJ1xuXG5leHBvcnQgY29uc3QgaW5pdEhhbmRsZXIgPVxuICAoYWRhcHRlckNvbnRleHQ6IEFkYXB0ZXJDb250ZXh0LCBleGVjdXRlOiBFeGVjdXRlLCBtaWRkbGV3YXJlOiBNaWRkbGV3YXJlW10pID0+XG4gIGFzeW5jICgpOiBQcm9taXNlPGh0dHAuU2VydmVyPiA9PiB7XG4gICAgY29uc3QgbmFtZSA9IGFkYXB0ZXJDb250ZXh0Lm5hbWUgfHwgJydcbiAgICBjb25zdCBlbnZEZWZhdWx0T3ZlcnJpZGVzID0gYWRhcHRlckNvbnRleHQuZW52RGVmYXVsdE92ZXJyaWRlc1xuICAgIGNvbnN0IGNvbnRleHQ6IEFkYXB0ZXJDb250ZXh0ID0ge1xuICAgICAgbmFtZSxcbiAgICAgIGVudkRlZmF1bHRPdmVycmlkZXMsXG4gICAgICBjYWNoZTogbnVsbCxcbiAgICAgIHJhdGVMaW1pdDogZ2V0UmF0ZUxpbWl0Q29uZmlnKFxuICAgICAgICB7XG4gICAgICAgICAgbGltaXRzOiBhZGFwdGVyQ29udGV4dC5yYXRlTGltaXQgfHwgeyBodHRwOiB7fSwgd3M6IHt9IH0sXG4gICAgICAgICAgbmFtZSxcbiAgICAgICAgfSxcbiAgICAgICAgYWRhcHRlckNvbnRleHQsXG4gICAgICApLFxuICAgIH1cbiAgICBjb25zdCBjYWNoZU9wdGlvbnMgPSBkZWZhdWx0T3B0aW9ucyh1bmRlZmluZWQsIGNvbnRleHQpXG4gICAgaWYgKGNhY2hlT3B0aW9ucy5lbmFibGVkKSB7XG4gICAgICBjYWNoZU9wdGlvbnMuaW5zdGFuY2UgPSBhd2FpdCBjYWNoZU9wdGlvbnMuY2FjaGVCdWlsZGVyKGNhY2hlT3B0aW9ucy5jYWNoZUltcGxPcHRpb25zKVxuICAgICAgY29udGV4dC5jYWNoZSA9IGNhY2hlT3B0aW9uc1xuICAgIH1cblxuICAgIGlmIChNRVRSSUNTX0VOQUJMRUQpIHtcbiAgICAgIHNldHVwTWV0cmljc1NlcnZlcihuYW1lKVxuICAgIH1cblxuICAgIGluaXRFeHByZXNzTWlkZGxld2FyZShhcHApXG5cbiAgICBjb25zdCBleGVjdXRlV2l0aE1pZGRsZXdhcmUgPSBhd2FpdCB3aXRoTWlkZGxld2FyZShleGVjdXRlLCBjb250ZXh0LCBtaWRkbGV3YXJlKVxuXG4gICAgYXBwLnBvc3QoYmFzZVVybCwgKHJlcSwgcmVzKSA9PiB7XG4gICAgICBpZiAoIXJlcS5pcyhDT05URU5UX1RZUEVfQVBQTElDQVRJT05fSlNPTikpIHtcbiAgICAgICAgcmV0dXJuIHJlc1xuICAgICAgICAgIC5zdGF0dXMoSFRUUF9FUlJPUl9VTlNVUFBPUlRFRF9NRURJQV9UWVBFKVxuICAgICAgICAgIC5zZW5kKEhUVFBfRVJST1JfVU5TVVBQT1JURURfTUVESUFfVFlQRV9NRVNTQUdFKVxuICAgICAgfVxuICAgICAgcmVxLmJvZHkuZGF0YSA9IHtcbiAgICAgICAgLi4uKHJlcS5ib2R5LmRhdGEgfHwge30pLFxuICAgICAgICAuLi50b09iamVjdFdpdGhOdW1iZXJzKHJlcS5xdWVyeSksXG4gICAgICB9XG4gICAgICByZXR1cm4gZXhlY3V0ZVN5bmMocmVxLmJvZHksIGV4ZWN1dGVXaXRoTWlkZGxld2FyZSwgY29udGV4dCwgKHN0YXR1cywgcmVzdWx0KSA9PiB7XG4gICAgICAgIHJlcy5zdGF0dXMoc3RhdHVzKS5qc29uKHJlc3VsdClcbiAgICAgIH0pXG4gICAgfSlcblxuICAgIGFwcC5nZXQoam9pbihiYXNlVXJsLCAnaGVhbHRoJyksIGFzeW5jIChfLCByZXMpID0+IHtcbiAgICAgIC8vIFRPRE8gaHR0cHM6Ly9hcHAuc2hvcnRjdXQuY29tL2NoYWlubGlua2xhYnMvc3RvcnkvMjM4MTAvdXBkYXRlLXJlZGlzLXNlcnZlci1oZWFsdGhjaGVja1xuICAgICAgLy8gaWYgKGNhY2hlT3B0aW9ucy5lbmFibGVkICYmIGNhY2hlT3B0aW9ucy5jYWNoZUltcGxPcHRpb25zLnR5cGUgPT09ICdyZWRpcycpIHtcbiAgICAgIC8vICAgbG9nZ2VyLmRlYnVnKCdDaGVja2luZyBpZiByZWRpcyBjb25uZWN0aW9uIGluaXRpYWxpemVkJylcbiAgICAgIC8vICAgY29uc3QgY2FjaGUgPSBjb250ZXh0LmNhY2hlLmluc3RhbmNlIGFzIHJlZGlzLlJlZGlzQ2FjaGVcbiAgICAgIC8vICAgaWYgKCFjYWNoZS5jbGllbnQuY29ubmVjdGVkKSB7XG4gICAgICAvLyAgICAgcmVzLnN0YXR1cyg1MDApLnNlbmQoeyBtZXNzYWdlOiAnUmVkaXMgbm90IGNvbm5lY3RlZCcsIHZlcnNpb24gfSlcbiAgICAgIC8vICAgICByZXR1cm5cbiAgICAgIC8vICAgfVxuICAgICAgLy8gfVxuXG4gICAgICByZXMuc3RhdHVzKDIwMCkuc2VuZCh7IG1lc3NhZ2U6ICdPSycsIHZlcnNpb24gfSlcbiAgICB9KVxuXG4gICAgY29uc3QgdGVzdFBheWxvYWQgPSBsb2FkVGVzdFBheWxvYWQoKVxuICAgIGFwcC5nZXQoam9pbihiYXNlVXJsLCAnc21va2UnKSwgYXN5bmMgKF8sIHJlcykgPT4ge1xuICAgICAgaWYgKHRlc3RQYXlsb2FkLmlzRGVmYXVsdCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cygyMDApLnNlbmQoJ09LJylcbiAgICAgIH1cblxuICAgICAgY29uc3QgZXJyb3JzID0gW11cblxuICAgICAgZm9yIChjb25zdCBpbmRleCBpbiB0ZXN0UGF5bG9hZC5yZXF1ZXN0cykge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGF3YWl0IGV4ZWN1dGVTeW5jKFxuICAgICAgICAgICAgeyBkYXRhOiB0ZXN0UGF5bG9hZC5yZXF1ZXN0c1tpbmRleF0sIGlkOiBpbmRleCB9LFxuICAgICAgICAgICAgZXhlY3V0ZVdpdGhNaWRkbGV3YXJlLFxuICAgICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICAgIChzdGF0dXMsIHJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgICBpZiAoc3RhdHVzID09PSA0MDApIGVycm9ycy5wdXNoKHJlc3VsdClcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgKVxuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgZXJyb3JzLnB1c2goZSlcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKGVycm9ycy5sZW5ndGggPiAwKSByZXR1cm4gcmVzLnN0YXR1cyg1MDApLnNlbmQoZXJyb3JzKVxuXG4gICAgICByZXR1cm4gcmVzLnN0YXR1cygyMDApLnNlbmQoJ09LJylcbiAgICB9KVxuXG4gICAgcHJvY2Vzcy5vbignU0lHSU5UJywgKCkgPT4ge1xuICAgICAgY29udGV4dC5jYWNoZT8uaW5zdGFuY2U/LmNsb3NlKClcbiAgICAgIHByb2Nlc3MuZXhpdCgpXG4gICAgfSlcblxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgY29uc3Qgc2VydmVyID0gYXBwLmxpc3Rlbihwb3J0LCAoKSA9PiB7XG4gICAgICAgIHNlcnZlci5vbignY2xvc2UnLCAoKSA9PiB7XG4gICAgICAgICAgc3RvcmVTbGljZSgnY2FjaGVXYXJtZXInKS5kaXNwYXRjaCh3YXJtdXBTaHV0ZG93bigpKVxuICAgICAgICAgIHN0b3JlU2xpY2UoJ2Vycm9yQmFja29mZicpLmRpc3BhdGNoKHNodXRkb3duKCkpXG4gICAgICAgICAgc3RvcmVTbGljZSgnd3MnKS5kaXNwYXRjaChXU1Jlc2V0KCkpXG4gICAgICAgICAgY29udGV4dC5jYWNoZT8uaW5zdGFuY2U/LmNsb3NlKClcbiAgICAgICAgfSlcblxuICAgICAgICBsb2dnZXIuaW5mbyhgTGlzdGVuaW5nIG9uIHBvcnQgJHsoc2VydmVyLmFkZHJlc3MoKSBhcyBBZGRyZXNzSW5mbykucG9ydH0hYClcbiAgICAgICAgcmVzb2x2ZShzZXJ2ZXIpXG4gICAgICB9KVxuICAgIH0pXG4gIH1cblxuZnVuY3Rpb24gc2V0dXBNZXRyaWNzU2VydmVyKG5hbWU6IHN0cmluZykge1xuICBjb25zdCBtZXRyaWNzQXBwID0gZXhwcmVzcygpXG4gIGNvbnN0IG1ldHJpY3NQb3J0ID0gcGFyc2VJbnQoZ2V0RW52KCdNRVRSSUNTX1BPUlQnKSBhcyBzdHJpbmcpXG4gIGNvbnN0IGVuZHBvaW50ID0gZ2V0RW52KCdNRVRSSUNTX1VTRV9CQVNFX1VSTCcpID8gam9pbihiYXNlVXJsLCAnbWV0cmljcycpIDogJy9tZXRyaWNzJ1xuXG4gIHNldHVwTWV0cmljcyhuYW1lKVxuXG4gIG1ldHJpY3NBcHAuZ2V0KGVuZHBvaW50LCBhc3luYyAoXywgcmVzKSA9PiB7XG4gICAgcmVzLnR5cGUoJ3R4dCcpXG4gICAgcmVzLnNlbmQoYXdhaXQgY2xpZW50LnJlZ2lzdGVyLm1ldHJpY3MoKSlcbiAgfSlcblxuICBtZXRyaWNzQXBwLmxpc3RlbihtZXRyaWNzUG9ydCwgKCkgPT4gbG9nZ2VyLmluZm8oYE1vbml0b3JpbmcgbGlzdGVuaW5nIG9uIHBvcnQgJHttZXRyaWNzUG9ydH0hYCkpXG59XG5cbmZ1bmN0aW9uIGluaXRFeHByZXNzTWlkZGxld2FyZShhcHA6IGV4cHJlc3MuRXhwcmVzcykge1xuICBhcHAuc2V0KCd0cnVzdCBwcm94eScsIDEpXG4gIGFwcC51c2UoZXhwcmVzcy5qc29uKHsgbGltaXQ6ICcxbWInIH0pKVxufVxuIl19