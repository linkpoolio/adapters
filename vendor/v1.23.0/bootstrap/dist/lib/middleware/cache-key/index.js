"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getBatchChildKeys = exports.getCacheKey = exports.withCacheKey = void 0;
const tslib_1 = require("tslib");
const modules_1 = require("../../modules");
const util_1 = require("./util");
const crypto_1 = tslib_1.__importDefault(require("crypto"));
const selector_1 = require("../../modules/selector");
const util_2 = require("../../util");
const object_hash_1 = tslib_1.__importDefault(require("object-hash"));
const utils_1 = require("../ws/utils");
const baseInputParametersCachable = Object.keys(selector_1.baseInputParameters).filter((inputParam) => !util_1.excludableInternalAdapterRequestProperties.includes(inputParam));
const withCacheKey = (endpointSelector) => async (execute, context) => async (input) => {
    const endpoint = endpointSelector?.(input);
    if (!(endpoint && endpoint.inputParameters)) {
        // Fallback to legacy object hash cache key
        const cacheKey = util_1.hash(input, util_1.getHashOpts());
        const inputWithCacheKey = { ...input, debug: { ...input.debug, cacheKey } };
        return execute(inputWithCacheKey, context);
    }
    const inputParameterKeys = Object.keys(endpoint.inputParameters ?? {}).concat(baseInputParametersCachable);
    const validator = new modules_1.Validator(input, endpoint.inputParameters, {}, { shouldThrowError: false });
    const cacheKey = getCacheKey(validator.validated, inputParameterKeys);
    const batchCacheKey = endpoint.batchablePropertyPath
        ? getCacheKey(validator.validated, inputParameterKeys, endpoint.batchablePropertyPath)
        : undefined;
    const batchChildrenCacheKeys = batchCacheKey ? getBatchChildKeys(input, endpoint) : undefined;
    const inputWithCacheKey = {
        ...input,
        debug: { ...input.debug, cacheKey, batchCacheKey, batchChildrenCacheKeys },
    };
    return execute(inputWithCacheKey, context);
};
exports.withCacheKey = withCacheKey;
function getCacheKey(validatedData, inputParameterKeys, batchablePropertyPath) {
    let data = '';
    const inputParameterKeySet = new Set([...selector_1.baseInputParameterKeys, ...inputParameterKeys]);
    for (const key of inputParameterKeySet) {
        // We want the key to be consistent. So we omit batchable paths.
        // Otherwise it would change on every new child
        if (batchablePropertyPath && batchablePropertyPath.some(({ name }) => key === name))
            continue;
        const value = validatedData.data[key];
        if (!value)
            continue;
        const valueString = util_2.isObject(value) ? object_hash_1.default(value) : JSON.stringify(value);
        data += valueString;
    }
    const shasum = crypto_1.default.createHash('sha1');
    shasum.update(data);
    return shasum.digest('base64');
}
exports.getCacheKey = getCacheKey;
function getBatchChildKeys(input, endpoint) {
    const children = [];
    utils_1.separateBatches(input, async (data) => {
        children.push(data);
    });
    return children.map((child) => {
        const inputParameterKeys = Object.keys(endpoint.inputParameters ?? {}).concat(baseInputParametersCachable);
        const validator = new modules_1.Validator(child, endpoint.inputParameters, {}, { shouldThrowError: false });
        return [getCacheKey(validator.validated, inputParameterKeys), child];
    });
}
exports.getBatchChildKeys = getBatchChildKeys;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbGliL21pZGRsZXdhcmUvY2FjaGUta2V5L2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFDQSwyQ0FBeUM7QUFDekMsaUNBQXNGO0FBQ3RGLDREQUEyQjtBQUMzQixxREFBb0Y7QUFDcEYscUNBQXFDO0FBQ3JDLHNFQUFvQztBQUVwQyx1Q0FBNkM7QUFFN0MsTUFBTSwyQkFBMkIsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLDhCQUFtQixDQUFDLENBQUMsTUFBTSxDQUN6RSxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQUMsQ0FBQyxpREFBMEMsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQ2pGLENBQUE7QUFFTSxNQUFNLFlBQVksR0FFUCxDQUFDLGdCQUFnQixFQUFFLEVBQUUsQ0FBQyxLQUFLLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxFQUFFLENBQUMsS0FBSyxFQUFFLEtBQXFCLEVBQUUsRUFBRTtJQUNsRyxNQUFNLFFBQVEsR0FBRyxnQkFBZ0IsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFBO0lBRTFDLElBQUksQ0FBQyxDQUFDLFFBQVEsSUFBSSxRQUFRLENBQUMsZUFBZSxDQUFDLEVBQUU7UUFDM0MsMkNBQTJDO1FBQzNDLE1BQU0sUUFBUSxHQUFHLFdBQUksQ0FBQyxLQUFLLEVBQUUsa0JBQVcsRUFBRSxDQUFDLENBQUE7UUFDM0MsTUFBTSxpQkFBaUIsR0FBRyxFQUFFLEdBQUcsS0FBSyxFQUFFLEtBQUssRUFBRSxFQUFFLEdBQUcsS0FBSyxDQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsRUFBRSxDQUFBO1FBQzNFLE9BQU8sT0FBTyxDQUFDLGlCQUFpQixFQUFFLE9BQU8sQ0FBQyxDQUFBO0tBQzNDO0lBRUQsTUFBTSxrQkFBa0IsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxlQUFlLElBQUksRUFBRSxDQUFDLENB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QUFTLENBQzdCLEtBQUssRUFDTCxRQUFRLENBQUMsZUFBZSxFQUN4QixFQUFFLEVBQ0YsRUFBRSxnQkFBZ0IsRUFBRSxLQUFLLEVBQUUsQ0FDNUIsQ0FBQTtRQUNELE9BQU8sQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLFNBQVMsRUFBRSxrQkFBa0IsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFBO0lBQ3RFLENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQztBQXJCRCw4Q0FxQkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IE1pZGRsZXdhcmUsIEFkYXB0ZXJSZXF1ZXN0LCBDb25maWcsIEFQSUVuZHBvaW50IH0gZnJvbSAnQGNoYWlubGluay90eXBlcydcbmltcG9ydCB7IFZhbGlkYXRvciB9IGZyb20gJy4uLy4uL21vZHVsZXMnXG5pbXBvcnQgeyBnZXRIYXNoT3B0cywgaGFzaCwgZXhjbHVkYWJsZUludGVybmFsQWRhcHRlclJlcXVlc3RQcm9wZXJ0aWVzIH0gZnJvbSAnLi91dGlsJ1xuaW1wb3J0IGNyeXB0byBmcm9tICdjcnlwdG8nXG5pbXBvcnQgeyBiYXNlSW5wdXRQYXJhbWV0ZXJLZXlzLCBiYXNlSW5wdXRQYXJhbWV0ZXJzIH0gZnJvbSAnLi4vLi4vbW9kdWxlcy9zZWxlY3RvcidcbmltcG9ydCB7IGlzT2JqZWN0IH0gZnJvbSAnLi4vLi4vdXRpbCdcbmltcG9ydCBvYmplY3RIYXNoIGZyb20gJ29iamVjdC1oYXNoJ1xuaW1wb3J0IHsgQmF0Y2hhYmxlUHJvcGVydHkgfSBmcm9tICcuLi9jYWNoZS13YXJtZXIvcmVkdWNlcidcbmltcG9ydCB7IHNlcGFyYXRlQmF0Y2hlcyB9IGZyb20gJy4uL3dzL3V0aWxzJ1xuXG5jb25zdCBiYXNlSW5wdXRQYXJhbWV0ZXJzQ2FjaGFibGUgPSBPYmplY3Qua2V5cyhiYXNlSW5wdXRQYXJhbWV0ZXJzKS5maWx0ZXIoXG4gIChpbnB1dFBhcmFtKSA9PiAhZXhjbHVkYWJsZUludGVybmFsQWRhcHRlclJlcXVlc3RQcm9wZXJ0aWVzLmluY2x1ZGVzKGlucHV0UGFyYW0pLFxuKVxuXG5leHBvcnQgY29uc3Qgd2l0aENhY2hlS2V5OiA8QyBleHRlbmRzIENvbmZpZz4oXG4gIGVuZHBvaW50U2VsZWN0b3I/OiAocmVxdWVzdDogQWRhcHRlclJlcXVlc3QpID0+IEFQSUVuZHBvaW50PEM+LFxuKSA9PiBNaWRkbGV3YXJlID0gKGVuZHBvaW50U2VsZWN0b3IpID0+IGFzeW5jIChleGVjdXRlLCBjb250ZXh0KSA9PiBhc3luYyAoaW5wdXQ6IEFkYXB0ZXJSZXF1ZXN0KSA9PiB7XG4gIGNvbnN0IGVuZHBvaW50ID0gZW5kcG9pbnRTZWxlY3Rvcj8uKGlucHV0KVxuXG4gIGlmICghKGVuZHBvaW50ICYmIGVuZHBvaW50LmlucHV0UGFyYW1ldGVycykpIHtcbiAgICAvLyBGYWxsYmFjayB0byBsZWdhY3kgb2JqZWN0IGhhc2ggY2FjaGUga2V5XG4gICAgY29uc3QgY2FjaGVLZXkgPSBoYXNoKGlucHV0LCBnZXRIYXNoT3B0cygpKVxuICAgIGNvbnN0IGlucHV0V2l0aENhY2hlS2V5ID0geyAuLi5pbnB1dCwgZGVidWc6IHsgLi4uaW5wdXQuZGVidWcsIGNhY2hlS2V5IH0gfVxuICAgIHJldHVybiBleGVjdXRlKGlucHV0V2l0aENhY2hlS2V5LCBjb250ZXh0KVxuICB9XG5cbiAgY29uc3QgaW5wdXRQYXJhbWV0ZXJLZXlzID0gT2JqZWN0LmtleXMoZW5kcG9pbnQuaW5wdXRQYXJhbWV0ZXJzID8/IHt9KS5jb25jYXQoXG4gICAgYmFzZUlucHV0UGFyYW1ldGVyc0NhY2hhYmxlLFxuICApXG4gIGNvbnN0IHZhbGlkYXRvciA9IG5ldyBWYWxpZGF0b3IoaW5wdXQsIGVuZHBvaW50LmlucHV0UGFyYW1ldGVycywge30sIHsgc2hvdWxkVGhyb3dFcnJvcjogZmFsc2UgfSlcblxuICBjb25zdCBjYWNoZUtleSA9IGdldENhY2hlS2V5KHZhbGlkYXRvci52YWxpZGF0ZWQsIGlucHV0UGFyYW1ldGVyS2V5cylcblxuICBjb25zdCBiYXRjaENhY2hlS2V5ID0gZW5kcG9pbnQuYmF0Y2hhYmxlUHJvcGVydHlQYXRoXG4gICAgPyBnZXRDYWNoZUtleSh2YWxpZGF0b3IudmFsaWRhdGVkLCBpbnB1dFBhcmFtZXRlcktleXMsIGVuZHBvaW50LmJhdGNoYWJsZVByb3BlcnR5UGF0aClcbiAgICA6IHVuZGVmaW5lZFxuXG4gIGNvbnN0IGJhdGNoQ2hpbGRyZW5DYWNoZUtleXMgPSBiYXRjaENhY2hlS2V5ID8gZ2V0QmF0Y2hDaGlsZEtleXMoaW5wdXQsIGVuZHBvaW50KSA6IHVuZGVmaW5lZFxuXG4gIGNvbnN0IGlucHV0V2l0aENhY2hlS2V5ID0ge1xuICAgIC4uLmlucHV0LFxuICAgIGRlYnVnOiB7IC4uLmlucHV0LmRlYnVnLCBjYWNoZUtleSwgYmF0Y2hDYWNoZUtleSwgYmF0Y2hDaGlsZHJlbkNhY2hlS2V5cyB9LFxuICB9XG4gIHJldHVybiBleGVjdXRlKGlucHV0V2l0aENhY2hlS2V5LCBjb250ZXh0KVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q2FjaGVLZXkoXG4gIHZhbGlkYXRlZERhdGE6IFZhbGlkYXRvclsndmFsaWRhdGVkJ10sXG4gIGlucHV0UGFyYW1ldGVyS2V5czogc3RyaW5nW10sXG4gIGJhdGNoYWJsZVByb3BlcnR5UGF0aD86IEJhdGNoYWJsZVByb3BlcnR5W10sXG4pOiBzdHJpbmcge1xuICBsZXQgZGF0YSA9ICcnXG5cbiAgY29uc3QgaW5wdXRQYXJhbWV0ZXJLZXlTZXQgPSBuZXcgU2V0KFsuLi5iYXNlSW5wdXRQYXJhbWV0ZXJLZXlzLCAuLi5pbnB1dFBhcmFtZXRlcktleXNdKVxuXG4gIGZvciAoY29uc3Qga2V5IG9mIGlucHV0UGFyYW1ldGVyS2V5U2V0KSB7XG4gICAgLy8gV2Ugd2FudCB0aGUga2V5IHRvIGJlIGNvbnNpc3RlbnQuIFNvIHdlIG9taXQgYmF0Y2hhYmxlIHBhdGhzLlxuICAgIC8vIE90aGVyd2lzZSBpdCB3b3VsZCBjaGFuZ2Ugb24gZXZlcnkgbmV3IGNoaWxkXG4gICAgaWYgKGJhdGNoYWJsZVByb3BlcnR5UGF0aCAmJiBiYXRjaGFibGVQcm9wZXJ0eVBhdGguc29tZSgoeyBuYW1lIH0pID0+IGtleSA9PT0gbmFtZSkpIGNvbnRpbnVlXG5cbiAgICBjb25zdCB2YWx1ZSA9IHZhbGlkYXRlZERhdGEuZGF0YVtrZXldXG4gICAgaWYgKCF2YWx1ZSkgY29udGludWVcbiAgICBjb25zdCB2YWx1ZVN0cmluZyA9IGlzT2JqZWN0KHZhbHVlKSA/IG9iamVjdEhhc2godmFsdWUpIDogSlNPTi5zdHJpbmdpZnkodmFsdWUpXG4gICAgZGF0YSArPSB2YWx1ZVN0cmluZ1xuICB9XG5cbiAgY29uc3Qgc2hhc3VtID0gY3J5cHRvLmNyZWF0ZUhhc2goJ3NoYTEnKVxuICBzaGFzdW0udXBkYXRlKGRhdGEpXG4gIHJldHVybiBzaGFzdW0uZGlnZXN0KCdiYXNlNjQnKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0QmF0Y2hDaGlsZEtleXM8QyBleHRlbmRzIENvbmZpZz4oXG4gIGlucHV0OiBBZGFwdGVyUmVxdWVzdCxcbiAgZW5kcG9pbnQ6IEFQSUVuZHBvaW50PEM+LFxuKTogW3N0cmluZywgQWRhcHRlclJlcXVlc3RdW10ge1xuICBjb25zdCBjaGlsZHJlbjogQWRhcHRlclJlcXVlc3RbXSA9IFtdXG4gIHNlcGFyYXRlQmF0Y2hlcyhpbnB1dCwgYXN5bmMgKGRhdGEpID0+IHtcbiAgICBjaGlsZHJlbi5wdXNoKGRhdGEpXG4gIH0pXG5cbiAgcmV0dXJuIGNoaWxkcmVuLm1hcCgoY2hpbGQpID0+IHtcbiAgICBjb25zdCBpbnB1dFBhcmFtZXRlcktleXMgPSBPYmplY3Qua2V5cyhlbmRwb2ludC5pbnB1dFBhcmFtZXRlcnMgPz8ge30pLmNvbmNhdChcbiAgICAgIGJhc2VJbnB1dFBhcmFtZXRlcnNDYWNoYWJsZSxcbiAgICApXG4gICAgY29uc3QgdmFsaWRhdG9yID0gbmV3IFZhbGlkYXRvcihcbiAgICAgIGNoaWxkLFxuICAgICAgZW5kcG9pbnQuaW5wdXRQYXJhbWV0ZXJzLFxuICAgICAge30sXG4gICAgICB7IHNob3VsZFRocm93RXJyb3I6IGZhbHNlIH0sXG4gICAgKVxuICAgIHJldHVybiBbZ2V0Q2FjaGVLZXkodmFsaWRhdG9yLnZhbGlkYXRlZCwgaW5wdXRQYXJhbWV0ZXJLZXlzKSwgY2hpbGRdXG4gIH0pXG59XG4iXX0=