"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.rootReducer = exports.subscriptionsReducer = exports.connectionsReducer = exports.getSubsId = void 0;
const tslib_1 = require("tslib");
const toolkit_1 = require("@reduxjs/toolkit");
const modules_1 = require("../../modules");
const util_1 = require("../../middleware/cache-key/util");
const actions = tslib_1.__importStar(require("./actions"));
/**
 * Generate a key for the WS middleware
 *
 * NOTE:
 * Exclude mode is enforced because the data given to the WS framework
 * is not an Adapter Request, but a subscription message.
 *
 * (e.g. Cryptocompare)
 * { action: 'SubAdd', subs: [ '5~CCCAGG~BTC~USD' ] }
 *
 * The structure of which may change with every adapter, so we need to
 * use exclude mode to handle dynamically changing properties.
 */
const getSubsId = (subscriptionMsg) => util_1.hash(subscriptionMsg, util_1.getHashOpts(), 'exclude');
exports.getSubsId = getSubsId;
const initConnectionsState = { total: 0, all: {} };
exports.connectionsReducer = toolkit_1.createReducer(initConnectionsState, (builder) => {
    builder.addCase(actions.onConnectComplete, (state, action) => {
        const { connectionInfo: { key }, } = action.payload;
        state.all[key] = {
            ...state.all[key],
            isOnConnectChainComplete: true,
        };
    });
    builder.addCase(actions.connectFulfilled, (state, action) => {
        // Add connection
        const { key } = action.payload.config.connectionInfo;
        state.all[key] = {
            ...state.all[key],
            active: true,
            connecting: 0,
            wasEverConnected: true,
            requestId: Math.max(state.all[key].requestId, 0),
        };
    });
    builder.addCase(actions.subscribeRequested, (state, action) => {
        if (!action.payload.connectionInfo) {
            modules_1.logger.error(`Missing connection info: ${JSON.stringify(action.payload)}`);
            return;
        }
        const key = action.payload.connectionInfo.key;
        if (!state.all[key])
            return;
        state.all[key] = {
            ...state.all[key],
            requestId: state.all[key].requestId + 1,
            connectionParams: action.payload.messageToSave || state.all[key].connectionParams,
        };
    });
    builder.addCase(actions.connectRequested, (state, action) => {
        const { key } = action.payload.config.connectionInfo;
        const connectionState = state.all[key];
        const isActive = connectionState?.active;
        if (isActive)
            return;
        const wsHandler = action.payload.wsHandler;
        const hasNoOnConnectChain = !wsHandler.onConnectChain;
        const isConnecting = !isNaN(Number(connectionState?.connecting));
        state.all[key] = {
            ...connectionState,
            active: false,
            connecting: isConnecting ? connectionState.connecting + 1 : 1,
            requestId: isConnecting ? connectionState.requestId : 0,
            isOnConnectChainComplete: hasNoOnConnectChain,
        };
    });
    builder.addCase(actions.connectFailed, (state, action) => {
        state.all[action.payload.connectionInfo.key].connecting = 0;
        state.all[action.payload.connectionInfo.key].active = false;
    });
    builder.addCase(actions.disconnectFulfilled, (state, action) => {
        // Remove connection
        const { key } = action.payload.config.connectionInfo;
        state.all[key].active = false;
        state.all[key].connecting = 0; // turn off connecting
        state.all[key].requestId = 0;
    });
    builder.addCase(actions.subscriptionErrorHandler, (state, action) => {
        const { key } = action.payload.connectionInfo;
        state.all[key].shouldNotRetryConnecting = action.payload.shouldNotRetryConnection;
    });
    builder.addCase(actions.WSReset, () => initConnectionsState);
    builder.addMatcher(toolkit_1.isAnyOf(actions.connectRequested, actions.connectFulfilled, actions.connectFailed, actions.disconnectFulfilled), (state) => {
        state.total = Object.values(state.all).filter((s) => s?.active).length;
    });
});
const initSubscriptionsState = { total: 0, all: {} };
exports.subscriptionsReducer = toolkit_1.createReducer(initSubscriptionsState, (builder) => {
    builder.addCase(actions.updateSubscriptionInput, (state, action) => {
        const key = action.payload.subscriptionKey;
        state.all[key] = {
            ...state.all[key],
            input: action.payload.input,
        };
    });
    builder.addCase(actions.saveFirstMessageReceived, (state, action) => {
        const key = action.payload.subscriptionKey;
        state.all[key] = {
            ...state.all[key],
            subscriptionParams: action.payload.message,
        };
    });
    builder.addCase(actions.subscribeFulfilled, (state, action) => {
        // Add subscription
        const key = exports.getSubsId(action.payload.subscriptionMsg);
        state.all[key] = {
            active: true,
            wasEverActive: true,
            unsubscribed: false,
            subscribing: 0,
            input: { ...action.payload.input },
            context: action.payload.context,
            connectionKey: action.payload.connectionInfo.key,
        };
    });
    builder.addCase(actions.subscribeRequested, (state, action) => {
        const key = exports.getSubsId(action.payload.subscriptionMsg);
        const isActive = state.all[key]?.active;
        if (isActive)
            return;
        if (!action.payload.connectionInfo) {
            modules_1.logger.error(`Missing connection info: ${JSON.stringify(action.payload)}`);
            return;
        }
        const isSubscribing = state.all[key]?.subscribing;
        state.all[key] = {
            active: false,
            subscribing: isSubscribing ? state.all[key].subscribing + 1 : 1,
            input: { ...action.payload.input },
            context: action.payload.context,
            connectionKey: action.payload.connectionInfo.key,
        };
    });
    builder.addCase(actions.unsubscribeFulfilled, (state, action) => {
        // Remove subscription
        const key = exports.getSubsId(action.payload.subscriptionMsg);
        state.all[key].active = false;
        state.all[key].unsubscribed = true;
        state.all[key].subscribing = 0;
    });
    builder.addCase(actions.subscriptionErrorHandler, (state, action) => {
        const key = exports.getSubsId(action.payload.subscriptionMsg);
        if (state.all[key]) {
            state.all[key].shouldNotRetry = action.payload.shouldNotRetrySubscription;
        }
    });
    builder.addCase(actions.disconnectFulfilled, (state) => {
        state.all = {};
        return state;
    });
    builder.addCase(actions.messageReceived, (state, action) => {
        const key = action.payload.subscriptionKey;
        state.all[key].lastUpdatedAt = action.payload.timestamp;
    });
    builder.addCase(actions.WSReset, () => initSubscriptionsState);
    builder.addMatcher(toolkit_1.isAnyOf(actions.subscribeRequested, actions.subscribeFulfilled, actions.unsubscribeFulfilled), (state) => {
        state.total = Object.values(state.all).filter((s) => s?.active).length;
    });
});
exports.rootReducer = toolkit_1.combineReducers({
    connections: exports.connectionsReducer,
    subscriptions: exports.subscriptionsReducer,
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVkdWNlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9saWIvbWlkZGxld2FyZS93cy9yZWR1Y2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFDQSw4Q0FBMEU7QUFDMUUsMkNBQXNDO0FBQ3RDLDBEQUFtRTtBQUNuRSwyREFBb0M7QUFFcEM7Ozs7Ozs7Ozs7OztHQVlHO0FBQ0ksTUFBTSxTQUFTLEdBQUcsQ0FBQyxlQUErQixFQUFVLEVBQUUsQ0FDbkUsV0FBSSxDQUFDLGVBQWUsRUFBRSxrQkFBVyxFQUFFLEVBQUUsU0FBUyxDQUFDLENBQUE7QUFEcEMsUUFBQSxTQUFTLGFBQzJCO0FBbUJqRCxNQUFNLG9CQUFvQixHQUFxQixFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLEVBQUUsRUFBRSxDQUFBO0FBRXZELFFBQUEsa0JBQWtCLEdBQUcsdUJBQWEsQ0FDN0Msb0JBQW9CLEVBQ3BCLENBQUMsT0FBTyxFQUFFLEVBQUU7SUFDVixPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsRUFBRTtRQUMzRCxNQUFNLEVBQ0osY0FBYyxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQ3hCLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQTtRQUNsQixLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHO1lBQ2YsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQztZQUNqQix3QkFBd0IsRUFBRSxJQUFJO1NBQy9CLENBQUE7SUFDSCxDQUFDLENBQUMsQ0FBQTtJQUNGLE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLGdCQUFnQixFQUFFLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxFQUFFO1FBQzFELGlCQUFpQjtRQUNqQixNQUFNLEVBQUUsR0FBRyxFQUFFLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFN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QUFDLENBQ0YsQ0FBQTtBQUVZLFFBQUEsV0FBVyxHQUFHLHlCQUFlLENBQUM7SUFDekMsV0FBVyxFQUFFLDBCQUFrQjtJQUMvQixhQUFhLEVBQUUsNEJBQW9CO0NBQ3BDLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFkYXB0ZXJDb250ZXh0LCBBZGFwdGVyUmVxdWVzdCB9IGZyb20gJ0BjaGFpbmxpbmsvdHlwZXMnXG5pbXBvcnQgeyBjb21iaW5lUmVkdWNlcnMsIGNyZWF0ZVJlZHVjZXIsIGlzQW55T2YgfSBmcm9tICdAcmVkdXhqcy90b29sa2l0J1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vLi4vbW9kdWxlcydcbmltcG9ydCB7IGdldEhhc2hPcHRzLCBoYXNoIH0gZnJvbSAnLi4vLi4vbWlkZGxld2FyZS9jYWNoZS1rZXkvdXRpbCdcbmltcG9ydCAqIGFzIGFjdGlvbnMgZnJvbSAnLi9hY3Rpb25zJ1xuXG4vKipcbiAqIEdlbmVyYXRlIGEga2V5IGZvciB0aGUgV1MgbWlkZGxld2FyZVxuICpcbiAqIE5PVEU6XG4gKiBFeGNsdWRlIG1vZGUgaXMgZW5mb3JjZWQgYmVjYXVzZSB0aGUgZGF0YSBnaXZlbiB0byB0aGUgV1MgZnJhbWV3b3JrXG4gKiBpcyBub3QgYW4gQWRhcHRlciBSZXF1ZXN0LCBidXQgYSBzdWJzY3JpcHRpb24gbWVzc2FnZS5cbiAqXG4gKiAoZS5nLiBDcnlwdG9jb21wYXJlKVxuICogeyBhY3Rpb246ICdTdWJBZGQnLCBzdWJzOiBbICc1fkNDQ0FHR35CVEN+VVNEJyBdIH1cbiAqXG4gKiBUaGUgc3RydWN0dXJlIG9mIHdoaWNoIG1heSBjaGFuZ2Ugd2l0aCBldmVyeSBhZGFwdGVyLCBzbyB3ZSBuZWVkIHRvXG4gKiB1c2UgZXhjbHVkZSBtb2RlIHRvIGhhbmRsZSBkeW5hbWljYWxseSBjaGFuZ2luZyBwcm9wZXJ0aWVzLlxuICovXG5leHBvcnQgY29uc3QgZ2V0U3Vic0lkID0gKHN1YnNjcmlwdGlvbk1zZzogQWRhcHRlclJlcXVlc3QpOiBzdHJpbmcgPT5cbiAgaGFzaChzdWJzY3JpcHRpb25Nc2csIGdldEhhc2hPcHRzKCksICdleGNsdWRlJylcblxuZXhwb3J0IGludGVyZmFjZSBDb25uZWN0aW9uc1N0YXRlIHtcbiAgdG90YWw6IG51bWJlclxuICBhbGw6IHtcbiAgICBba2V5OiBzdHJpbmddOiB7XG4gICAgICBzaG91bGROb3RSZXRyeUNvbm5lY3Rpbmc/OiBib29sZWFuXG4gICAgICBhY3RpdmU6IGJvb2xlYW5cbiAgICAgIGNvbm5lY3Rpbmc6IG51bWJlclxuICAgICAgd2FzRXZlckNvbm5lY3RlZD86IGJvb2xlYW5cbiAgICAgIGNvbm5lY3Rpb25QYXJhbXM/OiB7XG4gICAgICAgIFtUOiBzdHJpbmddOiBzdHJpbmdcbiAgICAgIH1cbiAgICAgIHJlcXVlc3RJZDogbnVtYmVyXG4gICAgICBpc09uQ29ubmVjdENoYWluQ29tcGxldGU6IGJvb2xlYW5cbiAgICB9XG4gIH1cbn1cblxuY29uc3QgaW5pdENvbm5lY3Rpb25zU3RhdGU6IENvbm5lY3Rpb25zU3RhdGUgPSB7IHRvdGFsOiAwLCBhbGw6IHt9IH1cblxuZXhwb3J0IGNvbnN0IGNvbm5lY3Rpb25zUmVkdWNlciA9IGNyZWF0ZVJlZHVjZXI8Q29ubmVjdGlvbnNTdGF0ZT4oXG4gIGluaXRDb25uZWN0aW9uc1N0YXRlLFxuICAoYnVpbGRlcikgPT4ge1xuICAgIGJ1aWxkZXIuYWRkQ2FzZShhY3Rpb25zLm9uQ29ubmVjdENvbXBsZXRlLCAoc3RhdGUsIGFjdGlvbikgPT4ge1xuICAgICAgY29uc3Qge1xuICAgICAgICBjb25uZWN0aW9uSW5mbzogeyBrZXkgfSxcbiAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZFxuICAgICAgc3RhdGUuYWxsW2tleV0gPSB7XG4gICAgICAgIC4uLnN0YXRlLmFsbFtrZXldLFxuICAgICAgICBpc09uQ29ubmVjdENoYWluQ29tcGxldGU6IHRydWUsXG4gICAgICB9XG4gICAgfSlcbiAgICBidWlsZGVyLmFkZENhc2UoYWN0aW9ucy5jb25uZWN0RnVsZmlsbGVkLCAoc3RhdGUsIGFjdGlvbikgPT4ge1xuICAgICAgLy8gQWRkIGNvbm5lY3Rpb25cbiAgICAgIGNvbnN0IHsga2V5IH0gPSBhY3Rpb24ucGF5bG9hZC5jb25maWcuY29ubmVjdGlvbkluZm9cbiAgICAgIHN0YXRlLmFsbFtrZXldID0ge1xuICAgICAgICAuLi5zdGF0ZS5hbGxba2V5XSxcbiAgICAgICAgYWN0aXZlOiB0cnVlLFxuICAgICAgICBjb25uZWN0aW5nOiAwLFxuICAgICAgICB3YXNFdmVyQ29ubmVjdGVkOiB0cnVlLFxuICAgICAgICByZXF1ZXN0SWQ6IE1hdGgubWF4KHN0YXRlLmFsbFtrZXldLnJlcXVlc3RJZCwgMCksXG4gICAgICB9XG4gICAgfSlcbiAgICBidWlsZGVyLmFkZENhc2UoYWN0aW9ucy5zdWJzY3JpYmVSZXF1ZXN0ZWQsIChzdGF0ZSwgYWN0aW9uKSA9PiB7XG4gICAgICBpZiAoIWFjdGlvbi5wYXlsb2FkLmNvbm5lY3Rpb25JbmZvKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvcihgTWlzc2luZyBjb25uZWN0aW9uIGluZm86ICR7SlNPTi5zdHJpbmdpZnkoYWN0aW9uLnBheWxvYWQpfWApXG4gICAgICAgIHJldHVyblxuICAgICAgfVxuICAgICAgY29uc3Qga2V5ID0gYWN0aW9uLnBheWxvYWQuY29ubmVjdGlvbkluZm8ua2V5XG4gICAgICBpZiAoIXN0YXRlLmFsbFtrZXldKSByZXR1cm5cbiAgICAgIHN0YXRlLmFsbFtrZXldID0ge1xuICAgICAgICAuLi5zdGF0ZS5hbGxba2V5XSxcbiAgICAgICAgcmVxdWVzdElkOiBzdGF0ZS5hbGxba2V5XS5yZXF1ZXN0SWQgKyAxLFxuICAgICAgICBjb25uZWN0aW9uUGFyYW1zOiBhY3Rpb24ucGF5bG9hZC5tZXNzYWdlVG9TYXZlIHx8IHN0YXRlLmFsbFtrZXldLmNvbm5lY3Rpb25QYXJhbXMsXG4gICAgICB9XG4gICAgfSlcbiAgICBidWlsZGVyLmFkZENhc2UoYWN0aW9ucy5jb25uZWN0UmVxdWVzdGVkLCAoc3RhdGUsIGFjdGlvbikgPT4ge1xuICAgICAgY29uc3QgeyBrZXkgfSA9IGFjdGlvbi5wYXlsb2FkLmNvbmZpZy5jb25uZWN0aW9uSW5mb1xuICAgICAgY29uc3QgY29ubmVjdGlvblN0YXRlID0gc3RhdGUuYWxsW2tleV1cbiAgICAgIGNvbnN0IGlzQWN0aXZlID0gY29ubmVjdGlvblN0YXRlPy5hY3RpdmVcbiAgICAgIGlmIChpc0FjdGl2ZSkgcmV0dXJuXG5cbiAgICAgIGNvbnN0IHdzSGFuZGxlciA9IGFjdGlvbi5wYXlsb2FkLndzSGFuZGxlclxuICAgICAgY29uc3QgaGFzTm9PbkNvbm5lY3RDaGFpbiA9ICF3c0hhbmRsZXIub25Db25uZWN0Q2hhaW5cblxuICAgICAgY29uc3QgaXNDb25uZWN0aW5nID0gIWlzTmFOKE51bWJlcihjb25uZWN0aW9uU3RhdGU/LmNvbm5lY3RpbmcpKVxuICAgICAgc3RhdGUuYWxsW2tleV0gPSB7XG4gICAgICAgIC4uLmNvbm5lY3Rpb25TdGF0ZSxcbiAgICAgICAgYWN0aXZlOiBmYWxzZSxcbiAgICAgICAgY29ubmVjdGluZzogaXNDb25uZWN0aW5nID8gY29ubmVjdGlvblN0YXRlLmNvbm5lY3RpbmcgKyAxIDogMSxcbiAgICAgICAgcmVxdWVzdElkOiBpc0Nvbm5lY3RpbmcgPyBjb25uZWN0aW9uU3RhdGUucmVxdWVzdElkIDogMCxcbiAgICAgICAgaXNPbkNvbm5lY3RDaGFpbkNvbXBsZXRlOiBoYXNOb09uQ29ubmVjdENoYWluLFxuICAgICAgfVxuICAgIH0pXG5cbiAgICBidWlsZGVyLmFkZENhc2UoYWN0aW9ucy5jb25uZWN0RmFpbGVkLCAoc3RhdGUsIGFjdGlvbikgPT4ge1xuICAgICAgc3RhdGUuYWxsW2FjdGlvbi5wYXlsb2FkLmNvbm5lY3Rpb25JbmZvLmtleV0uY29ubmVjdGluZyA9IDBcbiAgICAgIHN0YXRlLmFsbFthY3Rpb24ucGF5bG9hZC5jb25uZWN0aW9uSW5mby5rZXldLmFjdGl2ZSA9IGZhbHNlXG4gICAgfSlcblxuICAgIGJ1aWxkZXIuYWRkQ2FzZShhY3Rpb25zLmRpc2Nvbm5lY3RGdWxmaWxsZWQsIChzdGF0ZSwgYWN0aW9uKSA9PiB7XG4gICAgICAvLyBSZW1vdmUgY29ubmVjdGlvblxuICAgICAgY29uc3QgeyBrZXkgfSA9IGFjdGlvbi5wYXlsb2FkLmNvbmZpZy5jb25uZWN0aW9uSW5mb1xuICAgICAgc3RhdGUuYWxsW2tleV0uYWN0aXZlID0gZmFsc2VcbiAgICAgIHN0YXRlLmFsbFtrZXldLmNvbm5lY3RpbmcgPSAwIC8vIHR1cm4gb2ZmIGNvbm5lY3RpbmdcbiAgICAgIHN0YXRlLmFsbFtrZXldLnJlcXVlc3RJZCA9IDBcbiAgICB9KVxuXG4gICAgYnVpbGRlci5hZGRDYXNlKGFjdGlvbnMuc3Vic2NyaXB0aW9uRXJyb3JIYW5kbGVyLCAoc3RhdGUsIGFjdGlvbikgPT4ge1xuICAgICAgY29uc3QgeyBrZXkgfSA9IGFjdGlvbi5wYXlsb2FkLmNvbm5lY3Rpb25JbmZvXG4gICAgICBzdGF0ZS5hbGxba2V5XS5zaG91bGROb3RSZXRyeUNvbm5lY3RpbmcgPSBhY3Rpb24ucGF5bG9hZC5zaG91bGROb3RSZXRyeUNvbm5lY3Rpb25cbiAgICB9KVxuXG4gICAgYnVpbGRlci5hZGRDYXNlKGFjdGlvbnMuV1NSZXNldCwgKCkgPT4gaW5pdENvbm5lY3Rpb25zU3RhdGUpXG5cbiAgICBidWlsZGVyLmFkZE1hdGNoZXIoXG4gICAgICBpc0FueU9mKFxuICAgICAgICBhY3Rpb25zLmNvbm5lY3RSZXF1ZXN0ZWQsXG4gICAgICAgIGFjdGlvbnMuY29ubmVjdEZ1bGZpbGxlZCxcbiAgICAgICAgYWN0aW9ucy5jb25uZWN0RmFpbGVkLFxuICAgICAgICBhY3Rpb25zLmRpc2Nvbm5lY3RGdWxmaWxsZWQsXG4gICAgICApLFxuICAgICAgKHN0YXRlKSA9PiB7XG4gICAgICAgIHN0YXRlLnRvdGFsID0gT2JqZWN0LnZhbHVlcyhzdGF0ZS5hbGwpLmZpbHRlcigocykgPT4gcz8uYWN0aXZlKS5sZW5ndGhcbiAgICAgIH0sXG4gICAgKVxuICB9LFxuKVxuXG5leHBvcnQgaW50ZXJmYWNlIFN1YnNjcmlwdGlvbnNTdGF0ZSB7XG4gIC8qKiBNYXAgb2YgYWxsIHN1YnNjcmlwdGlvbnMgYnkga2V5ICovXG4gIHRvdGFsOiBudW1iZXJcbiAgYWxsOiB7XG4gICAgW2tleTogc3RyaW5nXToge1xuICAgICAgYWN0aXZlOiBib29sZWFuXG4gICAgICB3YXNFdmVyQWN0aXZlPzogYm9vbGVhblxuICAgICAgdW5zdWJzY3JpYmVkPzogYm9vbGVhblxuICAgICAgc3Vic2NyaWJpbmc6IG51bWJlclxuICAgICAgaW5wdXQ6IEFkYXB0ZXJSZXF1ZXN0XG4gICAgICBjb250ZXh0OiBBZGFwdGVyQ29udGV4dFxuICAgICAgc3Vic2NyaXB0aW9uUGFyYW1zPzogYW55XG4gICAgICBjb25uZWN0aW9uS2V5OiBzdHJpbmdcbiAgICAgIHNob3VsZE5vdFJldHJ5PzogYm9vbGVhblxuICAgICAgbGFzdFVwZGF0ZWRBdD86IG51bWJlclxuICAgIH1cbiAgfVxufVxuXG5jb25zdCBpbml0U3Vic2NyaXB0aW9uc1N0YXRlOiBTdWJzY3JpcHRpb25zU3RhdGUgPSB7IHRvdGFsOiAwLCBhbGw6IHt9IH1cblxuZXhwb3J0IGNvbnN0IHN1YnNjcmlwdGlvbnNSZWR1Y2VyID0gY3JlYXRlUmVkdWNlcjxTdWJzY3JpcHRpb25zU3RhdGU+KFxuICBpbml0U3Vic2NyaXB0aW9uc1N0YXRlLFxuICAoYnVpbGRlcikgPT4ge1xuICAgIGJ1aWxkZXIuYWRkQ2FzZShhY3Rpb25zLnVwZGF0ZVN1YnNjcmlwdGlvbklucHV0LCAoc3RhdGUsIGFjdGlvbikgPT4ge1xuICAgICAgY29uc3Qga2V5ID0gYWN0aW9uLnBheWxvYWQuc3Vic2NyaXB0aW9uS2V5XG4gICAgICBzdGF0ZS5hbGxba2V5XSA9IHtcbiAgICAgICAgLi4uc3RhdGUuYWxsW2tleV0sXG4gICAgICAgIGlucHV0OiBhY3Rpb24ucGF5bG9hZC5pbnB1dCxcbiAgICAgIH1cbiAgICB9KVxuICAgIGJ1aWxkZXIuYWRkQ2FzZShhY3Rpb25zLnNhdmVGaXJzdE1lc3NhZ2VSZWNlaXZlZCwgKHN0YXRlLCBhY3Rpb24pID0+IHtcbiAgICAgIGNvbnN0IGtleSA9IGFjdGlvbi5wYXlsb2FkLnN1YnNjcmlwdGlvbktleVxuICAgICAgc3RhdGUuYWxsW2tleV0gPSB7XG4gICAgICAgIC4uLnN0YXRlLmFsbFtrZXldLFxuICAgICAgICBzdWJzY3JpcHRpb25QYXJhbXM6IGFjdGlvbi5wYXlsb2FkLm1lc3NhZ2UsXG4gICAgICB9XG4gICAgfSlcbiAgICBidWlsZGVyLmFkZENhc2UoYWN0aW9ucy5zdWJzY3JpYmVGdWxmaWxsZWQsIChzdGF0ZSwgYWN0aW9uKSA9PiB7XG4gICAgICAvLyBBZGQgc3Vic2NyaXB0aW9uXG4gICAgICBjb25zdCBrZXkgPSBnZXRTdWJzSWQoYWN0aW9uLnBheWxvYWQuc3Vic2NyaXB0aW9uTXNnKVxuICAgICAgc3RhdGUuYWxsW2tleV0gPSB7XG4gICAgICAgIGFjdGl2ZTogdHJ1ZSxcbiAgICAgICAgd2FzRXZlckFjdGl2ZTogdHJ1ZSxcbiAgICAgICAgdW5zdWJzY3JpYmVkOiBmYWxzZSxcbiAgICAgICAgc3Vic2NyaWJpbmc6IDAsXG4gICAgICAgIGlucHV0OiB7IC4uLmFjdGlvbi5wYXlsb2FkLmlucHV0IH0sXG4gICAgICAgIGNvbnRleHQ6IGFjdGlvbi5wYXlsb2FkLmNvbnRleHQsXG4gICAgICAgIGNvbm5lY3Rpb25LZXk6IGFjdGlvbi5wYXlsb2FkLmNvbm5lY3Rpb25JbmZvLmtleSxcbiAgICAgIH1cbiAgICB9KVxuXG4gICAgYnVpbGRlci5hZGRDYXNlKGFjdGlvbnMuc3Vic2NyaWJlUmVxdWVzdGVkLCAoc3RhdGUsIGFjdGlvbikgPT4ge1xuICAgICAgY29uc3Qga2V5ID0gZ2V0U3Vic0lkKGFjdGlvbi5wYXlsb2FkLnN1YnNjcmlwdGlvbk1zZylcbiAgICAgIGNvbnN0IGlzQWN0aXZlID0gc3RhdGUuYWxsW2tleV0/LmFjdGl2ZVxuICAgICAgaWYgKGlzQWN0aXZlKSByZXR1cm5cblxuICAgICAgaWYgKCFhY3Rpb24ucGF5bG9hZC5jb25uZWN0aW9uSW5mbykge1xuICAgICAgICBsb2dnZXIuZXJyb3IoYE1pc3NpbmcgY29ubmVjdGlvbiBpbmZvOiAke0pTT04uc3RyaW5naWZ5KGFjdGlvbi5wYXlsb2FkKX1gKVxuICAgICAgICByZXR1cm5cbiAgICAgIH1cblxuICAgICAgY29uc3QgaXNTdWJzY3JpYmluZyA9IHN0YXRlLmFsbFtrZXldPy5zdWJzY3JpYmluZ1xuICAgICAgc3RhdGUuYWxsW2tleV0gPSB7XG4gICAgICAgIGFjdGl2ZTogZmFsc2UsXG4gICAgICAgIHN1YnNjcmliaW5nOiBpc1N1YnNjcmliaW5nID8gc3RhdGUuYWxsW2tleV0uc3Vic2NyaWJpbmcgKyAxIDogMSxcbiAgICAgICAgaW5wdXQ6IHsgLi4uYWN0aW9uLnBheWxvYWQuaW5wdXQgfSxcbiAgICAgICAgY29udGV4dDogYWN0aW9uLnBheWxvYWQuY29udGV4dCxcbiAgICAgICAgY29ubmVjdGlvbktleTogYWN0aW9uLnBheWxvYWQuY29ubmVjdGlvbkluZm8ua2V5LFxuICAgICAgfVxuICAgIH0pXG5cbiAgICBidWlsZGVyLmFkZENhc2UoYWN0aW9ucy51bnN1YnNjcmliZUZ1bGZpbGxlZCwgKHN0YXRlLCBhY3Rpb24pID0+IHtcbiAgICAgIC8vIFJlbW92ZSBzdWJzY3JpcHRpb25cbiAgICAgIGNvbnN0IGtleSA9IGdldFN1YnNJZChhY3Rpb24ucGF5bG9hZC5zdWJzY3JpcHRpb25Nc2cpXG5cbiAgICAgIHN0YXRlLmFsbFtrZXldLmFjdGl2ZSA9IGZhbHNlXG4gICAgICBzdGF0ZS5hbGxba2V5XS51bnN1YnNjcmliZWQgPSB0cnVlXG4gICAgICBzdGF0ZS5hbGxba2V5XS5zdWJzY3JpYmluZyA9IDBcbiAgICB9KVxuXG4gICAgYnVpbGRlci5hZGRDYXNlKGFjdGlvbnMuc3Vic2NyaXB0aW9uRXJyb3JIYW5kbGVyLCAoc3RhdGUsIGFjdGlvbikgPT4ge1xuICAgICAgY29uc3Qga2V5ID0gZ2V0U3Vic0lkKGFjdGlvbi5wYXlsb2FkLnN1YnNjcmlwdGlvbk1zZylcbiAgICAgIGlmIChzdGF0ZS5hbGxba2V5XSkge1xuICAgICAgICBzdGF0ZS5hbGxba2V5XS5zaG91bGROb3RSZXRyeSA9IGFjdGlvbi5wYXlsb2FkLnNob3VsZE5vdFJldHJ5U3Vic2NyaXB0aW9uXG4gICAgICB9XG4gICAgfSlcblxuICAgIGJ1aWxkZXIuYWRkQ2FzZShhY3Rpb25zLmRpc2Nvbm5lY3RGdWxmaWxsZWQsIChzdGF0ZSkgPT4ge1xuICAgICAgc3RhdGUuYWxsID0ge31cbiAgICAgIHJldHVybiBzdGF0ZVxuICAgIH0pXG5cbiAgICBidWlsZGVyLmFkZENhc2UoYWN0aW9ucy5tZXNzYWdlUmVjZWl2ZWQsIChzdGF0ZSwgYWN0aW9uKSA9PiB7XG4gICAgICBjb25zdCBrZXkgPSBhY3Rpb24ucGF5bG9hZC5zdWJzY3JpcHRpb25LZXlcbiAgICAgIHN0YXRlLmFsbFtrZXldLmxhc3RVcGRhdGVkQXQgPSBhY3Rpb24ucGF5bG9hZC50aW1lc3RhbXBcbiAgICB9KVxuXG4gICAgYnVpbGRlci5hZGRDYXNlKGFjdGlvbnMuV1NSZXNldCwgKCkgPT4gaW5pdFN1YnNjcmlwdGlvbnNTdGF0ZSlcblxuICAgIGJ1aWxkZXIuYWRkTWF0Y2hlcihcbiAgICAgIGlzQW55T2YoYWN0aW9ucy5zdWJzY3JpYmVSZXF1ZXN0ZWQsIGFjdGlvbnMuc3Vic2NyaWJlRnVsZmlsbGVkLCBhY3Rpb25zLnVuc3Vic2NyaWJlRnVsZmlsbGVkKSxcbiAgICAgIChzdGF0ZSkgPT4ge1xuICAgICAgICBzdGF0ZS50b3RhbCA9IE9iamVjdC52YWx1ZXMoc3RhdGUuYWxsKS5maWx0ZXIoKHMpID0+IHM/LmFjdGl2ZSkubGVuZ3RoXG4gICAgICB9LFxuICAgIClcbiAgfSxcbilcblxuZXhwb3J0IGNvbnN0IHJvb3RSZWR1Y2VyID0gY29tYmluZVJlZHVjZXJzKHtcbiAgY29ubmVjdGlvbnM6IGNvbm5lY3Rpb25zUmVkdWNlcixcbiAgc3Vic2NyaXB0aW9uczogc3Vic2NyaXB0aW9uc1JlZHVjZXIsXG59KVxuXG5leHBvcnQgdHlwZSBSb290U3RhdGUgPSBSZXR1cm5UeXBlPHR5cGVvZiByb290UmVkdWNlcj5cbiJdfQ==