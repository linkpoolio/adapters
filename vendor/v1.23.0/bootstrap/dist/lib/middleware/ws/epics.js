"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.epicMiddleware = exports.rootEpic = exports.metricsEpic = exports.writeMessageToCacheEpic = exports.recordErrorEpic = exports.connectEpic = exports.subscribeReadyEpic = void 0;
const redux_observable_1 = require("redux-observable");
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const webSocket_1 = require("rxjs/webSocket");
const cache_1 = require("../cache");
const modules_1 = require("../../modules");
const util_1 = require("../../metrics/util");
const actions_1 = require("./actions");
const metrics_1 = require("./metrics");
const reducer_1 = require("./reducer");
const utils_1 = require("./utils");
const config_1 = require("./config");
const __1 = require("../../..");
const recorder_1 = require("./recorder");
const recordWsMessages = __1.util.parseBool(__1.util.getEnv('RECORD'));
// Rxjs deserializer defaults to JSON.parse.
// We need to handle errors from non-parsable messages
const deserializer = (message) => {
    try {
        const parsed = JSON.parse(message.data);
        if (recordWsMessages) {
            recorder_1.WsMessageRecorder.add({
                type: 'received',
                data: parsed,
            });
        }
        return parsed;
    }
    catch (e) {
        // If message looked like a JSON payload, write a message to the logs
        if (message.length > 1 && ['{', '['].includes(message.substr(0, 1))) {
            modules_1.logger.debug('WS: Message received with invalid format');
        }
        return message;
    }
};
const serializer = (message) => {
    if (recordWsMessages) {
        recorder_1.WsMessageRecorder.add({
            type: 'sent',
            data: message,
        });
    }
    if (typeof message === 'string')
        return message;
    const serialized = JSON.stringify(message);
    return serialized;
};
const subscribeReadyEpic = (action$) => action$.pipe(operators_1.filter(actions_1.wsSubscriptionReady.match), operators_1.concatMap(async ({ payload }) => {
    const { wsHandler, config, context, request } = payload;
    const subscriptionPayloads = [];
    await utils_1.separateBatches(request, async (singleInput) => {
        const subscriptionMsg = wsHandler.onConnectChain
            ? wsHandler.onConnectChain[0].payload
            : wsHandler.subscribe(singleInput);
        if (!subscriptionMsg) {
            modules_1.logger.error(`No subscription message found while seperating batches`, {
                singleInput,
                request,
            });
            return;
        }
        const subscriptionPayload = {
            connectionInfo: {
                key: config.connectionInfo.key,
                url: wsHandler.connection.url,
            },
            subscriptionMsg,
            input: singleInput,
            context,
            filterMultiplex: wsHandler.onConnectChain
                ? wsHandler.onConnectChain[0].filter
                : undefined,
        };
        subscriptionPayloads.push(subscriptionPayload);
    });
    return subscriptionPayloads;
}), operators_1.mergeMap(([subscriptionPayload]) => {
    const action = actions_1.subscribeRequested(subscriptionPayload);
    if (!subscriptionPayload) {
        modules_1.logger.debug('INVALID_SUBSCRIBE_REQUESTED_IN_READY_EPIC', action);
        return rxjs_1.EMPTY;
    }
    return rxjs_1.of(action);
}));
exports.subscribeReadyEpic = subscribeReadyEpic;
const connectEpic = (action$, state$) => action$.pipe(operators_1.filter(actions_1.connectRequested.match), operators_1.map(({ payload }) => ({ payload, connectionKey: payload.config.connectionInfo.key })), operators_1.withLatestFrom(state$), operators_1.filter(([{ connectionKey }, state]) => {
    const connectionState = state.ws.connections.all[connectionKey];
    const isActiveConnection = connectionState?.active;
    const isConnecting = connectionState?.connecting > 1;
    const hasErrored = connectionState?.shouldNotRetryConnecting;
    return (!hasErrored &&
        !isActiveConnection &&
        !isConnecting &&
        (!connectionState || connectionState.requestId === 0));
}), operators_1.concatMap(async (data) => {
    const getUrl = data[0].payload.wsHandler.connection.getUrl;
    if (getUrl)
        data[0].payload.wsHandler.connection.url = await getUrl(data[0].payload.request);
    return data;
}), 
// on a connect action being dispatched, open a new WS connection if one doesn't exist yet
operators_1.mergeMap(([{ connectionKey, payload }]) => {
    const { config, wsHandler } = payload;
    const { connection: { url, protocol }, } = wsHandler;
    const connectionMeta = (payload) => ({
        key: payload.config.connectionInfo.key,
        url: modules_1.censor(url),
    });
    const subscriptionMeta = (payload) => ({
        connection_key: payload.connectionInfo.key,
        connection_url: modules_1.censor(url),
        feed_id: util_1.getFeedId({ ...payload.input }),
        subscription_key: reducer_1.getSubsId(payload.subscriptionMsg),
    });
    const openObserver = new rxjs_1.Subject();
    const closeObserver = new rxjs_1.Subject();
    const errorObserver = new rxjs_1.Subject();
    const error$ = errorObserver.asObservable();
    const WebSocketCtor = recorder_1.WebSocketClassProvider.get();
    const wsSubject = webSocket_1.webSocket({
        url,
        protocol,
        deserializer,
        serializer,
        openObserver,
        closeObserver,
        WebSocketCtor: WebSocketCtor, // TODO: fix types don't match
    });
    wsHandler.onConnect && wsSubject.next(wsHandler.onConnect(payload.request));
    // Stream of WS connected & disconnected events
    const open$ = openObserver.pipe(operators_1.map(() => actions_1.connectFulfilled({ config, wsHandler, connectionInfo: config.connectionInfo })), operators_1.tap((action) => modules_1.logger.info('WS: Connected', connectionMeta(action.payload))));
    const close$ = closeObserver.pipe(operators_1.withLatestFrom(state$), operators_1.mergeMap(([closeContext, state]) => {
        const key = config.connectionInfo.key;
        const activeSubs = Object.entries(state.ws.subscriptions.all)
            .filter(([_, info]) => (info.active || info.subscribing > 0) && info.connectionKey === key)
            .map(([_, info]) => ({
            connectionInfo: {
                url,
                key: config.connectionInfo.key,
            },
            subscriptionMsg: wsHandler.subscribe(info.input),
            input: info.input,
        }));
        const toUnsubscribed = (payload) => actions_1.unsubscribeFulfilled(payload);
        modules_1.logger.info('Closing websocket connection', {
            context: {
                type: closeContext.type,
                wasClean: closeContext.wasClean,
                reason: closeContext.reason,
                code: closeContext.code,
            },
        });
        if (recordWsMessages)
            recorder_1.WsMessageRecorder.print();
        return rxjs_1.from([
            ...activeSubs.map(toUnsubscribed),
            actions_1.disconnectFulfilled({
                config,
                wsHandler,
            }),
        ]);
    }));
    // Close the WS connection on disconnect
    const disconnect$ = action$.pipe(operators_1.filter(actions_1.disconnectRequested.match), operators_1.filter(({ payload }) => payload.config.connectionInfo.key === connectionKey), operators_1.tap(() => wsSubject.closed || wsSubject.complete()), operators_1.tap((action) => modules_1.logger.info('WS: Disconnected', connectionMeta(action.payload))), operators_1.filter(() => false));
    // Subscription requests
    const subscriptions$ = action$.pipe(operators_1.filter(actions_1.subscribeRequested.match));
    const updateSubscriptionInput$ = subscriptions$.pipe(operators_1.filter(({ payload }) => payload.connectionInfo.key === connectionKey), operators_1.map(({ payload }) => ({
        payload,
        subscriptionKey: reducer_1.getSubsId(payload.subscriptionMsg),
    })), operators_1.withLatestFrom(state$), operators_1.filter(([{ subscriptionKey }, state]) => {
        const isActiveSubscription = !!state.ws.subscriptions.all[subscriptionKey]?.active;
        const isSubscribing = state.ws.subscriptions.all[subscriptionKey]?.subscribing > 1;
        if (!isActiveSubscription || isSubscribing) {
            return false;
        }
        const currentInput = state.ws.subscriptions.all[subscriptionKey]?.input;
        const currentSubscriptionKey = reducer_1.getSubsId(currentInput);
        return currentSubscriptionKey !== subscriptionKey;
    }), operators_1.mergeMap(async ([{ subscriptionKey, payload }]) => {
        return actions_1.updateSubscriptionInput({
            subscriptionKey,
            input: payload.input,
        });
    }));
    // Multiplex subscriptions
    const multiplexSubscriptions$ = subscriptions$.pipe(operators_1.filter(({ payload }) => payload.connectionInfo.key === connectionKey), operators_1.map(({ payload }) => ({
        payload,
        subscriptionKey: reducer_1.getSubsId(payload.subscriptionMsg),
    })), operators_1.withLatestFrom(state$), operators_1.filter(([{ subscriptionKey, payload }, state]) => {
        const isActiveSubscription = !!state.ws.subscriptions.all[subscriptionKey]?.active;
        const isSubscribing = state.ws.subscriptions.all[subscriptionKey]?.subscribing > 1;
        const shouldNotRetrySubscribing = state.ws.subscriptions.all[subscriptionKey]?.shouldNotRetry;
        const isNotActive = !isActiveSubscription && !isSubscribing;
        const { isDataMessage, onConnectChain } = wsHandler;
        if (isDataMessage && onConnectChain && isDataMessage(payload.subscriptionMsg)) {
            const connectionState = state.ws.connections.all[payload.connectionInfo.key];
            const hasOnConnectChainCompleted = connectionState.requestId >= onConnectChain.length;
            return !shouldNotRetrySubscribing && isNotActive && hasOnConnectChainCompleted;
        }
        return !shouldNotRetrySubscribing && isNotActive;
    }), 
    // on a subscribe action being dispatched, open a new WS subscription if one doesn't exist yet
    operators_1.mergeMap(([{ subscriptionKey, payload }, state]) => wsSubject
        .multiplex(() => {
        const clonedPayload = JSON.parse(JSON.stringify(payload.subscriptionMsg));
        const shouldModifyPayload = !!wsHandler.shouldModifyPayload &&
            wsHandler.shouldModifyPayload(clonedPayload) &&
            wsHandler.modifySubscriptionPayload;
        const connectionState = state.ws.connections.all[payload.connectionInfo.key];
        const subMsg = shouldModifyPayload && wsHandler.modifySubscriptionPayload
            ? wsHandler.modifySubscriptionPayload(clonedPayload, state.ws.subscriptions.all[subscriptionKey]?.subscriptionParams, connectionState.connectionParams, connectionState.requestId)
            : clonedPayload;
        return subMsg;
    }, () => wsHandler.unsubscribe(payload.input, state.ws.subscriptions.all[subscriptionKey]?.subscriptionParams), (message) => {
        const connectionState = state.ws.connections.all[payload.connectionInfo.key];
        const currentSubscriptionKey = reducer_1.getSubsId(wsHandler.subsFromMessage(message, payload.subscriptionMsg, payload.input, connectionState?.connectionParams));
        const shouldPassAlong = (payload.filterMultiplex && payload.filterMultiplex(message)) ||
            currentSubscriptionKey === subscriptionKey;
        if (!shouldPassAlong) {
            return false;
        }
        /**
         * If the error happens on the subscription, it will be on subscribing state and eventually unresponsiveTimeout will take care of it (unsubs/subs)
         * If the error happens during a subscription, and is only eventual, can be ignored
         * If the error happens during a subscription, and the subscription stop receiving messages, the unresponsiveTimeout will take care of it (unsubs/subs)
         */
        if (wsHandler.isError(message)) {
            const error = {
                reason: JSON.stringify(message),
                connectionInfo: { key: connectionKey, url },
                error: message,
            };
            modules_1.logger.error('WS: Error', error);
            errorObserver.next(actions_1.subscriptionError({
                ...error,
                wsHandler,
            }));
            return false;
        }
        return true;
    })
        .pipe(operators_1.withLatestFrom(state$), operators_1.mergeMap(([message, state]) => {
        const isActiveSubscription = !!state.ws.subscriptions.all[subscriptionKey]?.active;
        const actionPayload = {
            message,
            subscriptionKey,
            input: payload.input,
            context: payload.context,
            connectionInfo: payload.connectionInfo,
            wsHandler,
            timestamp: Date.now(),
        };
        const lastUpdatedAt = state.ws.subscriptions.all[subscriptionKey]?.lastUpdatedAt;
        const defaultMinTimeToNextUpdateInS = __1.util.getEnv('WS_TIME_UNTIL_HANDLE_NEXT_MESSAGE_OVERRIDE');
        const timeToNextHandle = defaultMinTimeToNextUpdateInS
            ? parseInt(defaultMinTimeToNextUpdateInS)
            : wsHandler.minTimeToNextMessageUpdateInS;
        if (timeToNextHandle &&
            !!lastUpdatedAt &&
            Date.now() - lastUpdatedAt < timeToNextHandle * 1000)
            return rxjs_1.EMPTY;
        if (!isActiveSubscription) {
            modules_1.logger.info('WS: Subscribed', subscriptionMeta(payload));
            return rxjs_1.of(actions_1.subscribeFulfilled(payload), actions_1.messageReceived(actionPayload));
        }
        return rxjs_1.of(actions_1.messageReceived(actionPayload));
    }), operators_1.takeUntil(rxjs_1.merge(action$.pipe(operators_1.filter(actions_1.unsubscribeRequested.match), operators_1.filter((a) => reducer_1.getSubsId(a.payload.subscriptionMsg) === subscriptionKey), operators_1.tap((a) => modules_1.logger.info('WS: Unsubscribed', subscriptionMeta(a.payload)))), action$.pipe(operators_1.filter(actions_1.disconnectFulfilled.match), operators_1.filter((a) => a.payload.config.connectionInfo.key === connectionKey)), action$.pipe(operators_1.filter(actions_1.WSReset.match)))), operators_1.endWith(actions_1.unsubscribeFulfilled(payload)))), operators_1.catchError((e) => {
        modules_1.logger.error(e);
        return rxjs_1.of(actions_1.connectFailed({ connectionInfo: { key: connectionKey, url }, reason: e.message }));
    }));
    const withHeartbeatAtIntervals$ = action$.pipe(operators_1.filter((action) => {
        return actions_1.connectFulfilled.match(action) && !!wsHandler.heartbeatMessage;
    }), operators_1.withLatestFrom(state$), operators_1.filter(([action, state]) => {
        const connectionKey = action.payload.connectionInfo.key;
        const connectionState = state.ws.connections.all[connectionKey];
        return !!connectionState && connectionState.active;
    }), operators_1.mergeMap(([action, state]) => {
        const connectionKey = action.payload.connectionInfo.key;
        const connectionState = state.ws.connections.all[connectionKey];
        const interval = wsHandler.heartbeatIntervalInMS || config.defaultHeartbeatIntervalInMS;
        return rxjs_1.timer(interval, interval).pipe(operators_1.tap(() => modules_1.logger.debug('Sending heartbeat message')), operators_1.mergeMap(() => {
            if (wsHandler.heartbeatMessage) {
                const heartbeatPayload = wsHandler.heartbeatMessage(connectionState.requestId, connectionState.connectionParams);
                wsSubject.next(heartbeatPayload);
            }
            return rxjs_1.EMPTY;
        }), operators_1.takeUntil(rxjs_1.merge(action$.pipe(operators_1.filter(actions_1.disconnectFulfilled.match), operators_1.filter((action) => action.payload.config.connectionInfo.key === connectionKey)), action$.pipe(operators_1.filter(actions_1.WSReset.match)))));
    }));
    // All received messages using the same connection key
    const message$ = action$.pipe(operators_1.filter(actions_1.messageReceived.match), operators_1.filter((action) => action.payload.connectionInfo.key === connectionKey));
    const withContinueOnConnectChain$ = message$.pipe(operators_1.withLatestFrom(state$), operators_1.filter(([action, state]) => {
        const key = action.payload.connectionInfo.key;
        const connectionState = state.ws.connections.all[key];
        return (!!connectionState &&
            !!wsHandler.onConnectChain &&
            connectionState.requestId <= wsHandler.onConnectChain.length);
    }), operators_1.mergeMap(([{ payload }, state]) => {
        const { input, context, message } = payload;
        const onConnectIdx = state.ws.connections.all[payload.connectionInfo.key]
            ? state.ws.connections.all[payload.connectionInfo.key].requestId
            : 0;
        if (!wsHandler.onConnectChain || onConnectIdx === undefined) {
            return rxjs_1.EMPTY;
        }
        const onConnectChainFinished = onConnectIdx >= wsHandler.onConnectChain.length;
        const subscriptionMsg = onConnectChainFinished
            ? wsHandler.subscribe(input)
            : wsHandler.onConnectChain[onConnectIdx].payload;
        const subscriptionPayload = {
            connectionInfo: {
                key: config.connectionInfo.key,
                url: wsHandler.connection.url,
            },
            subscriptionMsg,
            input,
            context,
            messageToSave: wsHandler.shouldSaveToConnection &&
                wsHandler.shouldSaveToConnection(message) &&
                wsHandler.saveOnConnectToConnection
                ? wsHandler.saveOnConnectToConnection(message)
                : null,
            filterMultiplex: onConnectChainFinished
                ? undefined
                : wsHandler.onConnectChain[onConnectIdx].filter,
            shouldNeverUnsubscribe: onConnectChainFinished
                ? false
                : wsHandler.onConnectChain[onConnectIdx].shouldNeverUnsubscribe,
        };
        const subscribeRequestedAction = actions_1.subscribeRequested(subscriptionPayload);
        if (onConnectChainFinished) {
            return rxjs_1.of(subscribeRequestedAction, actions_1.onConnectComplete(subscriptionPayload));
        }
        return rxjs_1.of(subscribeRequestedAction);
    }));
    const withSaveFirstMessageToStore$ = message$.pipe(operators_1.filter(() => {
        return !!wsHandler.toSaveFromFirstMessage;
    }), operators_1.withLatestFrom(state$), operators_1.filter(([action, state]) => {
        const key = action.payload.subscriptionKey;
        const subscription = state.ws.subscriptions.all[key];
        return subscription && !subscription.subscriptionParams;
    }), operators_1.mergeMap(([action]) => {
        const toSave = wsHandler.toSaveFromFirstMessage &&
            wsHandler.toSaveFromFirstMessage(action.payload.message);
        return toSave
            ? rxjs_1.of(actions_1.saveFirstMessageReceived({
                subscriptionKey: action.payload.subscriptionKey,
                message: toSave,
            }))
            : rxjs_1.EMPTY;
    }));
    const respondWithHeartbeat$ = message$.pipe(operators_1.filter((action) => !!wsHandler.shouldReplyToServerHeartbeat &&
        wsHandler.shouldReplyToServerHeartbeat(action.payload.message)), operators_1.withLatestFrom(state$), operators_1.mergeMap(([action, state]) => {
        const { connectionInfo, message } = action.payload;
        const key = connectionInfo.key;
        const { requestId, connectionParams } = state.ws.connections.all[key];
        if (wsHandler.heartbeatReplyMessage) {
            const heartbeatMessage = wsHandler.heartbeatReplyMessage(message, requestId, connectionParams);
            modules_1.logger.debug('Responding with heartbeat payload', heartbeatMessage);
            wsSubject.next(heartbeatMessage);
        }
        return rxjs_1.of(action);
    }), operators_1.filter(() => false));
    // Once a request happens, a subscription timeout starts. If no more requests ask for
    // this subscription before the time runs out, it will be unsubscribed
    const unsubscribeOnTimeout$ = subscriptions$.pipe(operators_1.filter((action) => !action.payload.shouldNeverUnsubscribe), 
    // when a subscription comes in
    // TODO: we need to filter duplicated subscriptions here
    operators_1.mergeMap(({ payload }) => {
        const subscriptionKey = reducer_1.getSubsId(payload.subscriptionMsg);
        // we look for matching subscriptions of the same type
        // which deactivates the current timer
        const reset$ = subscriptions$.pipe(operators_1.filter(({ payload }) => subscriptionKey === reducer_1.getSubsId(payload.subscriptionMsg)), operators_1.take(1));
        // start the current unsubscription timer
        const timeout$ = rxjs_1.of(actions_1.unsubscribeRequested({ ...payload })).pipe(operators_1.delay(config.subscriptionTTL), operators_1.tap(() => modules_1.logger.debug('WS: unsubscribe (inactive feed)', { payload: payload.subscriptionMsg })));
        // if a re-subscription comes in before timeout emits, then we emit nothing
        // else we unsubscribe from the current subscription
        return rxjs_1.race(reset$, timeout$).pipe(operators_1.filter((a) => !actions_1.subscribeRequested.match(a)));
    }));
    const unsubscribeOnNoResponse$ = message$.pipe(operators_1.withLatestFrom(state$), operators_1.mergeMap(([{ payload: { subscriptionKey }, }, state,]) => {
        let input = state.ws.subscriptions.all[subscriptionKey]?.input;
        if (!input) {
            modules_1.logger.warn(`WS: Could not find subscription from incoming message`);
            input = {};
        }
        const reset$ = message$.pipe(operators_1.filter(({ payload }) => subscriptionKey === payload.subscriptionKey), operators_1.take(1));
        let context = state.ws.subscriptions.all[subscriptionKey]?.context;
        if (!context) {
            modules_1.logger.warn(`WS Unsubscribe No Response: Could not find context`);
            context = {};
        }
        const action = {
            input,
            subscriptionMsg: wsHandler.subscribe(input),
            connectionInfo: { key: connectionKey, url },
            context,
        };
        const subReqAction = actions_1.subscribeRequested(action);
        const timeout$ = rxjs_1.of(actions_1.subscriptionError({
            ...action,
            reason: 'WS: unsubscribe -> subscribe (unresponsive channel)',
            wsHandler,
        }), actions_1.unsubscribeRequested(action), subReqAction).pipe(operators_1.delay(config.subscriptionUnresponsiveTTL), operators_1.tap((a) => {
            if (actions_1.subscriptionError.match(a)) {
                modules_1.logger.warn('[unsubscribeOnNoResponse] Resubscribing due to unresponsive subscription, this happens when a subscription does not receive a message for longer than the subscriptionUnresponsiveTTL value', { feedId: a.payload.input ? util_1.getFeedId(a.payload.input) : 'undefined' });
            }
        }), operators_1.withLatestFrom(state$), 
        // Filters by active subscription.
        // The timeout could think we don't receive messages because of unresponsiveness, and it's actually unsubscribed
        // isSubscribing is considered too as we want to trigger an unsubscription from a hung channel
        operators_1.mergeMap(([action, state]) => {
            const isActive = !!state.ws.subscriptions.all[subscriptionKey]?.active;
            const isSubscribing = !!(state.ws.subscriptions.all[subscriptionKey]?.subscribing > 0);
            return isActive || isSubscribing ? rxjs_1.of(action) : rxjs_1.EMPTY;
        }));
        return rxjs_1.race(reset$, timeout$).pipe(operators_1.filter((a) => !actions_1.messageReceived.match(a)));
    }));
    // Merge all & unsubscribe ws connection when a matching unsubscribe comes in
    const unsubscribe$ = rxjs_1.merge(unsubscribeOnTimeout$, unsubscribeOnNoResponse$);
    const ws$ = rxjs_1.merge(open$, close$, disconnect$, multiplexSubscriptions$, unsubscribe$, withSaveFirstMessageToStore$, updateSubscriptionInput$, withContinueOnConnectChain$, withHeartbeatAtIntervals$, error$, respondWithHeartbeat$).pipe(operators_1.takeUntil(rxjs_1.merge(action$.pipe(
    // TODO: not seeing unsubscribe events because of this
    operators_1.filter(actions_1.disconnectFulfilled.match), operators_1.filter((a) => a.payload.config.connectionInfo.key === connectionKey), operators_1.tap((action) => {
        modules_1.logger.debug('WS: Disconnected Fulfilled', connectionMeta(action.payload));
    })), action$.pipe(operators_1.filter(actions_1.WSReset.match)))));
    return rxjs_1.concat(rxjs_1.of(actions_1.wsSubscriptionReady(payload)), ws$);
}));
exports.connectEpic = connectEpic;
const recordErrorEpic = (action$) => action$.pipe(operators_1.filter((action) => actions_1.subscriptionError.match(action) && !!action.payload.error), operators_1.mergeMap(({ payload }) => {
    const { wsHandler, error, connectionInfo, subscriptionMsg, input } = payload;
    const { shouldNotRetryConnection, shouldNotRetrySubscription } = wsHandler;
    return rxjs_1.of(actions_1.subscriptionErrorHandler({
        input,
        connectionInfo,
        subscriptionMsg,
        shouldNotRetryConnection: !!shouldNotRetryConnection && shouldNotRetryConnection(error),
        shouldNotRetrySubscription: !!shouldNotRetrySubscription && shouldNotRetrySubscription(error),
    }));
}));
exports.recordErrorEpic = recordErrorEpic;
const writeMessageToCacheEpic = (action$, state$) => action$.pipe(operators_1.filter(actions_1.messageReceived.match), operators_1.filter((action) => action.payload.wsHandler.filter(action.payload.message)), operators_1.withLatestFrom(state$), operators_1.mergeMap(async ([action, state]) => {
    const wsHandler = action.payload.wsHandler;
    try {
        const subscriptionState = state.ws.subscriptions.all[action.payload.subscriptionKey];
        const input = subscriptionState?.input || {};
        if (!input)
            modules_1.logger.warn(`WS: Could not find subscription from incoming message`);
        /**
         * Wrap the payload so that the cache middleware treats it as if
         * it is calling out to the underlying API, which immediately resolves
         * to the websocket message here instead.
         *
         * This results in the cache middleware storing the payload message as a
         * cache value, with the following `wsResponse` as the cache key
         */
        const isToResponseAsync = wsHandler.toResponse.constructor.name === 'AsyncFunction';
        const response = isToResponseAsync
            ? await wsHandler.toResponse(action.payload.message, input)
            : wsHandler.toResponse(action.payload.message, input);
        if (!response)
            return action;
        const execute = () => Promise.resolve(response);
        let context = subscriptionState?.context;
        if (!context) {
            modules_1.logger.warn(`WS Unsubscribe No Response: Could not find context`);
            context = {};
        }
        const cache = await cache_1.withCache()(execute, context);
        const wsConfig = config_1.getWSConfig(input.data?.endpoint, context);
        /**
         * Create an adapter request we send to the cache middleware
         * so it uses the following object for setting cache keys
         */
        const wsResponse = {
            ...input,
            data: { maxAge: wsConfig.subscriptionTTL, ...input.data },
            debug: { ws: true, ...input.debug },
            metricsMeta: { feedId: util_1.getFeedId(input) },
        };
        await cache(wsResponse, context);
        modules_1.logger.trace('WS: Saved result', { input, result: response.result });
    }
    catch (e) {
        modules_1.logger.error(`WS: Cache error: ${e.message}`);
    }
    return action;
}), operators_1.filter(() => false));
exports.writeMessageToCacheEpic = writeMessageToCacheEpic;
const metricsEpic = (action$, state$) => action$.pipe(operators_1.withLatestFrom(state$), operators_1.tap(([action, state]) => {
    const connectionLabels = (payload) => ({
        key: payload.config.connectionInfo.key,
    });
    const connectionErrorLabels = (payload) => ({
        key: payload.connectionInfo.key,
        message: payload.reason,
    });
    const subscriptionLabels = (payload) => ({
        connection_key: payload.connectionInfo.key,
        feed_id: util_1.getFeedId({ ...payload.input }),
        subscription_key: reducer_1.getSubsId(payload.subscriptionMsg),
    });
    const subscriptionErrorLabels = (payload) => ({
        connection_key: payload.connectionInfo.key,
        feed_id: payload.input ? util_1.getFeedId({ ...payload.input }) : 'N/A',
        message: payload.reason,
        subscription_key: payload.subscriptionMsg ? reducer_1.getSubsId(payload.subscriptionMsg) : 'N/A',
    });
    const messageLabels = (payload) => ({
        feed_id: util_1.getFeedId({
            ...state.ws.subscriptions.all[action.payload.subscriptionKey]?.input,
        }),
        subscription_key: payload.subscriptionKey,
    });
    switch (action.type) {
        case actions_1.connectFulfilled.type:
            metrics_1.ws_connection_active.labels(connectionLabels(action.payload)).inc();
            break;
        case actions_1.connectFailed.type:
            metrics_1.ws_connection_errors.labels(connectionErrorLabels(action.payload)).inc();
            break;
        case actions_1.disconnectFulfilled.type:
            if (state.ws.connections.all[connectionLabels(action.payload).key]?.wasEverConnected) {
                metrics_1.ws_connection_active.labels(connectionLabels(action.payload)).dec();
            }
            break;
        case actions_1.subscribeFulfilled.type:
            metrics_1.ws_subscription_total.labels(subscriptionLabels(action.payload)).inc();
            metrics_1.ws_subscription_active.labels(subscriptionLabels(action.payload)).inc();
            break;
        case actions_1.subscriptionError.type:
            metrics_1.ws_subscription_errors.labels(subscriptionErrorLabels(action.payload)).inc();
            break;
        case actions_1.unsubscribeFulfilled.type: {
            const key = reducer_1.getSubsId(action.payload.subscriptionMsg);
            if (state.ws.subscriptions.all[key]?.wasEverActive) {
                metrics_1.ws_subscription_active.labels(subscriptionLabels(action.payload)).dec();
            }
            break;
        }
        case actions_1.messageReceived.type:
            metrics_1.ws_message_total.labels(messageLabels(action.payload)).inc();
            break;
    }
}), operators_1.map(([action]) => action), operators_1.filter(() => false));
exports.metricsEpic = metricsEpic;
exports.rootEpic = redux_observable_1.combineEpics(exports.connectEpic, exports.metricsEpic, exports.subscribeReadyEpic, exports.writeMessageToCacheEpic, exports.recordErrorEpic);
exports.epicMiddleware = redux_observable_1.createEpicMiddleware();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXBpY3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbGliL21pZGRsZXdhcmUvd3MvZXBpY3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBRUEsdURBQTJFO0FBQzNFLCtCQUF1RjtBQUN2Riw4Q0FZdUI7QUFDdkIsOENBQTBDO0FBQzFDLG9DQUFvQztBQUNwQywyQ0FBOEM7QUFDOUMsNkNBQThDO0FBQzlDLHVDQXdCa0I7QUFDbEIsdUNBT2tCO0FBQ2xCLHVDQUFnRDtBQUNoRCxtQ0FBeUM7QUFDekMscUNBQXNDO0FBQ3RDLGdDQUErQjtBQUMvQix5Q0FBc0U7QUFFdEUsTUFBTSxnQkFBZ0IsR0FBRyxRQUFJLENBQUMsU0FBUyxDQUFDLFFBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQTtBQUU5RCw0Q0FBNEM7QUFDNUMsc0RBQXNEO0FBQ3RELE1BQU0sWUFBWSxHQUFHLENBQUMsT0FBWSxFQUFFLEVBQUU7SUFDcEMsSUFBSTtRQUNGLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ3ZDLElBQUksZ0JBQWdCLEVBQUU7WUFDcEIsNEJBQWlCLENBQUMsR0FBRyxDQUFDO2dCQUNwQixJQUFJLEVBQUUsVUFBVTtnQkFDaEIsSUFBSSxFQUFFLE1BQU07YUFDYixDQUFDLENBQUE7U0FDSDtRQUNELE9BQU8sTUFBTSxDQUFBO0tBQ2Q7SUFBQyxPQUFPLENBQUMsRUFBRTtRQUNWLHFFQUFxRTtRQUNyRSxJQUFJLE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFO1lBQ25FLGdCQUFNLENBQUMsS0FBSyxDQUFDLDBDQUEwQyxDQUFDLENBQUE7U0FDekQ7UUFDRCxPQUFP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QUFLLENBQUMsRUFBRSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsYUFBYSxFQUFFO2dCQUNsRCxnQ0FBc0IsQ0FBQyxNQUFNLENBQUMsa0JBQWtCLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUE7YUFDeEU7WUFDRCxNQUFLO1NBQ047UUFDRCxLQUFLLHlCQUFlLENBQUMsSUFBSTtZQUN2QiwwQkFBZ0IsQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFBO1lBQzVELE1BQUs7S0FDUjtBQUNILENBQUMsQ0FBQyxFQUNGLGVBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxFQUN6QixrQkFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUNwQixDQUFBO0FBOURVLFFBQUEsV0FBVyxlQThEckI7QUFFVSxRQUFBLFFBQVEsR0FBRywrQkFBWSxDQUNsQyxtQkFBVyxFQUNYLG1CQUFXLEVBQ1gsMEJBQWtCLEVBQ2xCLCtCQUF1QixFQUN2Qix1QkFBZSxDQUNoQixDQUFBO0FBRVksUUFBQSxjQUFjLEdBQUcsdUNBQW9CLEVBQUUsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFkYXB0ZXJSZXF1ZXN0LCBBZGFwdGVyUmVzcG9uc2UsIEV4ZWN1dGUgfSBmcm9tICdAY2hhaW5saW5rL3R5cGVzJ1xuaW1wb3J0IHsgQW55QWN0aW9uIH0gZnJvbSAncmVkdXgnXG5pbXBvcnQgeyBjb21iaW5lRXBpY3MsIGNyZWF0ZUVwaWNNaWRkbGV3YXJlLCBFcGljIH0gZnJvbSAncmVkdXgtb2JzZXJ2YWJsZSdcbmltcG9ydCB7IGNvbmNhdCwgRU1QVFksIGZyb20sIG1lcmdlLCBPYnNlcnZhYmxlLCBvZiwgcmFjZSwgU3ViamVjdCwgdGltZXIgfSBmcm9tICdyeGpzJ1xuaW1wb3J0IHtcbiAgY2F0Y2hFcnJvcixcbiAgY29uY2F0TWFwLFxuICBkZWxheSxcbiAgZW5kV2l0aCxcbiAgZmlsdGVyLFxuICBtYXAsXG4gIG1lcmdlTWFwLFxuICB0YWtlLFxuICB0YWtlVW50aWwsXG4gIHRhcCxcbiAgd2l0aExhdGVzdEZyb20sXG59IGZyb20gJ3J4anMvb3BlcmF0b3JzJ1xuaW1wb3J0IHsgd2ViU29ja2V0IH0gZnJvbSAncnhqcy93ZWJTb2NrZXQnXG5pbXBvcnQgeyB3aXRoQ2FjaGUgfSBmcm9tICcuLi9jYWNoZSdcbmltcG9ydCB7IGNlbnNvciwgbG9nZ2VyIH0gZnJvbSAnLi4vLi4vbW9kdWxlcydcbmltcG9ydCB7IGdldEZlZWRJZCB9IGZyb20gJy4uLy4uL21ldHJpY3MvdXRpbCdcbmltcG9ydCB7XG4gIGNvbm5lY3RGYWlsZWQsXG4gIGNvbm5lY3RGdWxmaWxsZWQsXG4gIGNvbm5lY3RSZXF1ZXN0ZWQsXG4gIGRpc2Nvbm5lY3RGdWxmaWxsZWQsXG4gIGRpc2Nvbm5lY3RSZXF1ZXN0ZWQsXG4gIG1lc3NhZ2VSZWNlaXZlZCxcbiAgc3Vic2NyaWJlRnVsZmlsbGVkLFxuICBzdWJzY3JpYmVSZXF1ZXN0ZWQsXG4gIHN1YnNjcmlwdGlvbkVycm9yLFxuICB1bnN1YnNjcmliZUZ1bGZpbGxlZCxcbiAgdW5zdWJzY3JpYmVSZXF1ZXN0ZWQsXG4gIFdTQ29uZmlnUGF5bG9hZCxcbiAgV1NFcnJvclBheWxvYWQsXG4gIFdTTWVzc2FnZVBheWxvYWQsXG4gIFdTU3Vic2NyaXB0aW9uRXJyb3JQYXlsb2FkLFxuICBXU1N1YnNjcmlwdGlvblBheWxvYWQsXG4gIFdTQ29uZmlnT3ZlcnJpZGUsXG4gIHdzU3Vic2NyaXB0aW9uUmVhZHksXG4gIFdTUmVzZXQsXG4gIHNhdmVGaXJzdE1lc3NhZ2VSZWNlaXZlZCxcbiAgdXBkYXRlU3Vic2NyaXB0aW9uSW5wdXQsXG4gIG9uQ29ubmVjdENvbXBsZXRlLFxuICBzdWJzY3JpcHRpb25FcnJvckhhbmRsZXIsXG59IGZyb20gJy4vYWN0aW9ucydcbmltcG9ydCB7XG4gIHdzX2Nvbm5lY3Rpb25fYWN0aXZlLFxuICB3c19jb25uZWN0aW9uX2Vycm9ycyxcbiAgd3NfbWVzc2FnZV90b3RhbCxcbiAgd3Nfc3Vic2NyaXB0aW9uX2FjdGl2ZSxcbiAgd3Nfc3Vic2NyaXB0aW9uX2Vycm9ycyxcbiAgd3Nfc3Vic2NyaXB0aW9uX3RvdGFsLFxufSBmcm9tICcuL21ldHJpY3MnXG5pbXBvcnQgeyBnZXRTdWJzSWQsIFJvb3RTdGF0ZSB9IGZyb20gJy4vcmVkdWNlcidcbmltcG9ydCB7IHNlcGFyYXRlQmF0Y2hlcyB9IGZyb20gJy4vdXRpbHMnXG5pbXBvcnQgeyBnZXRXU0NvbmZpZyB9IGZyb20gJy4vY29uZmlnJ1xuaW1wb3J0IHsgdXRpbCB9IGZyb20gJy4uLy4uLy4uJ1xuaW1wb3J0IHsgV2ViU29ja2V0Q2xhc3NQcm92aWRlciwgV3NNZXNzYWdlUmVjb3JkZXIgfSBmcm9tICcuL3JlY29yZGVyJ1xuXG5jb25zdCByZWNvcmRXc01lc3NhZ2VzID0gdXRpbC5wYXJzZUJvb2wodXRpbC5nZXRFbnYoJ1JFQ09SRCcpKVxuXG4vLyBSeGpzIGRlc2VyaWFsaXplciBkZWZhdWx0cyB0byBKU09OLnBhcnNlLlxuLy8gV2UgbmVlZCB0byBoYW5kbGUgZXJyb3JzIGZyb20gbm9uLXBhcnNhYmxlIG1lc3NhZ2VzXG5jb25zdCBkZXNlcmlhbGl6ZXIgPSAobWVzc2FnZTogYW55KSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgcGFyc2VkID0gSlNPTi5wYXJzZShtZXNzYWdlLmRhdGEpXG4gICAgaWYgKHJlY29yZFdzTWVzc2FnZXMpIHtcbiAgICAgIFdzTWVzc2FnZVJlY29yZGVyLmFkZCh7XG4gICAgICAgIHR5cGU6ICdyZWNlaXZlZCcsXG4gICAgICAgIGRhdGE6IHBhcnNlZCxcbiAgICAgIH0pXG4gICAgfVxuICAgIHJldHVybiBwYXJzZWRcbiAgfSBjYXRjaCAoZSkge1xuICAgIC8vIElmIG1lc3NhZ2UgbG9va2VkIGxpa2UgYSBKU09OIHBheWxvYWQsIHdyaXRlIGEgbWVzc2FnZSB0byB0aGUgbG9nc1xuICAgIGlmIChtZXNzYWdlLmxlbmd0aCA+IDEgJiYgWyd7JywgJ1snXS5pbmNsdWRlcyhtZXNzYWdlLnN1YnN0cigwLCAxKSkpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZygnV1M6IE1lc3NhZ2UgcmVjZWl2ZWQgd2l0aCBpbnZhbGlkIGZvcm1hdCcpXG4gICAgfVxuICAgIHJldHVybiBtZXNzYWdlXG4gIH1cbn1cblxuY29uc3Qgc2VyaWFsaXplciA9IChtZXNzYWdlOiBhbnkpID0+IHtcbiAgaWYgKHJlY29yZFdzTWVzc2FnZXMpIHtcbiAgICBXc01lc3NhZ2VSZWNvcmRlci5hZGQoe1xuICAgICAgdHlwZTogJ3NlbnQnLFxuICAgICAgZGF0YTogbWVzc2FnZSxcbiAgICB9KVxuICB9XG4gIGlmICh0eXBlb2YgbWVzc2FnZSA9PT0gJ3N0cmluZycpIHJldHVybiBtZXNzYWdlXG4gIGNvbnN0IHNlcmlhbGl6ZWQgPSBKU09OLnN0cmluZ2lmeShtZXNzYWdlKVxuICByZXR1cm4gc2VyaWFsaXplZFxufVxuXG50eXBlIENvbm5lY3RSZXF1ZXN0ZWRBY3Rpb25XaXRoU3RhdGUgPSBbXG4gIHtcbiAgICBwYXlsb2FkOiBXU0NvbmZpZ092ZXJyaWRlXG4gICAgY29ubmVjdGlvbktleTogc3RyaW5nXG4gIH0sXG4gIHtcbiAgICB3czogUm9vdFN0YXRlXG4gIH0sXG5dXG5cbmV4cG9ydCBjb25zdCBzdWJzY3JpYmVSZWFkeUVwaWM6IEVwaWM8QW55QWN0aW9uLCBBbnlBY3Rpb24sIHsgd3M6IFJvb3RTdGF0ZSB9LCBhbnk+ID0gKGFjdGlvbiQpID0+XG4gIGFjdGlvbiQucGlwZShcbiAgICBmaWx0ZXIod3NTdWJzY3JpcHRpb25SZWFkeS5tYXRjaCksXG4gICAgY29uY2F0TWFwKGFzeW5jICh7IHBheWxvYWQgfSkgPT4ge1xuICAgICAgY29uc3QgeyB3c0hhbmRsZXIsIGNvbmZpZywgY29udGV4dCwgcmVxdWVzdCB9ID0gcGF5bG9hZFxuICAgICAgY29uc3Qgc3Vic2NyaXB0aW9uUGF5bG9hZHM6IFdTU3Vic2NyaXB0aW9uUGF5bG9hZFtdID0gW11cbiAgICAgIGF3YWl0IHNlcGFyYXRlQmF0Y2hlcyhyZXF1ZXN0LCBhc3luYyAoc2luZ2xlSW5wdXQ6IEFkYXB0ZXJSZXF1ZXN0KSA9PiB7XG4gICAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbk1zZyA9IHdzSGFuZGxlci5vbkNvbm5lY3RDaGFpblxuICAgICAgICAgID8gd3NIYW5kbGVyLm9uQ29ubmVjdENoYWluWzBdLnBheWxvYWRcbiAgICAgICAgICA6IHdzSGFuZGxlci5zdWJzY3JpYmUoc2luZ2xlSW5wdXQpXG4gICAgICAgIGlmICghc3Vic2NyaXB0aW9uTXNnKSB7XG4gICAgICAgICAgbG9nZ2VyLmVycm9yKGBObyBzdWJzY3JpcHRpb24gbWVzc2FnZSBmb3VuZCB3aGlsZSBzZXBlcmF0aW5nIGJhdGNoZXNgLCB7XG4gICAgICAgICAgICBzaW5nbGVJbnB1dCxcbiAgICAgICAgICAgIHJlcXVlc3QsXG4gICAgICAgICAgfSlcbiAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuICAgICAgICBjb25zdCBzdWJzY3JpcHRpb25QYXlsb2FkOiBXU1N1YnNjcmlwdGlvblBheWxvYWQgPSB7XG4gICAgICAgICAgY29ubmVjdGlvbkluZm86IHtcbiAgICAgICAgICAgIGtleTogY29uZmlnLmNvbm5lY3Rpb25JbmZvLmtleSxcbiAgICAgICAgICAgIHVybDogd3NIYW5kbGVyLmNvbm5lY3Rpb24udXJsLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgc3Vic2NyaXB0aW9uTXNnLFxuICAgICAgICAgIGlucHV0OiBzaW5nbGVJbnB1dCxcbiAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgIGZpbHRlck11bHRpcGxleDogd3NIYW5kbGVyLm9uQ29ubmVjdENoYWluXG4gICAgICAgICAgICA/IHdzSGFuZGxlci5vbkNvbm5lY3RDaGFpblswXS5maWx0ZXJcbiAgICAgICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgICB9XG4gICAgICAgIHN1YnNjcmlwdGlvblBheWxvYWRzLnB1c2goc3Vic2NyaXB0aW9uUGF5bG9hZClcbiAgICAgIH0pXG4gICAgICByZXR1cm4gc3Vic2NyaXB0aW9uUGF5bG9hZHNcbiAgICB9KSxcbiAgICBtZXJnZU1hcCgoW3N1YnNjcmlwdGlvblBheWxvYWRdKSA9PiB7XG4gICAgICBjb25zdCBhY3Rpb24gPSBzdWJzY3JpYmVSZXF1ZXN0ZWQoc3Vic2NyaXB0aW9uUGF5bG9hZClcbiAgICAgIGlmICghc3Vic2NyaXB0aW9uUGF5bG9hZCkge1xuICAgICAgICBsb2dnZXIuZGVidWcoJ0lOVkFMSURfU1VCU0NSSUJFX1JFUVVFU1RFRF9JTl9SRUFEWV9FUElDJywgYWN0aW9uKVxuICAgICAgICByZXR1cm4gRU1QVFlcbiAgICAgIH1cbiAgICAgIHJldHVybiBvZihhY3Rpb24pXG4gICAgfSksXG4gIClcblxuZXhwb3J0IGNvbnN0IGNvbm5lY3RFcGljOiBFcGljPEFueUFjdGlvbiwgQW55QWN0aW9uLCB7IHdzOiBSb290U3RhdGUgfSwgYW55PiA9IChhY3Rpb24kLCBzdGF0ZSQpID0+XG4gIGFjdGlvbiQucGlwZShcbiAgICBmaWx0ZXIoY29ubmVjdFJlcXVlc3RlZC5tYXRjaCksXG4gICAgbWFwKCh7IHBheWxvYWQgfSkgPT4gKHsgcGF5bG9hZCwgY29ubmVjdGlvbktleTogcGF5bG9hZC5jb25maWcuY29ubmVjdGlvbkluZm8ua2V5IH0pKSxcbiAgICB3aXRoTGF0ZXN0RnJvbShzdGF0ZSQpLFxuICAgIGZpbHRlcigoW3sgY29ubmVjdGlvbktleSB9LCBzdGF0ZV0pID0+IHtcbiAgICAgIGNvbnN0IGNvbm5lY3Rpb25TdGF0ZSA9IHN0YXRlLndzLmNvbm5lY3Rpb25zLmFsbFtjb25uZWN0aW9uS2V5XVxuICAgICAgY29uc3QgaXNBY3RpdmVDb25uZWN0aW9uID0gY29ubmVjdGlvblN0YXRlPy5hY3RpdmVcbiAgICAgIGNvbnN0IGlzQ29ubmVjdGluZyA9IGNvbm5lY3Rpb25TdGF0ZT8uY29ubmVjdGluZyA+IDFcbiAgICAgIGNvbnN0IGhhc0Vycm9yZWQgPSBjb25uZWN0aW9uU3RhdGU/LnNob3VsZE5vdFJldHJ5Q29ubmVjdGluZ1xuICAgICAgcmV0dXJuIChcbiAgICAgICAgIWhhc0Vycm9yZWQgJiZcbiAgICAgICAgIWlzQWN0aXZlQ29ubmVjdGlvbiAmJlxuICAgICAgICAhaXNDb25uZWN0aW5nICYmXG4gICAgICAgICghY29ubmVjdGlvblN0YXRlIHx8IGNvbm5lY3Rpb25TdGF0ZS5yZXF1ZXN0SWQgPT09IDApXG4gICAgICApXG4gICAgfSksXG4gICAgY29uY2F0TWFwKGFzeW5jIChkYXRhKSA9PiB7XG4gICAgICBjb25zdCBnZXRVcmwgPSBkYXRhWzBdLnBheWxvYWQud3NIYW5kbGVyLmNvbm5lY3Rpb24uZ2V0VXJsXG4gICAgICBpZiAoZ2V0VXJsKSBkYXRhWzBdLnBheWxvYWQud3NIYW5kbGVyLmNvbm5lY3Rpb24udXJsID0gYXdhaXQgZ2V0VXJsKGRhdGFbMF0ucGF5bG9hZC5yZXF1ZXN0KVxuICAgICAgcmV0dXJuIGRhdGEgYXMgQ29ubmVjdFJlcXVlc3RlZEFjdGlvbldpdGhTdGF0ZVxuICAgIH0pLFxuICAgIC8vIG9uIGEgY29ubmVjdCBhY3Rpb24gYmVpbmcgZGlzcGF0Y2hlZCwgb3BlbiBhIG5ldyBXUyBjb25uZWN0aW9uIGlmIG9uZSBkb2Vzbid0IGV4aXN0IHlldFxuICAgIG1lcmdlTWFwKChbeyBjb25uZWN0aW9uS2V5LCBwYXlsb2FkIH1dKSA9PiB7XG4gICAgICBjb25zdCB7IGNvbmZpZywgd3NIYW5kbGVyIH0gPSBwYXlsb2FkXG4gICAgICBjb25zdCB7XG4gICAgICAgIGNvbm5lY3Rpb246IHsgdXJsLCBwcm90b2NvbCB9LFxuICAgICAgfSA9IHdzSGFuZGxlclxuICAgICAgY29uc3QgY29ubmVjdGlvbk1ldGEgPSAocGF5bG9hZDogV1NDb25maWdQYXlsb2FkKSA9PiAoe1xuICAgICAgICBrZXk6IHBheWxvYWQuY29uZmlnLmNvbm5lY3Rpb25JbmZvLmtleSxcbiAgICAgICAgdXJsOiBjZW5zb3IodXJsKSxcbiAgICAgIH0pXG4gICAgICBjb25zdCBzdWJzY3JpcHRpb25NZXRhID0gKHBheWxvYWQ6IFdTU3Vic2NyaXB0aW9uUGF5bG9hZCkgPT4gKHtcbiAgICAgICAgY29ubmVjdGlvbl9rZXk6IHBheWxvYWQuY29ubmVjdGlvbkluZm8ua2V5LFxuICAgICAgICBjb25uZWN0aW9uX3VybDogY2Vuc29yKHVybCksXG4gICAgICAgIGZlZWRfaWQ6IGdldEZlZWRJZCh7IC4uLnBheWxvYWQuaW5wdXQgfSksXG4gICAgICAgIHN1YnNjcmlwdGlvbl9rZXk6IGdldFN1YnNJZChwYXlsb2FkLnN1YnNjcmlwdGlvbk1zZyksXG4gICAgICB9KVxuXG4gICAgICBjb25zdCBvcGVuT2JzZXJ2ZXIgPSBuZXcgU3ViamVjdCgpXG4gICAgICBjb25zdCBjbG9zZU9ic2VydmVyID0gbmV3IFN1YmplY3Q8Q2xvc2VFdmVudD4oKVxuICAgICAgY29uc3QgZXJyb3JPYnNlcnZlciA9IG5ldyBTdWJqZWN0KClcbiAgICAgIGNvbnN0IGVycm9yJCA9IGVycm9yT2JzZXJ2ZXIuYXNPYnNlcnZhYmxlKCkgYXMgT2JzZXJ2YWJsZTxBbnlBY3Rpb24+XG4gICAgICBjb25zdCBXZWJTb2NrZXRDdG9yID0gV2ViU29ja2V0Q2xhc3NQcm92aWRlci5nZXQoKVxuICAgICAgY29uc3Qgd3NTdWJqZWN0ID0gd2ViU29ja2V0KHtcbiAgICAgICAgdXJsLFxuICAgICAgICBwcm90b2NvbCwgLy8gVE9ETzogRG91YmxlIGNoZWNrIHRoaXNcbiAgICAgICAgZGVzZXJpYWxpemVyLFxuICAgICAgICBzZXJpYWxpemVyLFxuICAgICAgICBvcGVuT2JzZXJ2ZXIsXG4gICAgICAgIGNsb3NlT2JzZXJ2ZXIsXG4gICAgICAgIFdlYlNvY2tldEN0b3I6IFdlYlNvY2tldEN0b3IgYXMgYW55LCAvLyBUT0RPOiBmaXggdHlwZXMgZG9uJ3QgbWF0Y2hcbiAgICAgIH0pXG5cbiAgICAgIHdzSGFuZGxlci5vbkNvbm5lY3QgJiYgd3NTdWJqZWN0Lm5leHQod3NIYW5kbGVyLm9uQ29ubmVjdChwYXlsb2FkLnJlcXVlc3QpKVxuXG4gICAgICAvLyBTdHJlYW0gb2YgV1MgY29ubmVjdGVkICYgZGlzY29ubmVjdGVkIGV2ZW50c1xuICAgICAgY29uc3Qgb3BlbiQgPSBvcGVuT2JzZXJ2ZXIucGlwZShcbiAgICAgICAgbWFwKCgpID0+IGNvbm5lY3RGdWxmaWxsZWQoeyBjb25maWcsIHdzSGFuZGxlciwgY29ubmVjdGlvbkluZm86IGNvbmZpZy5jb25uZWN0aW9uSW5mbyB9KSksXG4gICAgICAgIHRhcCgoYWN0aW9uKSA9PiBsb2dnZXIuaW5mbygnV1M6IENvbm5lY3RlZCcsIGNvbm5lY3Rpb25NZXRhKGFjdGlvbi5wYXlsb2FkKSkpLFxuICAgICAgKVxuICAgICAgY29uc3QgY2xvc2UkID0gY2xvc2VPYnNlcnZlci5waXBlKFxuICAgICAgICB3aXRoTGF0ZXN0RnJvbShzdGF0ZSQpLFxuICAgICAgICBtZXJnZU1hcCgoW2Nsb3NlQ29udGV4dCwgc3RhdGVdKSA9PiB7XG4gICAgICAgICAgY29uc3Qga2V5ID0gY29uZmlnLmNvbm5lY3Rpb25JbmZvLmtleVxuICAgICAgICAgIGNvbnN0IGFjdGl2ZVN1YnMgPSBPYmplY3QuZW50cmllcyhzdGF0ZS53cy5zdWJzY3JpcHRpb25zLmFsbClcbiAgICAgICAgICAgIC5maWx0ZXIoXG4gICAgICAgICAgICAgIChbXywgaW5mb10pID0+IChpbmZvLmFjdGl2ZSB8fCBpbmZvLnN1YnNjcmliaW5nID4gMCkgJiYgaW5mby5jb25uZWN0aW9uS2V5ID09PSBrZXksXG4gICAgICAgICAgICApXG4gICAgICAgICAgICAubWFwKFxuICAgICAgICAgICAgICAoW18sIGluZm9dKSA9PlxuICAgICAgICAgICAgICAgICh7XG4gICAgICAgICAgICAgICAgICBjb25uZWN0aW9uSW5mbzoge1xuICAgICAgICAgICAgICAgICAgICB1cmwsXG4gICAgICAgICAgICAgICAgICAgIGtleTogY29uZmlnLmNvbm5lY3Rpb25JbmZvLmtleSxcbiAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb25Nc2c6IHdzSGFuZGxlci5zdWJzY3JpYmUoaW5mby5pbnB1dCksXG4gICAgICAgICAgICAgICAgICBpbnB1dDogaW5mby5pbnB1dCxcbiAgICAgICAgICAgICAgICB9IGFzIFdTU3Vic2NyaXB0aW9uUGF5bG9hZCksXG4gICAgICAgICAgICApXG4gICAgICAgICAgY29uc3QgdG9VbnN1YnNjcmliZWQgPSAocGF5bG9hZDogV1NTdWJzY3JpcHRpb25QYXlsb2FkKSA9PiB1bnN1YnNjcmliZUZ1bGZpbGxlZChwYXlsb2FkKVxuICAgICAgICAgIGxvZ2dlci5pbmZvKCdDbG9zaW5nIHdlYnNvY2tldCBjb25uZWN0aW9uJywge1xuICAgICAgICAgICAgY29udGV4dDoge1xuICAgICAgICAgICAgICB0eXBlOiBjbG9zZUNvbnRleHQudHlwZSxcbiAgICAgICAgICAgICAgd2FzQ2xlYW46IGNsb3NlQ29udGV4dC53YXNDbGVhbixcbiAgICAgICAgICAgICAgcmVhc29uOiBjbG9zZUNvbnRleHQucmVhc29uLFxuICAgICAgICAgICAgICBjb2RlOiBjbG9zZUNvbnRleHQuY29kZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSlcblxuICAgICAgICAgIGlmIChyZWNvcmRXc01lc3NhZ2VzKSBXc01lc3NhZ2VSZWNvcmRlci5wcmludCgpXG5cbiAgICAgICAgICByZXR1cm4gZnJvbShbXG4gICAgICAgICAgICAuLi5hY3RpdmVTdWJzLm1hcCh0b1Vuc3Vic2NyaWJlZCksXG4gICAgICAgICAgICBkaXNjb25uZWN0RnVsZmlsbGVkKHtcbiAgICAgICAgICAgICAgY29uZmlnLFxuICAgICAgICAgICAgICB3c0hhbmRsZXIsXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICBdKVxuICAgICAgICB9KSxcbiAgICAgIClcblxuICAgICAgLy8gQ2xvc2UgdGhlIFdTIGNvbm5lY3Rpb24gb24gZGlzY29ubmVjdFxuICAgICAgY29uc3QgZGlzY29ubmVjdCQgPSBhY3Rpb24kLnBpcGUoXG4gICAgICAgIGZpbHRlcihkaXNjb25uZWN0UmVxdWVzdGVkLm1hdGNoKSxcbiAgICAgICAgZmlsdGVyKCh7IHBheWxvYWQgfSkgPT4gcGF5bG9hZC5jb25maWcuY29ubmVjdGlvbkluZm8ua2V5ID09PSBjb25uZWN0aW9uS2V5KSxcbiAgICAgICAgdGFwKCgpID0+IHdzU3ViamVjdC5jbG9zZWQgfHwgd3NTdWJqZWN0LmNvbXBsZXRlKCkpLFxuICAgICAgICB0YXAoKGFjdGlvbikgPT4gbG9nZ2VyLmluZm8oJ1dTOiBEaXNjb25uZWN0ZWQnLCBjb25uZWN0aW9uTWV0YShhY3Rpb24ucGF5bG9hZCkpKSxcbiAgICAgICAgZmlsdGVyKCgpID0+IGZhbHNlKSwgLy8gZG8gbm90IGR1cGxpY2F0ZSBldmVudHNcbiAgICAgIClcblxuICAgICAgLy8gU3Vic2NyaXB0aW9uIHJlcXVlc3RzXG4gICAgICBjb25zdCBzdWJzY3JpcHRpb25zJCA9IGFjdGlvbiQucGlwZShmaWx0ZXIoc3Vic2NyaWJlUmVxdWVzdGVkLm1hdGNoKSlcblxuICAgICAgY29uc3QgdXBkYXRlU3Vic2NyaXB0aW9uSW5wdXQkID0gc3Vic2NyaXB0aW9ucyQucGlwZShcbiAgICAgICAgZmlsdGVyKCh7IHBheWxvYWQgfSkgPT4gcGF5bG9hZC5jb25uZWN0aW9uSW5mby5rZXkgPT09IGNvbm5lY3Rpb25LZXkpLFxuICAgICAgICBtYXAoKHsgcGF5bG9hZCB9KSA9PiAoe1xuICAgICAgICAgIHBheWxvYWQsXG4gICAgICAgICAgc3Vic2NyaXB0aW9uS2V5OiBnZXRTdWJzSWQocGF5bG9hZC5zdWJzY3JpcHRpb25Nc2cpLFxuICAgICAgICB9KSksXG4gICAgICAgIHdpdGhMYXRlc3RGcm9tKHN0YXRlJCksXG4gICAgICAgIGZpbHRlcigoW3sgc3Vic2NyaXB0aW9uS2V5IH0sIHN0YXRlXSkgPT4ge1xuICAgICAgICAgIGNvbnN0IGlzQWN0aXZlU3Vic2NyaXB0aW9uID0gISFzdGF0ZS53cy5zdWJzY3JpcHRpb25zLmFsbFtzdWJzY3JpcHRpb25LZXldPy5hY3RpdmVcbiAgICAgICAgICBjb25zdCBpc1N1YnNjcmliaW5nID0gc3RhdGUud3Muc3Vic2NyaXB0aW9ucy5hbGxbc3Vic2NyaXB0aW9uS2V5XT8uc3Vic2NyaWJpbmcgPiAxXG4gICAgICAgICAgaWYgKCFpc0FjdGl2ZVN1YnNjcmlwdGlvbiB8fCBpc1N1YnNjcmliaW5nKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgICAgICB9XG4gICAgICAgICAgY29uc3QgY3VycmVudElucHV0ID0gc3RhdGUud3Muc3Vic2NyaXB0aW9ucy5hbGxbc3Vic2NyaXB0aW9uS2V5XT8uaW5wdXRcbiAgICAgICAgICBjb25zdCBjdXJyZW50U3Vic2NyaXB0aW9uS2V5ID0gZ2V0U3Vic0lkKGN1cnJlbnRJbnB1dClcbiAgICAgICAgICByZXR1cm4gY3VycmVudFN1YnNjcmlwdGlvbktleSAhPT0gc3Vic2NyaXB0aW9uS2V5XG4gICAgICAgIH0pLFxuICAgICAgICBtZXJnZU1hcChhc3luYyAoW3sgc3Vic2NyaXB0aW9uS2V5LCBwYXlsb2FkIH1dKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHVwZGF0ZVN1YnNjcmlwdGlvbklucHV0KHtcbiAgICAgICAgICAgIHN1YnNjcmlwdGlvbktleSxcbiAgICAgICAgICAgIGlucHV0OiBwYXlsb2FkLmlucHV0LFxuICAgICAgICAgIH0pXG4gICAgICAgIH0pLFxuICAgICAgKVxuXG4gICAgICAvLyBNdWx0aXBsZXggc3Vic2NyaXB0aW9uc1xuICAgICAgY29uc3QgbXVsdGlwbGV4U3Vic2NyaXB0aW9ucyQgPSBzdWJzY3JpcHRpb25zJC5waXBlKFxuICAgICAgICBmaWx0ZXIoKHsgcGF5bG9hZCB9KSA9PiBwYXlsb2FkLmNvbm5lY3Rpb25JbmZvLmtleSA9PT0gY29ubmVjdGlvbktleSksXG4gICAgICAgIG1hcCgoeyBwYXlsb2FkIH0pID0+ICh7XG4gICAgICAgICAgcGF5bG9hZCxcbiAgICAgICAgICBzdWJzY3JpcHRpb25LZXk6IGdldFN1YnNJZChwYXlsb2FkLnN1YnNjcmlwdGlvbk1zZyksXG4gICAgICAgIH0pKSxcbiAgICAgICAgd2l0aExhdGVzdEZyb20oc3RhdGUkKSxcbiAgICAgICAgZmlsdGVyKChbeyBzdWJzY3JpcHRpb25LZXksIHBheWxvYWQgfSwgc3RhdGVdKSA9PiB7XG4gICAgICAgICAgY29uc3QgaXNBY3RpdmVTdWJzY3JpcHRpb24gPSAhIXN0YXRlLndzLnN1YnNjcmlwdGlvbnMuYWxsW3N1YnNjcmlwdGlvbktleV0/LmFjdGl2ZVxuICAgICAgICAgIGNvbnN0IGlzU3Vic2NyaWJpbmcgPSBzdGF0ZS53cy5zdWJzY3JpcHRpb25zLmFsbFtzdWJzY3JpcHRpb25LZXldPy5zdWJzY3JpYmluZyA+IDFcbiAgICAgICAgICBjb25zdCBzaG91bGROb3RSZXRyeVN1YnNjcmliaW5nID1cbiAgICAgICAgICAgIHN0YXRlLndzLnN1YnNjcmlwdGlvbnMuYWxsW3N1YnNjcmlwdGlvbktleV0/LnNob3VsZE5vdFJldHJ5XG4gICAgICAgICAgY29uc3QgaXNOb3RBY3RpdmUgPSAhaXNBY3RpdmVTdWJzY3JpcHRpb24gJiYgIWlzU3Vic2NyaWJpbmdcbiAgICAgICAgICBjb25zdCB7IGlzRGF0YU1lc3NhZ2UsIG9uQ29ubmVjdENoYWluIH0gPSB3c0hhbmRsZXJcbiAgICAgICAgICBpZiAoaXNEYXRhTWVzc2FnZSAmJiBvbkNvbm5lY3RDaGFpbiAmJiBpc0RhdGFNZXNzYWdlKHBheWxvYWQuc3Vic2NyaXB0aW9uTXNnKSkge1xuICAgICAgICAgICAgY29uc3QgY29ubmVjdGlvblN0YXRlID0gc3RhdGUud3MuY29ubmVjdGlvbnMuYWxsW3BheWxvYWQuY29ubmVjdGlvbkluZm8ua2V5XVxuICAgICAgICAgICAgY29uc3QgaGFzT25Db25uZWN0Q2hhaW5Db21wbGV0ZWQgPSBjb25uZWN0aW9uU3RhdGUucmVxdWVzdElkID49IG9uQ29ubmVjdENoYWluLmxlbmd0aFxuICAgICAgICAgICAgcmV0dXJuICFzaG91bGROb3RSZXRyeVN1YnNjcmliaW5nICYmIGlzTm90QWN0aXZlICYmIGhhc09uQ29ubmVjdENoYWluQ29tcGxldGVkXG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiAhc2hvdWxkTm90UmV0cnlTdWJzY3JpYmluZyAmJiBpc05vdEFjdGl2ZVxuICAgICAgICB9KSxcbiAgICAgICAgLy8gb24gYSBzdWJzY3JpYmUgYWN0aW9uIGJlaW5nIGRpc3BhdGNoZWQsIG9wZW4gYSBuZXcgV1Mgc3Vic2NyaXB0aW9uIGlmIG9uZSBkb2Vzbid0IGV4aXN0IHlldFxuICAgICAgICBtZXJnZU1hcCgoW3sgc3Vic2NyaXB0aW9uS2V5LCBwYXlsb2FkIH0sIHN0YXRlXSkgPT5cbiAgICAgICAgICB3c1N1YmplY3RcbiAgICAgICAgICAgIC5tdWx0aXBsZXgoXG4gICAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBjbG9uZWRQYXlsb2FkID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShwYXlsb2FkLnN1YnNjcmlwdGlvbk1zZykpXG4gICAgICAgICAgICAgICAgY29uc3Qgc2hvdWxkTW9kaWZ5UGF5bG9hZCA9XG4gICAgICAgICAgICAgICAgICAhIXdzSGFuZGxlci5zaG91bGRNb2RpZnlQYXlsb2FkICYmXG4gICAgICAgICAgICAgICAgICB3c0hhbmRsZXIuc2hvdWxkTW9kaWZ5UGF5bG9hZChjbG9uZWRQYXlsb2FkKSAmJlxuICAgICAgICAgICAgICAgICAgd3NIYW5kbGVyLm1vZGlmeVN1YnNjcmlwdGlvblBheWxvYWRcbiAgICAgICAgICAgICAgICBjb25zdCBjb25uZWN0aW9uU3RhdGUgPSBzdGF0ZS53cy5jb25uZWN0aW9ucy5hbGxbcGF5bG9hZC5jb25uZWN0aW9uSW5mby5rZXldXG4gICAgICAgICAgICAgICAgY29uc3Qgc3ViTXNnID1cbiAgICAgICAgICAgICAgICAgIHNob3VsZE1vZGlmeVBheWxvYWQgJiYgd3NIYW5kbGVyLm1vZGlmeVN1YnNjcmlwdGlvblBheWxvYWRcbiAgICAgICAgICAgICAgICAgICAgPyB3c0hhbmRsZXIubW9kaWZ5U3Vic2NyaXB0aW9uUGF5bG9hZChcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsb25lZFBheWxvYWQsXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS53cy5zdWJzY3JpcHRpb25zLmFsbFtzdWJzY3JpcHRpb25LZXldPy5zdWJzY3JpcHRpb25QYXJhbXMsXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25uZWN0aW9uU3RhdGUuY29ubmVjdGlvblBhcmFtcyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbm5lY3Rpb25TdGF0ZS5yZXF1ZXN0SWQsXG4gICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICA6IGNsb25lZFBheWxvYWRcbiAgICAgICAgICAgICAgICByZXR1cm4gc3ViTXNnXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICgpID0+XG4gICAgICAgICAgICAgICAgd3NIYW5kbGVyLnVuc3Vic2NyaWJlKFxuICAgICAgICAgICAgICAgICAgcGF5bG9hZC5pbnB1dCxcbiAgICAgICAgICAgICAgICAgIHN0YXRlLndzLnN1YnNjcmlwdGlvbnMuYWxsW3N1YnNjcmlwdGlvbktleV0/LnN1YnNjcmlwdGlvblBhcmFtcyxcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAobWVzc2FnZSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGNvbm5lY3Rpb25TdGF0ZSA9IHN0YXRlLndzLmNvbm5lY3Rpb25zLmFsbFtwYXlsb2FkLmNvbm5lY3Rpb25JbmZvLmtleV1cbiAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50U3Vic2NyaXB0aW9uS2V5ID0gZ2V0U3Vic0lkKFxuICAgICAgICAgICAgICAgICAgd3NIYW5kbGVyLnN1YnNGcm9tTWVzc2FnZShcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZSxcbiAgICAgICAgICAgICAgICAgICAgcGF5bG9hZC5zdWJzY3JpcHRpb25Nc2csXG4gICAgICAgICAgICAgICAgICAgIHBheWxvYWQuaW5wdXQsXG4gICAgICAgICAgICAgICAgICAgIGNvbm5lY3Rpb25TdGF0ZT8uY29ubmVjdGlvblBhcmFtcyxcbiAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIGNvbnN0IHNob3VsZFBhc3NBbG9uZyA9XG4gICAgICAgICAgICAgICAgICAocGF5bG9hZC5maWx0ZXJNdWx0aXBsZXggJiYgcGF5bG9hZC5maWx0ZXJNdWx0aXBsZXgobWVzc2FnZSkpIHx8XG4gICAgICAgICAgICAgICAgICBjdXJyZW50U3Vic2NyaXB0aW9uS2V5ID09PSBzdWJzY3JpcHRpb25LZXlcbiAgICAgICAgICAgICAgICBpZiAoIXNob3VsZFBhc3NBbG9uZykge1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICAgICAqIElmIHRoZSBlcnJvciBoYXBwZW5zIG9uIHRoZSBzdWJzY3JpcHRpb24sIGl0IHdpbGwgYmUgb24gc3Vic2NyaWJpbmcgc3RhdGUgYW5kIGV2ZW50dWFsbHkgdW5yZXNwb25zaXZlVGltZW91dCB3aWxsIHRha2UgY2FyZSBvZiBpdCAodW5zdWJzL3N1YnMpXG4gICAgICAgICAgICAgICAgICogSWYgdGhlIGVycm9yIGhhcHBlbnMgZHVyaW5nIGEgc3Vic2NyaXB0aW9uLCBhbmQgaXMgb25seSBldmVudHVhbCwgY2FuIGJlIGlnbm9yZWRcbiAgICAgICAgICAgICAgICAgKiBJZiB0aGUgZXJyb3IgaGFwcGVucyBkdXJpbmcgYSBzdWJzY3JpcHRpb24sIGFuZCB0aGUgc3Vic2NyaXB0aW9uIHN0b3AgcmVjZWl2aW5nIG1lc3NhZ2VzLCB0aGUgdW5yZXNwb25zaXZlVGltZW91dCB3aWxsIHRha2UgY2FyZSBvZiBpdCAodW5zdWJzL3N1YnMpXG4gICAgICAgICAgICAgICAgICovXG4gICAgICAgICAgICAgICAgaWYgKHdzSGFuZGxlci5pc0Vycm9yKG1lc3NhZ2UpKSB7XG4gICAgICAgICAgICAgICAgICBjb25zdCBlcnJvciA9IHtcbiAgICAgICAgICAgICAgICAgICAgcmVhc29uOiBKU09OLnN0cmluZ2lmeShtZXNzYWdlKSxcbiAgICAgICAgICAgICAgICAgICAgY29ubmVjdGlvbkluZm86IHsga2V5OiBjb25uZWN0aW9uS2V5LCB1cmwgfSxcbiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IG1lc3NhZ2UsXG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoJ1dTOiBFcnJvcicsIGVycm9yKVxuICAgICAgICAgICAgICAgICAgZXJyb3JPYnNlcnZlci5uZXh0KFxuICAgICAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb25FcnJvcih7XG4gICAgICAgICAgICAgICAgICAgICAgLi4uZXJyb3IsXG4gICAgICAgICAgICAgICAgICAgICAgd3NIYW5kbGVyLFxuICAgICAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZVxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgIHdpdGhMYXRlc3RGcm9tKHN0YXRlJCksXG4gICAgICAgICAgICAgIG1lcmdlTWFwKChbbWVzc2FnZSwgc3RhdGVdKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgaXNBY3RpdmVTdWJzY3JpcHRpb24gPSAhIXN0YXRlLndzLnN1YnNjcmlwdGlvbnMuYWxsW3N1YnNjcmlwdGlvbktleV0/LmFjdGl2ZVxuICAgICAgICAgICAgICAgIGNvbnN0IGFjdGlvblBheWxvYWQgPSB7XG4gICAgICAgICAgICAgICAgICBtZXNzYWdlLFxuICAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uS2V5LFxuICAgICAgICAgICAgICAgICAgaW5wdXQ6IHBheWxvYWQuaW5wdXQsXG4gICAgICAgICAgICAgICAgICBjb250ZXh0OiBwYXlsb2FkLmNvbnRleHQsXG4gICAgICAgICAgICAgICAgICBjb25uZWN0aW9uSW5mbzogcGF5bG9hZC5jb25uZWN0aW9uSW5mbyxcbiAgICAgICAgICAgICAgICAgIHdzSGFuZGxlcixcbiAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY29uc3QgbGFzdFVwZGF0ZWRBdCA9IHN0YXRlLndzLnN1YnNjcmlwdGlvbnMuYWxsW3N1YnNjcmlwdGlvbktleV0/Lmxhc3RVcGRhdGVkQXRcbiAgICAgICAgICAgICAgICBjb25zdCBkZWZhdWx0TWluVGltZVRvTmV4dFVwZGF0ZUluUyA9IHV0aWwuZ2V0RW52KFxuICAgICAgICAgICAgICAgICAgJ1dTX1RJTUVfVU5USUxfSEFORExFX05FWFRfTUVTU0FHRV9PVkVSUklERScsXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIGNvbnN0IHRpbWVUb05leHRIYW5kbGUgPSBkZWZhdWx0TWluVGltZVRvTmV4dFVwZGF0ZUluU1xuICAgICAgICAgICAgICAgICAgPyBwYXJzZUludChkZWZhdWx0TWluVGltZVRvTmV4dFVwZGF0ZUluUylcbiAgICAgICAgICAgICAgICAgIDogd3NIYW5kbGVyLm1pblRpbWVUb05leHRNZXNzYWdlVXBkYXRlSW5TXG4gICAgICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgICAgdGltZVRvTmV4dEhhbmRsZSAmJlxuICAgICAgICAgICAgICAgICAgISFsYXN0VXBkYXRlZEF0ICYmXG4gICAgICAgICAgICAgICAgICBEYXRlLm5vdygpIC0gbGFzdFVwZGF0ZWRBdCA8IHRpbWVUb05leHRIYW5kbGUgKiAxMDAwXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgcmV0dXJuIEVNUFRZXG4gICAgICAgICAgICAgICAgaWYgKCFpc0FjdGl2ZVN1YnNjcmlwdGlvbikge1xuICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oJ1dTOiBTdWJzY3JpYmVkJywgc3Vic2NyaXB0aW9uTWV0YShwYXlsb2FkKSlcbiAgICAgICAgICAgICAgICAgIHJldHVybiBvZihzdWJzY3JpYmVGdWxmaWxsZWQocGF5bG9hZCksIG1lc3NhZ2VSZWNlaXZlZChhY3Rpb25QYXlsb2FkKSlcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gb2YobWVzc2FnZVJlY2VpdmVkKGFjdGlvblBheWxvYWQpKVxuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgdGFrZVVudGlsKFxuICAgICAgICAgICAgICAgIG1lcmdlKFxuICAgICAgICAgICAgICAgICAgYWN0aW9uJC5waXBlKFxuICAgICAgICAgICAgICAgICAgICBmaWx0ZXIodW5zdWJzY3JpYmVSZXF1ZXN0ZWQubWF0Y2gpLFxuICAgICAgICAgICAgICAgICAgICBmaWx0ZXIoKGEpID0+IGdldFN1YnNJZChhLnBheWxvYWQuc3Vic2NyaXB0aW9uTXNnKSA9PT0gc3Vic2NyaXB0aW9uS2V5KSxcbiAgICAgICAgICAgICAgICAgICAgdGFwKChhKSA9PiBsb2dnZXIuaW5mbygnV1M6IFVuc3Vic2NyaWJlZCcsIHN1YnNjcmlwdGlvbk1ldGEoYS5wYXlsb2FkKSkpLFxuICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgIGFjdGlvbiQucGlwZShcbiAgICAgICAgICAgICAgICAgICAgZmlsdGVyKGRpc2Nvbm5lY3RGdWxmaWxsZWQubWF0Y2gpLFxuICAgICAgICAgICAgICAgICAgICBmaWx0ZXIoKGEpID0+IGEucGF5bG9hZC5jb25maWcuY29ubmVjdGlvbkluZm8ua2V5ID09PSBjb25uZWN0aW9uS2V5KSxcbiAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICBhY3Rpb24kLnBpcGUoZmlsdGVyKFdTUmVzZXQubWF0Y2gpKSxcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICBlbmRXaXRoKHVuc3Vic2NyaWJlRnVsZmlsbGVkKHBheWxvYWQpKSxcbiAgICAgICAgICAgICksXG4gICAgICAgICksXG4gICAgICAgIGNhdGNoRXJyb3IoKGUpID0+IHtcbiAgICAgICAgICBsb2dnZXIuZXJyb3IoZSlcbiAgICAgICAgICByZXR1cm4gb2YoXG4gICAgICAgICAgICBjb25uZWN0RmFpbGVkKHsgY29ubmVjdGlvbkluZm86IHsga2V5OiBjb25uZWN0aW9uS2V5LCB1cmwgfSwgcmVhc29uOiBlLm1lc3NhZ2UgfSksXG4gICAgICAgICAgKVxuICAgICAgICB9KSxcbiAgICAgIClcblxuICAgICAgY29uc3Qgd2l0aEhlYXJ0YmVhdEF0SW50ZXJ2YWxzJCA9IGFjdGlvbiQucGlwZShcbiAgICAgICAgZmlsdGVyKChhY3Rpb24pID0+IHtcbiAgICAgICAgICByZXR1cm4gY29ubmVjdEZ1bGZpbGxlZC5tYXRjaChhY3Rpb24pICYmICEhd3NIYW5kbGVyLmhlYXJ0YmVhdE1lc3NhZ2VcbiAgICAgICAgfSksXG4gICAgICAgIHdpdGhMYXRlc3RGcm9tKHN0YXRlJCksXG4gICAgICAgIGZpbHRlcigoW2FjdGlvbiwgc3RhdGVdKSA9PiB7XG4gICAgICAgICAgY29uc3QgY29ubmVjdGlvbktleSA9IGFjdGlvbi5wYXlsb2FkLmNvbm5lY3Rpb25JbmZvLmtleVxuICAgICAgICAgIGNvbnN0IGNvbm5lY3Rpb25TdGF0ZSA9IHN0YXRlLndzLmNvbm5lY3Rpb25zLmFsbFtjb25uZWN0aW9uS2V5XVxuICAgICAgICAgIHJldHVybiAhIWNvbm5lY3Rpb25TdGF0ZSAmJiBjb25uZWN0aW9uU3RhdGUuYWN0aXZlXG4gICAgICAgIH0pLFxuICAgICAgICBtZXJnZU1hcCgoW2FjdGlvbiwgc3RhdGVdKSA9PiB7XG4gICAgICAgICAgY29uc3QgY29ubmVjdGlvbktleSA9IGFjdGlvbi5wYXlsb2FkLmNvbm5lY3Rpb25JbmZvLmtleVxuICAgICAgICAgIGNvbnN0IGNvbm5lY3Rpb25TdGF0ZSA9IHN0YXRlLndzLmNvbm5lY3Rpb25zLmFsbFtjb25uZWN0aW9uS2V5XVxuICAgICAgICAgIGNvbnN0IGludGVydmFsID0gd3NIYW5kbGVyLmhlYXJ0YmVhdEludGVydmFsSW5NUyB8fCBjb25maWcuZGVmYXVsdEhlYXJ0YmVhdEludGVydmFsSW5NU1xuICAgICAgICAgIHJldHVybiB0aW1lcihpbnRlcnZhbCwgaW50ZXJ2YWwpLnBpcGUoXG4gICAgICAgICAgICB0YXAoKCkgPT4gbG9nZ2VyLmRlYnVnKCdTZW5kaW5nIGhlYXJ0YmVhdCBtZXNzYWdlJykpLFxuICAgICAgICAgICAgbWVyZ2VNYXAoKCkgPT4ge1xuICAgICAgICAgICAgICBpZiAod3NIYW5kbGVyLmhlYXJ0YmVhdE1lc3NhZ2UpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBoZWFydGJlYXRQYXlsb2FkID0gd3NIYW5kbGVyLmhlYXJ0YmVhdE1lc3NhZ2UoXG4gICAgICAgICAgICAgICAgICBjb25uZWN0aW9uU3RhdGUucmVxdWVzdElkLFxuICAgICAgICAgICAgICAgICAgY29ubmVjdGlvblN0YXRlLmNvbm5lY3Rpb25QYXJhbXMsXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIHdzU3ViamVjdC5uZXh0KGhlYXJ0YmVhdFBheWxvYWQpXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgcmV0dXJuIEVNUFRZXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIHRha2VVbnRpbChcbiAgICAgICAgICAgICAgbWVyZ2UoXG4gICAgICAgICAgICAgICAgYWN0aW9uJC5waXBlKFxuICAgICAgICAgICAgICAgICAgZmlsdGVyKGRpc2Nvbm5lY3RGdWxmaWxsZWQubWF0Y2gpLFxuICAgICAgICAgICAgICAgICAgZmlsdGVyKChhY3Rpb24pID0+IGFjdGlvbi5wYXlsb2FkLmNvbmZpZy5jb25uZWN0aW9uSW5mby5rZXkgPT09IGNvbm5lY3Rpb25LZXkpLFxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgYWN0aW9uJC5waXBlKGZpbHRlcihXU1Jlc2V0Lm1hdGNoKSksXG4gICAgICAgICAgICAgICksXG4gICAgICAgICAgICApLFxuICAgICAgICAgIClcbiAgICAgICAgfSksXG4gICAgICApXG5cbiAgICAgIC8vIEFsbCByZWNlaXZlZCBtZXNzYWdlcyB1c2luZyB0aGUgc2FtZSBjb25uZWN0aW9uIGtleVxuICAgICAgY29uc3QgbWVzc2FnZSQgPSBhY3Rpb24kLnBpcGUoXG4gICAgICAgIGZpbHRlcihtZXNzYWdlUmVjZWl2ZWQubWF0Y2gpLFxuICAgICAgICBmaWx0ZXIoKGFjdGlvbikgPT4gYWN0aW9uLnBheWxvYWQuY29ubmVjdGlvbkluZm8ua2V5ID09PSBjb25uZWN0aW9uS2V5KSxcbiAgICAgIClcblxuICAgICAgY29uc3Qgd2l0aENvbnRpbnVlT25Db25uZWN0Q2hhaW4kID0gbWVzc2FnZSQucGlwZShcbiAgICAgICAgd2l0aExhdGVzdEZyb20oc3RhdGUkKSxcbiAgICAgICAgZmlsdGVyKChbYWN0aW9uLCBzdGF0ZV0pID0+IHtcbiAgICAgICAgICBjb25zdCBrZXkgPSBhY3Rpb24ucGF5bG9hZC5jb25uZWN0aW9uSW5mby5rZXlcbiAgICAgICAgICBjb25zdCBjb25uZWN0aW9uU3RhdGUgPSBzdGF0ZS53cy5jb25uZWN0aW9ucy5hbGxba2V5XVxuICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAhIWNvbm5lY3Rpb25TdGF0ZSAmJlxuICAgICAgICAgICAgISF3c0hhbmRsZXIub25Db25uZWN0Q2hhaW4gJiZcbiAgICAgICAgICAgIGNvbm5lY3Rpb25TdGF0ZS5yZXF1ZXN0SWQgPD0gd3NIYW5kbGVyLm9uQ29ubmVjdENoYWluLmxlbmd0aFxuICAgICAgICAgIClcbiAgICAgICAgfSksXG4gICAgICAgIG1lcmdlTWFwKChbeyBwYXlsb2FkIH0sIHN0YXRlXSkgPT4ge1xuICAgICAgICAgIGNvbnN0IHsgaW5wdXQsIGNvbnRleHQsIG1lc3NhZ2UgfSA9IHBheWxvYWRcbiAgICAgICAgICBjb25zdCBvbkNvbm5lY3RJZHggPSBzdGF0ZS53cy5jb25uZWN0aW9ucy5hbGxbcGF5bG9hZC5jb25uZWN0aW9uSW5mby5rZXldXG4gICAgICAgICAgICA/IHN0YXRlLndzLmNvbm5lY3Rpb25zLmFsbFtwYXlsb2FkLmNvbm5lY3Rpb25JbmZvLmtleV0ucmVxdWVzdElkXG4gICAgICAgICAgICA6IDBcbiAgICAgICAgICBpZiAoIXdzSGFuZGxlci5vbkNvbm5lY3RDaGFpbiB8fCBvbkNvbm5lY3RJZHggPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgcmV0dXJuIEVNUFRZXG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnN0IG9uQ29ubmVjdENoYWluRmluaXNoZWQgPSBvbkNvbm5lY3RJZHggPj0gd3NIYW5kbGVyLm9uQ29ubmVjdENoYWluLmxlbmd0aFxuICAgICAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbk1zZyA9IG9uQ29ubmVjdENoYWluRmluaXNoZWRcbiAgICAgICAgICAgID8gd3NIYW5kbGVyLnN1YnNjcmliZShpbnB1dClcbiAgICAgICAgICAgIDogd3NIYW5kbGVyLm9uQ29ubmVjdENoYWluW29uQ29ubmVjdElkeF0ucGF5bG9hZFxuICAgICAgICAgIGNvbnN0IHN1YnNjcmlwdGlvblBheWxvYWQ6IFdTU3Vic2NyaXB0aW9uUGF5bG9hZCA9IHtcbiAgICAgICAgICAgIGNvbm5lY3Rpb25JbmZvOiB7XG4gICAgICAgICAgICAgIGtleTogY29uZmlnLmNvbm5lY3Rpb25JbmZvLmtleSxcbiAgICAgICAgICAgICAgdXJsOiB3c0hhbmRsZXIuY29ubmVjdGlvbi51cmwsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgc3Vic2NyaXB0aW9uTXNnLFxuICAgICAgICAgICAgaW5wdXQsXG4gICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgbWVzc2FnZVRvU2F2ZTpcbiAgICAgICAgICAgICAgd3NIYW5kbGVyLnNob3VsZFNhdmVUb0Nvbm5lY3Rpb24gJiZcbiAgICAgICAgICAgICAgd3NIYW5kbGVyLnNob3VsZFNhdmVUb0Nvbm5lY3Rpb24obWVzc2FnZSkgJiZcbiAgICAgICAgICAgICAgd3NIYW5kbGVyLnNhdmVPbkNvbm5lY3RUb0Nvbm5lY3Rpb25cbiAgICAgICAgICAgICAgICA/IHdzSGFuZGxlci5zYXZlT25Db25uZWN0VG9Db25uZWN0aW9uKG1lc3NhZ2UpXG4gICAgICAgICAgICAgICAgOiBudWxsLFxuICAgICAgICAgICAgZmlsdGVyTXVsdGlwbGV4OiBvbkNvbm5lY3RDaGFpbkZpbmlzaGVkXG4gICAgICAgICAgICAgID8gdW5kZWZpbmVkXG4gICAgICAgICAgICAgIDogd3NIYW5kbGVyLm9uQ29ubmVjdENoYWluW29uQ29ubmVjdElkeF0uZmlsdGVyLFxuICAgICAgICAgICAgc2hvdWxkTmV2ZXJVbnN1YnNjcmliZTogb25Db25uZWN0Q2hhaW5GaW5pc2hlZFxuICAgICAgICAgICAgICA/IGZhbHNlXG4gICAgICAgICAgICAgIDogd3NIYW5kbGVyLm9uQ29ubmVjdENoYWluW29uQ29ubmVjdElkeF0uc2hvdWxkTmV2ZXJVbnN1YnNjcmliZSxcbiAgICAgICAgICB9XG4gICAgICAgICAgY29uc3Qgc3Vic2NyaWJlUmVxdWVzdGVkQWN0aW9uID0gc3Vic2NyaWJlUmVxdWVzdGVkKHN1YnNjcmlwdGlvblBheWxvYWQpXG4gICAgICAgICAgaWYgKG9uQ29ubmVjdENoYWluRmluaXNoZWQpIHtcbiAgICAgICAgICAgIHJldHVybiBvZihzdWJzY3JpYmVSZXF1ZXN0ZWRBY3Rpb24sIG9uQ29ubmVjdENvbXBsZXRlKHN1YnNjcmlwdGlvblBheWxvYWQpKVxuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gb2Yoc3Vic2NyaWJlUmVxdWVzdGVkQWN0aW9uKVxuICAgICAgICB9KSxcbiAgICAgIClcblxuICAgICAgY29uc3Qgd2l0aFNhdmVGaXJzdE1lc3NhZ2VUb1N0b3JlJCA9IG1lc3NhZ2UkLnBpcGUoXG4gICAgICAgIGZpbHRlcigoKSA9PiB7XG4gICAgICAgICAgcmV0dXJuICEhd3NIYW5kbGVyLnRvU2F2ZUZyb21GaXJzdE1lc3NhZ2VcbiAgICAgICAgfSksXG4gICAgICAgIHdpdGhMYXRlc3RGcm9tKHN0YXRlJCksXG4gICAgICAgIGZpbHRlcigoW2FjdGlvbiwgc3RhdGVdKSA9PiB7XG4gICAgICAgICAgY29uc3Qga2V5ID0gYWN0aW9uLnBheWxvYWQuc3Vic2NyaXB0aW9uS2V5XG4gICAgICAgICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gc3RhdGUud3Muc3Vic2NyaXB0aW9ucy5hbGxba2V5XVxuICAgICAgICAgIHJldHVybiBzdWJzY3JpcHRpb24gJiYgIXN1YnNjcmlwdGlvbi5zdWJzY3JpcHRpb25QYXJhbXNcbiAgICAgICAgfSksXG4gICAgICAgIG1lcmdlTWFwKChbYWN0aW9uXSkgPT4ge1xuICAgICAgICAgIGNvbnN0IHRvU2F2ZSA9XG4gICAgICAgICAgICB3c0hhbmRsZXIudG9TYXZlRnJvbUZpcnN0TWVzc2FnZSAmJlxuICAgICAgICAgICAgd3NIYW5kbGVyLnRvU2F2ZUZyb21GaXJzdE1lc3NhZ2UoYWN0aW9uLnBheWxvYWQubWVzc2FnZSlcbiAgICAgICAgICByZXR1cm4gdG9TYXZlXG4gICAgICAgICAgICA/IG9mKFxuICAgICAgICAgICAgICAgIHNhdmVGaXJzdE1lc3NhZ2VSZWNlaXZlZCh7XG4gICAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb25LZXk6IGFjdGlvbi5wYXlsb2FkLnN1YnNjcmlwdGlvbktleSxcbiAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IHRvU2F2ZSxcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgOiBFTVBUWVxuICAgICAgICB9KSxcbiAgICAgIClcblxuICAgICAgY29uc3QgcmVzcG9uZFdpdGhIZWFydGJlYXQkID0gbWVzc2FnZSQucGlwZShcbiAgICAgICAgZmlsdGVyKFxuICAgICAgICAgIChhY3Rpb24pID0+XG4gICAgICAgICAgICAhIXdzSGFuZGxlci5zaG91bGRSZXBseVRvU2VydmVySGVhcnRiZWF0ICYmXG4gICAgICAgICAgICB3c0hhbmRsZXIuc2hvdWxkUmVwbHlUb1NlcnZlckhlYXJ0YmVhdChhY3Rpb24ucGF5bG9hZC5tZXNzYWdlKSxcbiAgICAgICAgKSxcbiAgICAgICAgd2l0aExhdGVzdEZyb20oc3RhdGUkKSxcbiAgICAgICAgbWVyZ2VNYXAoKFthY3Rpb24sIHN0YXRlXSkgPT4ge1xuICAgICAgICAgIGNvbnN0IHsgY29ubmVjdGlvbkluZm8sIG1lc3NhZ2UgfSA9IGFjdGlvbi5wYXlsb2FkXG4gICAgICAgICAgY29uc3Qga2V5ID0gY29ubmVjdGlvbkluZm8ua2V5XG4gICAgICAgICAgY29uc3QgeyByZXF1ZXN0SWQsIGNvbm5lY3Rpb25QYXJhbXMgfSA9IHN0YXRlLndzLmNvbm5lY3Rpb25zLmFsbFtrZXldXG4gICAgICAgICAgaWYgKHdzSGFuZGxlci5oZWFydGJlYXRSZXBseU1lc3NhZ2UpIHtcbiAgICAgICAgICAgIGNvbnN0IGhlYXJ0YmVhdE1lc3NhZ2UgPSB3c0hhbmRsZXIuaGVhcnRiZWF0UmVwbHlNZXNzYWdlKFxuICAgICAgICAgICAgICBtZXNzYWdlLFxuICAgICAgICAgICAgICByZXF1ZXN0SWQsXG4gICAgICAgICAgICAgIGNvbm5lY3Rpb25QYXJhbXMsXG4gICAgICAgICAgICApXG4gICAgICAgICAgICBsb2dnZXIuZGVidWcoJ1Jlc3BvbmRpbmcgd2l0aCBoZWFydGJlYXQgcGF5bG9hZCcsIGhlYXJ0YmVhdE1lc3NhZ2UpXG4gICAgICAgICAgICB3c1N1YmplY3QubmV4dChoZWFydGJlYXRNZXNzYWdlKVxuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gb2YoYWN0aW9uKVxuICAgICAgICB9KSxcbiAgICAgICAgZmlsdGVyKCgpID0+IGZhbHNlKSxcbiAgICAgIClcblxuICAgICAgLy8gT25jZSBhIHJlcXVlc3QgaGFwcGVucywgYSBzdWJzY3JpcHRpb24gdGltZW91dCBzdGFydHMuIElmIG5vIG1vcmUgcmVxdWVzdHMgYXNrIGZvclxuICAgICAgLy8gdGhpcyBzdWJzY3JpcHRpb24gYmVmb3JlIHRoZSB0aW1lIHJ1bnMgb3V0LCBpdCB3aWxsIGJlIHVuc3Vic2NyaWJlZFxuICAgICAgY29uc3QgdW5zdWJzY3JpYmVPblRpbWVvdXQkID0gc3Vic2NyaXB0aW9ucyQucGlwZShcbiAgICAgICAgZmlsdGVyKChhY3Rpb24pID0+ICFhY3Rpb24ucGF5bG9hZC5zaG91bGROZXZlclVuc3Vic2NyaWJlKSxcbiAgICAgICAgLy8gd2hlbiBhIHN1YnNjcmlwdGlvbiBjb21lcyBpblxuICAgICAgICAvLyBUT0RPOiB3ZSBuZWVkIHRvIGZpbHRlciBkdXBsaWNhdGVkIHN1YnNjcmlwdGlvbnMgaGVyZVxuICAgICAgICBtZXJnZU1hcCgoeyBwYXlsb2FkIH0pID0+IHtcbiAgICAgICAgICBjb25zdCBzdWJzY3JpcHRpb25LZXkgPSBnZXRTdWJzSWQocGF5bG9hZC5zdWJzY3JpcHRpb25Nc2cpXG4gICAgICAgICAgLy8gd2UgbG9vayBmb3IgbWF0Y2hpbmcgc3Vic2NyaXB0aW9ucyBvZiB0aGUgc2FtZSB0eXBlXG4gICAgICAgICAgLy8gd2hpY2ggZGVhY3RpdmF0ZXMgdGhlIGN1cnJlbnQgdGltZXJcbiAgICAgICAgICBjb25zdCByZXNldCQgPSBzdWJzY3JpcHRpb25zJC5waXBlKFxuICAgICAgICAgICAgZmlsdGVyKCh7IHBheWxvYWQgfSkgPT4gc3Vic2NyaXB0aW9uS2V5ID09PSBnZXRTdWJzSWQocGF5bG9hZC5zdWJzY3JpcHRpb25Nc2cpKSxcbiAgICAgICAgICAgIHRha2UoMSksXG4gICAgICAgICAgKVxuICAgICAgICAgIC8vIHN0YXJ0IHRoZSBjdXJyZW50IHVuc3Vic2NyaXB0aW9uIHRpbWVyXG4gICAgICAgICAgY29uc3QgdGltZW91dCQgPSBvZih1bnN1YnNjcmliZVJlcXVlc3RlZCh7IC4uLnBheWxvYWQgfSkpLnBpcGUoXG4gICAgICAgICAgICBkZWxheShjb25maWcuc3Vic2NyaXB0aW9uVFRMKSxcbiAgICAgICAgICAgIHRhcCgoKSA9PlxuICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoJ1dTOiB1bnN1YnNjcmliZSAoaW5hY3RpdmUgZmVlZCknLCB7IHBheWxvYWQ6IHBheWxvYWQuc3Vic2NyaXB0aW9uTXNnIH0pLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICApXG4gICAgICAgICAgLy8gaWYgYSByZS1zdWJzY3JpcHRpb24gY29tZXMgaW4gYmVmb3JlIHRpbWVvdXQgZW1pdHMsIHRoZW4gd2UgZW1pdCBub3RoaW5nXG4gICAgICAgICAgLy8gZWxzZSB3ZSB1bnN1YnNjcmliZSBmcm9tIHRoZSBjdXJyZW50IHN1YnNjcmlwdGlvblxuICAgICAgICAgIHJldHVybiByYWNlKHJlc2V0JCwgdGltZW91dCQpLnBpcGUoZmlsdGVyKChhKSA9PiAhc3Vic2NyaWJlUmVxdWVzdGVkLm1hdGNoKGEpKSlcbiAgICAgICAgfSksXG4gICAgICApXG5cbiAgICAgIGNvbnN0IHVuc3Vic2NyaWJlT25Ob1Jlc3BvbnNlJCA9IG1lc3NhZ2UkLnBpcGUoXG4gICAgICAgIHdpdGhMYXRlc3RGcm9tKHN0YXRlJCksXG4gICAgICAgIG1lcmdlTWFwKFxuICAgICAgICAgIChbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIHBheWxvYWQ6IHsgc3Vic2NyaXB0aW9uS2V5IH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgc3RhdGUsXG4gICAgICAgICAgXSkgPT4ge1xuICAgICAgICAgICAgbGV0IGlucHV0ID0gc3RhdGUud3Muc3Vic2NyaXB0aW9ucy5hbGxbc3Vic2NyaXB0aW9uS2V5XT8uaW5wdXRcbiAgICAgICAgICAgIGlmICghaW5wdXQpIHtcbiAgICAgICAgICAgICAgbG9nZ2VyLndhcm4oYFdTOiBDb3VsZCBub3QgZmluZCBzdWJzY3JpcHRpb24gZnJvbSBpbmNvbWluZyBtZXNzYWdlYClcbiAgICAgICAgICAgICAgaW5wdXQgPSB7fSBhcyBBZGFwdGVyUmVxdWVzdFxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCByZXNldCQgPSBtZXNzYWdlJC5waXBlKFxuICAgICAgICAgICAgICBmaWx0ZXIoKHsgcGF5bG9hZCB9KSA9PiBzdWJzY3JpcHRpb25LZXkgPT09IHBheWxvYWQuc3Vic2NyaXB0aW9uS2V5KSxcbiAgICAgICAgICAgICAgdGFrZSgxKSxcbiAgICAgICAgICAgIClcblxuICAgICAgICAgICAgbGV0IGNvbnRleHQgPSBzdGF0ZS53cy5zdWJzY3JpcHRpb25zLmFsbFtzdWJzY3JpcHRpb25LZXldPy5jb250ZXh0XG4gICAgICAgICAgICBpZiAoIWNvbnRleHQpIHtcbiAgICAgICAgICAgICAgbG9nZ2VyLndhcm4oYFdTIFVuc3Vic2NyaWJlIE5vIFJlc3BvbnNlOiBDb3VsZCBub3QgZmluZCBjb250ZXh0YClcbiAgICAgICAgICAgICAgY29udGV4dCA9IHt9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IGFjdGlvbiA9IHtcbiAgICAgICAgICAgICAgaW5wdXQsXG4gICAgICAgICAgICAgIHN1YnNjcmlwdGlvbk1zZzogd3NIYW5kbGVyLnN1YnNjcmliZShpbnB1dCksXG4gICAgICAgICAgICAgIGNvbm5lY3Rpb25JbmZvOiB7IGtleTogY29ubmVjdGlvbktleSwgdXJsIH0sXG4gICAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IHN1YlJlcUFjdGlvbiA9IHN1YnNjcmliZVJlcXVlc3RlZChhY3Rpb24pXG5cbiAgICAgICAgICAgIGNvbnN0IHRpbWVvdXQkID0gb2YoXG4gICAgICAgICAgICAgIHN1YnNjcmlwdGlvbkVycm9yKHtcbiAgICAgICAgICAgICAgICAuLi5hY3Rpb24sXG4gICAgICAgICAgICAgICAgcmVhc29uOiAnV1M6IHVuc3Vic2NyaWJlIC0+IHN1YnNjcmliZSAodW5yZXNwb25zaXZlIGNoYW5uZWwpJyxcbiAgICAgICAgICAgICAgICB3c0hhbmRsZXIsXG4gICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICB1bnN1YnNjcmliZVJlcXVlc3RlZChhY3Rpb24pLFxuICAgICAgICAgICAgICBzdWJSZXFBY3Rpb24sXG4gICAgICAgICAgICApLnBpcGUoXG4gICAgICAgICAgICAgIGRlbGF5KGNvbmZpZy5zdWJzY3JpcHRpb25VbnJlc3BvbnNpdmVUVEwpLFxuICAgICAgICAgICAgICB0YXAoKGEpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoc3Vic2NyaXB0aW9uRXJyb3IubWF0Y2goYSkpIHtcbiAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuKFxuICAgICAgICAgICAgICAgICAgICAnW3Vuc3Vic2NyaWJlT25Ob1Jlc3BvbnNlXSBSZXN1YnNjcmliaW5nIGR1ZSB0byB1bnJlc3BvbnNpdmUgc3Vic2NyaXB0aW9uLCB0aGlzIGhhcHBlbnMgd2hlbiBhIHN1YnNjcmlwdGlvbiBkb2VzIG5vdCByZWNlaXZlIGEgbWVzc2FnZSBmb3IgbG9uZ2VyIHRoYW4gdGhlIHN1YnNjcmlwdGlvblVucmVzcG9uc2l2ZVRUTCB2YWx1ZScsXG4gICAgICAgICAgICAgICAgICAgIHsgZmVlZElkOiBhLnBheWxvYWQuaW5wdXQgPyBnZXRGZWVkSWQoYS5wYXlsb2FkLmlucHV0KSA6ICd1bmRlZmluZWQnIH0sXG4gICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgd2l0aExhdGVzdEZyb20oc3RhdGUkKSxcbiAgICAgICAgICAgICAgLy8gRmlsdGVycyBieSBhY3RpdmUgc3Vic2NyaXB0aW9uLlxuICAgICAgICAgICAgICAvLyBUaGUgdGltZW91dCBjb3VsZCB0aGluayB3ZSBkb24ndCByZWNlaXZlIG1lc3NhZ2VzIGJlY2F1c2Ugb2YgdW5yZXNwb25zaXZlbmVzcywgYW5kIGl0J3MgYWN0dWFsbHkgdW5zdWJzY3JpYmVkXG4gICAgICAgICAgICAgIC8vIGlzU3Vic2NyaWJpbmcgaXMgY29uc2lkZXJlZCB0b28gYXMgd2Ugd2FudCB0byB0cmlnZ2VyIGFuIHVuc3Vic2NyaXB0aW9uIGZyb20gYSBodW5nIGNoYW5uZWxcbiAgICAgICAgICAgICAgbWVyZ2VNYXAoKFthY3Rpb24sIHN0YXRlXSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGlzQWN0aXZlID0gISFzdGF0ZS53cy5zdWJzY3JpcHRpb25zLmFsbFtzdWJzY3JpcHRpb25LZXldPy5hY3RpdmVcbiAgICAgICAgICAgICAgICBjb25zdCBpc1N1YnNjcmliaW5nID0gISEoXG4gICAgICAgICAgICAgICAgICBzdGF0ZS53cy5zdWJzY3JpcHRpb25zLmFsbFtzdWJzY3JpcHRpb25LZXldPy5zdWJzY3JpYmluZyA+IDBcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgcmV0dXJuIGlzQWN0aXZlIHx8IGlzU3Vic2NyaWJpbmcgPyBvZihhY3Rpb24pIDogRU1QVFlcbiAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICApXG5cbiAgICAgICAgICAgIHJldHVybiByYWNlKHJlc2V0JCwgdGltZW91dCQpLnBpcGUoZmlsdGVyKChhKSA9PiAhbWVzc2FnZVJlY2VpdmVkLm1hdGNoKGEpKSlcbiAgICAgICAgICB9LFxuICAgICAgICApLFxuICAgICAgKVxuXG4gICAgICAvLyBNZXJnZSBhbGwgJiB1bnN1YnNjcmliZSB3cyBjb25uZWN0aW9uIHdoZW4gYSBtYXRjaGluZyB1bnN1YnNjcmliZSBjb21lcyBpblxuICAgICAgY29uc3QgdW5zdWJzY3JpYmUkID0gbWVyZ2UodW5zdWJzY3JpYmVPblRpbWVvdXQkLCB1bnN1YnNjcmliZU9uTm9SZXNwb25zZSQpXG4gICAgICBjb25zdCB3cyQgPSBtZXJnZShcbiAgICAgICAgb3BlbiQsXG4gICAgICAgIGNsb3NlJCxcbiAgICAgICAgZGlzY29ubmVjdCQsXG4gICAgICAgIG11bHRpcGxleFN1YnNjcmlwdGlvbnMkLFxuICAgICAgICB1bnN1YnNjcmliZSQsXG4gICAgICAgIHdpdGhTYXZlRmlyc3RNZXNzYWdlVG9TdG9yZSQsXG4gICAgICAgIHVwZGF0ZVN1YnNjcmlwdGlvbklucHV0JCxcbiAgICAgICAgd2l0aENvbnRpbnVlT25Db25uZWN0Q2hhaW4kLFxuICAgICAgICB3aXRoSGVhcnRiZWF0QXRJbnRlcnZhbHMkLFxuICAgICAgICBlcnJvciQsXG4gICAgICAgIHJlc3BvbmRXaXRoSGVhcnRiZWF0JCxcbiAgICAgICkucGlwZShcbiAgICAgICAgdGFrZVVudGlsKFxuICAgICAgICAgIG1lcmdlKFxuICAgICAgICAgICAgYWN0aW9uJC5waXBlKFxuICAgICAgICAgICAgICAvLyBUT0RPOiBub3Qgc2VlaW5nIHVuc3Vic2NyaWJlIGV2ZW50cyBiZWNhdXNlIG9mIHRoaXNcbiAgICAgICAgICAgICAgZmlsdGVyKGRpc2Nvbm5lY3RGdWxmaWxsZWQubWF0Y2gpLFxuICAgICAgICAgICAgICBmaWx0ZXIoKGEpID0+IGEucGF5bG9hZC5jb25maWcuY29ubmVjdGlvbkluZm8ua2V5ID09PSBjb25uZWN0aW9uS2V5KSxcbiAgICAgICAgICAgICAgdGFwKChhY3Rpb24pID0+IHtcbiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoJ1dTOiBEaXNjb25uZWN0ZWQgRnVsZmlsbGVkJywgY29ubmVjdGlvbk1ldGEoYWN0aW9uLnBheWxvYWQpKVxuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICksXG4gICAgICAgICAgICBhY3Rpb24kLnBpcGUoZmlsdGVyKFdTUmVzZXQubWF0Y2gpKSxcbiAgICAgICAgICApLFxuICAgICAgICApLFxuICAgICAgKVxuICAgICAgcmV0dXJuIGNvbmNhdChvZih3c1N1YnNjcmlwdGlvblJlYWR5KHBheWxvYWQpKSwgd3MkKVxuICAgIH0pLFxuICApXG5cbmV4cG9ydCBjb25zdCByZWNvcmRFcnJvckVwaWM6IEVwaWM8QW55QWN0aW9uLCBBbnlBY3Rpb24sIHsgd3M6IFJvb3RTdGF0ZSB9LCBhbnk+ID0gKGFjdGlvbiQpID0+XG4gIGFjdGlvbiQucGlwZShcbiAgICBmaWx0ZXIoKGFjdGlvbikgPT4gc3Vic2NyaXB0aW9uRXJyb3IubWF0Y2goYWN0aW9uKSAmJiAhIWFjdGlvbi5wYXlsb2FkLmVycm9yKSxcbiAgICBtZXJnZU1hcCgoeyBwYXlsb2FkIH0pID0+IHtcbiAgICAgIGNvbnN0IHsgd3NIYW5kbGVyLCBlcnJvciwgY29ubmVjdGlvbkluZm8sIHN1YnNjcmlwdGlvbk1zZywgaW5wdXQgfSA9IHBheWxvYWRcbiAgICAgIGNvbnN0IHsgc2hvdWxkTm90UmV0cnlDb25uZWN0aW9uLCBzaG91bGROb3RSZXRyeVN1YnNjcmlwdGlvbiB9ID0gd3NIYW5kbGVyXG4gICAgICByZXR1cm4gb2YoXG4gICAgICAgIHN1YnNjcmlwdGlvbkVycm9ySGFuZGxlcih7XG4gICAgICAgICAgaW5wdXQsXG4gICAgICAgICAgY29ubmVjdGlvbkluZm8sXG4gICAgICAgICAgc3Vic2NyaXB0aW9uTXNnLFxuICAgICAgICAgIHNob3VsZE5vdFJldHJ5Q29ubmVjdGlvbjogISFzaG91bGROb3RSZXRyeUNvbm5lY3Rpb24gJiYgc2hvdWxkTm90UmV0cnlDb25uZWN0aW9uKGVycm9yKSxcbiAgICAgICAgICBzaG91bGROb3RSZXRyeVN1YnNjcmlwdGlvbjpcbiAgICAgICAgICAgICEhc2hvdWxkTm90UmV0cnlTdWJzY3JpcHRpb24gJiYgc2hvdWxkTm90UmV0cnlTdWJzY3JpcHRpb24oZXJyb3IpLFxuICAgICAgICB9KSxcbiAgICAgIClcbiAgICB9KSxcbiAgKVxuXG5leHBvcnQgY29uc3Qgd3JpdGVNZXNzYWdlVG9DYWNoZUVwaWM6IEVwaWM8QW55QWN0aW9uLCBBbnlBY3Rpb24sIHsgd3M6IFJvb3RTdGF0ZSB9LCBhbnk+ID0gKFxuICBhY3Rpb24kLFxuICBzdGF0ZSQsXG4pID0+XG4gIGFjdGlvbiQucGlwZShcbiAgICBmaWx0ZXIobWVzc2FnZVJlY2VpdmVkLm1hdGNoKSxcbiAgICBmaWx0ZXIoKGFjdGlvbikgPT4gYWN0aW9uLnBheWxvYWQud3NIYW5kbGVyLmZpbHRlcihhY3Rpb24ucGF5bG9hZC5tZXNzYWdlKSksXG4gICAgd2l0aExhdGVzdEZyb20oc3RhdGUkKSxcbiAgICBtZXJnZU1hcChhc3luYyAoW2FjdGlvbiwgc3RhdGVdKSA9PiB7XG4gICAgICBjb25zdCB3c0hhbmRsZXIgPSBhY3Rpb24ucGF5bG9hZC53c0hhbmRsZXJcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHN1YnNjcmlwdGlvblN0YXRlID0gc3RhdGUud3Muc3Vic2NyaXB0aW9ucy5hbGxbYWN0aW9uLnBheWxvYWQuc3Vic2NyaXB0aW9uS2V5XVxuICAgICAgICBjb25zdCBpbnB1dCA9IHN1YnNjcmlwdGlvblN0YXRlPy5pbnB1dCB8fCB7fVxuXG4gICAgICAgIGlmICghaW5wdXQpIGxvZ2dlci53YXJuKGBXUzogQ291bGQgbm90IGZpbmQgc3Vic2NyaXB0aW9uIGZyb20gaW5jb21pbmcgbWVzc2FnZWApXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFdyYXAgdGhlIHBheWxvYWQgc28gdGhhdCB0aGUgY2FjaGUgbWlkZGxld2FyZSB0cmVhdHMgaXQgYXMgaWZcbiAgICAgICAgICogaXQgaXMgY2FsbGluZyBvdXQgdG8gdGhlIHVuZGVybHlpbmcgQVBJLCB3aGljaCBpbW1lZGlhdGVseSByZXNvbHZlc1xuICAgICAgICAgKiB0byB0aGUgd2Vic29ja2V0IG1lc3NhZ2UgaGVyZSBpbnN0ZWFkLlxuICAgICAgICAgKlxuICAgICAgICAgKiBUaGlzIHJlc3VsdHMgaW4gdGhlIGNhY2hlIG1pZGRsZXdhcmUgc3RvcmluZyB0aGUgcGF5bG9hZCBtZXNzYWdlIGFzIGFcbiAgICAgICAgICogY2FjaGUgdmFsdWUsIHdpdGggdGhlIGZvbGxvd2luZyBgd3NSZXNwb25zZWAgYXMgdGhlIGNhY2hlIGtleVxuICAgICAgICAgKi9cbiAgICAgICAgY29uc3QgaXNUb1Jlc3BvbnNlQXN5bmMgPSB3c0hhbmRsZXIudG9SZXNwb25zZS5jb25zdHJ1Y3Rvci5uYW1lID09PSAnQXN5bmNGdW5jdGlvbidcbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBpc1RvUmVzcG9uc2VBc3luY1xuICAgICAgICAgID8gYXdhaXQgd3NIYW5kbGVyLnRvUmVzcG9uc2UoYWN0aW9uLnBheWxvYWQubWVzc2FnZSwgaW5wdXQpXG4gICAgICAgICAgOiAod3NIYW5kbGVyLnRvUmVzcG9uc2UoYWN0aW9uLnBheWxvYWQubWVzc2FnZSwgaW5wdXQpIGFzIEFkYXB0ZXJSZXNwb25zZSlcbiAgICAgICAgaWYgKCFyZXNwb25zZSkgcmV0dXJuIGFjdGlvblxuICAgICAgICBjb25zdCBleGVjdXRlOiBFeGVjdXRlID0gKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHJlc3BvbnNlKVxuICAgICAgICBsZXQgY29udGV4dCA9IHN1YnNjcmlwdGlvblN0YXRlPy5jb250ZXh0XG4gICAgICAgIGlmICghY29udGV4dCkge1xuICAgICAgICAgIGxvZ2dlci53YXJuKGBXUyBVbnN1YnNjcmliZSBObyBSZXNwb25zZTogQ291bGQgbm90IGZpbmQgY29udGV4dGApXG4gICAgICAgICAgY29udGV4dCA9IHt9XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBjYWNoZSA9IGF3YWl0IHdpdGhDYWNoZSgpKGV4ZWN1dGUsIGNvbnRleHQpXG4gICAgICAgIGNvbnN0IHdzQ29uZmlnID0gZ2V0V1NDb25maWcoaW5wdXQuZGF0YT8uZW5kcG9pbnQsIGNvbnRleHQpXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIENyZWF0ZSBhbiBhZGFwdGVyIHJlcXVlc3Qgd2Ugc2VuZCB0byB0aGUgY2FjaGUgbWlkZGxld2FyZVxuICAgICAgICAgKiBzbyBpdCB1c2VzIHRoZSBmb2xsb3dpbmcgb2JqZWN0IGZvciBzZXR0aW5nIGNhY2hlIGtleXNcbiAgICAgICAgICovXG4gICAgICAgIGNvbnN0IHdzUmVzcG9uc2U6IEFkYXB0ZXJSZXF1ZXN0ID0ge1xuICAgICAgICAgIC4uLmlucHV0LFxuICAgICAgICAgIGRhdGE6IHsgbWF4QWdlOiB3c0NvbmZpZy5zdWJzY3JpcHRpb25UVEwsIC4uLmlucHV0LmRhdGEgfSxcbiAgICAgICAgICBkZWJ1ZzogeyB3czogdHJ1ZSwgLi4uaW5wdXQuZGVidWcgfSxcbiAgICAgICAgICBtZXRyaWNzTWV0YTogeyBmZWVkSWQ6IGdldEZlZWRJZChpbnB1dCkgfSxcbiAgICAgICAgfVxuICAgICAgICBhd2FpdCBjYWNoZSh3c1Jlc3BvbnNlLCBjb250ZXh0KVxuICAgICAgICBsb2dnZXIudHJhY2UoJ1dTOiBTYXZlZCByZXN1bHQnLCB7IGlucHV0LCByZXN1bHQ6IHJlc3BvbnNlLnJlc3VsdCB9KVxuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2dnZXIuZXJyb3IoYFdTOiBDYWNoZSBlcnJvcjogJHtlLm1lc3NhZ2V9YClcbiAgICAgIH1cbiAgICAgIHJldHVybiBhY3Rpb25cbiAgICB9KSxcbiAgICBmaWx0ZXIoKCkgPT4gZmFsc2UpLFxuICApXG5cbmV4cG9ydCBjb25zdCBtZXRyaWNzRXBpYzogRXBpYzxBbnlBY3Rpb24sIEFueUFjdGlvbiwgYW55LCBhbnk+ID0gKGFjdGlvbiQsIHN0YXRlJCkgPT5cbiAgYWN0aW9uJC5waXBlKFxuICAgIHdpdGhMYXRlc3RGcm9tKHN0YXRlJCksXG4gICAgdGFwKChbYWN0aW9uLCBzdGF0ZV0pID0+IHtcbiAgICAgIGNvbnN0IGNvbm5lY3Rpb25MYWJlbHMgPSAocGF5bG9hZDogV1NDb25maWdQYXlsb2FkKSA9PiAoe1xuICAgICAgICBrZXk6IHBheWxvYWQuY29uZmlnLmNvbm5lY3Rpb25JbmZvLmtleSxcbiAgICAgIH0pXG4gICAgICBjb25zdCBjb25uZWN0aW9uRXJyb3JMYWJlbHMgPSAocGF5bG9hZDogV1NFcnJvclBheWxvYWQpID0+ICh7XG4gICAgICAgIGtleTogcGF5bG9hZC5jb25uZWN0aW9uSW5mby5rZXksXG4gICAgICAgIG1lc3NhZ2U6IHBheWxvYWQucmVhc29uLFxuICAgICAgfSlcbiAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbkxhYmVscyA9IChwYXlsb2FkOiBXU1N1YnNjcmlwdGlvblBheWxvYWQpID0+ICh7XG4gICAgICAgIGNvbm5lY3Rpb25fa2V5OiBwYXlsb2FkLmNvbm5lY3Rpb25JbmZvLmtleSxcbiAgICAgICAgZmVlZF9pZDogZ2V0RmVlZElkKHsgLi4ucGF5bG9hZC5pbnB1dCB9KSxcbiAgICAgICAgc3Vic2NyaXB0aW9uX2tleTogZ2V0U3Vic0lkKHBheWxvYWQuc3Vic2NyaXB0aW9uTXNnKSxcbiAgICAgIH0pXG4gICAgICBjb25zdCBzdWJzY3JpcHRpb25FcnJvckxhYmVscyA9IChwYXlsb2FkOiBXU1N1YnNjcmlwdGlvbkVycm9yUGF5bG9hZCkgPT4gKHtcbiAgICAgICAgY29ubmVjdGlvbl9rZXk6IHBheWxvYWQuY29ubmVjdGlvbkluZm8ua2V5LFxuICAgICAgICBmZWVkX2lkOiBwYXlsb2FkLmlucHV0ID8gZ2V0RmVlZElkKHsgLi4ucGF5bG9hZC5pbnB1dCB9KSA6ICdOL0EnLFxuICAgICAgICBtZXNzYWdlOiBwYXlsb2FkLnJlYXNvbixcbiAgICAgICAgc3Vic2NyaXB0aW9uX2tleTogcGF5bG9hZC5zdWJzY3JpcHRpb25Nc2cgPyBnZXRTdWJzSWQocGF5bG9hZC5zdWJzY3JpcHRpb25Nc2cpIDogJ04vQScsXG4gICAgICB9KVxuICAgICAgY29uc3QgbWVzc2FnZUxhYmVscyA9IChwYXlsb2FkOiBXU01lc3NhZ2VQYXlsb2FkKSA9PiAoe1xuICAgICAgICBmZWVkX2lkOiBnZXRGZWVkSWQoe1xuICAgICAgICAgIC4uLnN0YXRlLndzLnN1YnNjcmlwdGlvbnMuYWxsW2FjdGlvbi5wYXlsb2FkLnN1YnNjcmlwdGlvbktleV0/LmlucHV0LFxuICAgICAgICB9KSxcbiAgICAgICAgc3Vic2NyaXB0aW9uX2tleTogcGF5bG9hZC5zdWJzY3JpcHRpb25LZXksXG4gICAgICB9KVxuXG4gICAgICBzd2l0Y2ggKGFjdGlvbi50eXBlKSB7XG4gICAgICAgIGNhc2UgY29ubmVjdEZ1bGZpbGxlZC50eXBlOlxuICAgICAgICAgIHdzX2Nvbm5lY3Rpb25fYWN0aXZlLmxhYmVscyhjb25uZWN0aW9uTGFiZWxzKGFjdGlvbi5wYXlsb2FkKSkuaW5jKClcbiAgICAgICAgICBicmVha1xuICAgICAgICBjYXNlIGNvbm5lY3RGYWlsZWQudHlwZTpcbiAgICAgICAgICB3c19jb25uZWN0aW9uX2Vycm9ycy5sYWJlbHMoY29ubmVjdGlvbkVycm9yTGFiZWxzKGFjdGlvbi5wYXlsb2FkKSkuaW5jKClcbiAgICAgICAgICBicmVha1xuICAgICAgICBjYXNlIGRpc2Nvbm5lY3RGdWxmaWxsZWQudHlwZTpcbiAgICAgICAgICBpZiAoc3RhdGUud3MuY29ubmVjdGlvbnMuYWxsW2Nvbm5lY3Rpb25MYWJlbHMoYWN0aW9uLnBheWxvYWQpLmtleV0/Lndhc0V2ZXJDb25uZWN0ZWQpIHtcbiAgICAgICAgICAgIHdzX2Nvbm5lY3Rpb25fYWN0aXZlLmxhYmVscyhjb25uZWN0aW9uTGFiZWxzKGFjdGlvbi5wYXlsb2FkKSkuZGVjKClcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgY2FzZSBzdWJzY3JpYmVGdWxmaWxsZWQudHlwZTpcbiAgICAgICAgICB3c19zdWJzY3JpcHRpb25fdG90YWwubGFiZWxzKHN1YnNjcmlwdGlvbkxhYmVscyhhY3Rpb24ucGF5bG9hZCkpLmluYygpXG4gICAgICAgICAgd3Nfc3Vic2NyaXB0aW9uX2FjdGl2ZS5sYWJlbHMoc3Vic2NyaXB0aW9uTGFiZWxzKGFjdGlvbi5wYXlsb2FkKSkuaW5jKClcbiAgICAgICAgICBicmVha1xuICAgICAgICBjYXNlIHN1YnNjcmlwdGlvbkVycm9yLnR5cGU6XG4gICAgICAgICAgd3Nfc3Vic2NyaXB0aW9uX2Vycm9ycy5sYWJlbHMoc3Vic2NyaXB0aW9uRXJyb3JMYWJlbHMoYWN0aW9uLnBheWxvYWQpKS5pbmMoKVxuICAgICAgICAgIGJyZWFrXG4gICAgICAgIGNhc2UgdW5zdWJzY3JpYmVGdWxmaWxsZWQudHlwZToge1xuICAgICAgICAgIGNvbnN0IGtleSA9IGdldFN1YnNJZChhY3Rpb24ucGF5bG9hZC5zdWJzY3JpcHRpb25Nc2cpXG4gICAgICAgICAgaWYgKHN0YXRlLndzLnN1YnNjcmlwdGlvbnMuYWxsW2tleV0/Lndhc0V2ZXJBY3RpdmUpIHtcbiAgICAgICAgICAgIHdzX3N1YnNjcmlwdGlvbl9hY3RpdmUubGFiZWxzKHN1YnNjcmlwdGlvbkxhYmVscyhhY3Rpb24ucGF5bG9hZCkpLmRlYygpXG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrXG4gICAgICAgIH1cbiAgICAgICAgY2FzZSBtZXNzYWdlUmVjZWl2ZWQudHlwZTpcbiAgICAgICAgICB3c19tZXNzYWdlX3RvdGFsLmxhYmVscyhtZXNzYWdlTGFiZWxzKGFjdGlvbi5wYXlsb2FkKSkuaW5jKClcbiAgICAgICAgICBicmVha1xuICAgICAgfVxuICAgIH0pLFxuICAgIG1hcCgoW2FjdGlvbl0pID0+IGFjdGlvbiksXG4gICAgZmlsdGVyKCgpID0+IGZhbHNlKSwgLy8gZG8gbm90IGR1cGxpY2F0ZSBldmVudHNcbiAgKVxuXG5leHBvcnQgY29uc3Qgcm9vdEVwaWMgPSBjb21iaW5lRXBpY3MoXG4gIGNvbm5lY3RFcGljLFxuICBtZXRyaWNzRXBpYyxcbiAgc3Vic2NyaWJlUmVhZHlFcGljLFxuICB3cml0ZU1lc3NhZ2VUb0NhY2hlRXBpYyxcbiAgcmVjb3JkRXJyb3JFcGljLFxuKVxuXG5leHBvcnQgY29uc3QgZXBpY01pZGRsZXdhcmUgPSBjcmVhdGVFcGljTWlkZGxld2FyZSgpXG4iXX0=