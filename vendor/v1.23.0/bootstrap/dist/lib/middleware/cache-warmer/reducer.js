"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.rootReducer = exports.warmupReducer = exports.subscriptionsReducer = void 0;
const tslib_1 = require("tslib");
const toolkit_1 = require("@reduxjs/toolkit");
const modules_1 = require("../../modules");
const actions = tslib_1.__importStar(require("./actions"));
const util_1 = require("./util");
const lodash_1 = require("lodash");
exports.subscriptionsReducer = toolkit_1.createReducer({}, (builder) => {
    builder.addCase(actions.warmupSubscribed, (state, { payload }) => {
        const key = payload.key || payload.debug?.cacheKey || util_1.getSubscriptionKey(payload);
        state[key] = {
            origin: payload.data,
            executeFn: payload.executeFn,
            startedAt: state[key]?.startedAt ?? Date.now(),
            isDuplicate: !!state[key],
            parent: payload.parent || state[key]?.parent,
            batchablePropertyPath: payload.batchablePropertyPath || state[key]?.batchablePropertyPath,
            childLastSeenById: payload?.childLastSeenById,
        };
    });
    builder.addCase(actions.warmupSubscribedMultiple, (state, { payload }) => {
        for (const member of payload.members) {
            const key = member.key || util_1.getSubscriptionKey(member);
            state[key] = {
                origin: member.data,
                executeFn: member.executeFn,
                startedAt: state[key]?.startedAt ?? Date.now(),
                isDuplicate: !!state[key],
                parent: member.parent || state[key]?.parent,
                batchablePropertyPath: member.batchablePropertyPath || state[key]?.batchablePropertyPath,
                childLastSeenById: member?.childLastSeenById,
            };
        }
    });
    builder.addCase(actions.warmupUnsubscribed, (state, action) => {
        const subscription = state[action.payload.key];
        if (subscription) {
            delete state[action.payload.key];
            if (!subscription.childLastSeenById) {
                return;
            }
            const children = Object.keys(subscription.childLastSeenById);
            for (const childKey of children) {
                delete state[childKey];
            }
        }
    });
    builder.addCase(actions.warmupJoinGroup, (state, { payload }) => {
        const batchWarmer = state[payload.parent];
        batchWarmer.childLastSeenById = {
            ...batchWarmer.childLastSeenById,
            ...payload.childLastSeenById,
        };
        for (const childKey in payload.childLastSeenById) {
            const childRequestData = state[childKey]?.origin;
            if (childRequestData) {
                // Join request data
                for (const { name } of payload.batchablePropertyPath) {
                    const uniqueBatchableValue = new Set(batchWarmer.origin[name]);
                    const singleBatchablevalue = childRequestData[name] ?? childRequestData.data?.[name];
                    if (singleBatchablevalue)
                        uniqueBatchableValue.add(singleBatchablevalue);
                    else
                        modules_1.logger.error(`[subscriptionsReducer] name=${name} not found in childRequestData`, {
                            childKey,
                            childRequestData,
                            name,
                        });
                    batchWarmer.origin[name] = [...uniqueBatchableValue];
                }
                // Join overrides
                if (batchWarmer.origin.overrides || childRequestData.overrides)
                    batchWarmer.origin.overrides = lodash_1.merge(batchWarmer.origin.overrides, childRequestData.overrides);
                if (batchWarmer.origin.tokenOverrides || childRequestData.tokenOverrides)
                    batchWarmer.origin.tokenOverrides = lodash_1.merge(batchWarmer.origin.tokenOverrides, childRequestData.tokenOverrides);
                if (batchWarmer.origin.includes || childRequestData.includes)
                    batchWarmer.origin.includes = lodash_1.uniq([
                        ...(batchWarmer.origin.includes || []),
                        ...(childRequestData.includes || []),
                    ]);
            }
        }
    });
    builder.addCase(actions.warmupLeaveGroup, (state, { payload }) => {
        const batchWarmer = state[payload.parent];
        const childIdsToRemove = Object.keys(payload.childLastSeenById);
        const remainingChildIds = Object.keys(batchWarmer.childLastSeenById || {}).filter((childId) => !childIdsToRemove.includes(childId));
        // The request data for a batch request should only contain unique values
        const requestDataWithUniqueValues = Object.fromEntries(payload.batchablePropertyPath.map(({ name }) => [name, new Set()]));
        // Rebuild the request data without the removed children's data
        const batchRequestData = remainingChildIds.reduce((acc, childId) => {
            for (const { name } of payload.batchablePropertyPath) {
                acc[name].add(state[childId].origin[name]);
            }
            return acc;
        }, requestDataWithUniqueValues);
        // Transform the sets back into arrays
        const batchableRequestData = Object.fromEntries(Object.entries(batchRequestData).map(([path, map]) => [path, [...map]]));
        // Rebuild the overrides
        const overrides = remainingChildIds.reduce((acc, childId) => {
            const childOriginData = state[childId].origin;
            if (childOriginData.overrides)
                acc.overrides = lodash_1.merge(acc.overrides || {}, childOriginData.overrides);
            if (childOriginData.tokenOverrides)
                acc.tokenOverrides = lodash_1.merge(acc.tokenOverrides || {}, childOriginData.tokenOverrides);
            if (childOriginData.includes)
                acc.includes = lodash_1.uniq([...(acc.includes || []), ...childOriginData.includes]);
            return acc;
        }, {});
        batchWarmer.origin = {
            ...batchWarmer.origin,
            ...batchableRequestData,
            ...overrides,
        };
        for (const childKey in payload.childLastSeenById) {
            if (batchWarmer?.childLastSeenById?.[childKey])
                delete batchWarmer.childLastSeenById?.[childKey];
        }
    });
});
exports.warmupReducer = toolkit_1.createReducer({}, (builder) => {
    builder.addCase(actions.warmupRequested, (state, action) => {
        if (!state[action.payload.key]) {
            modules_1.logger.info('[warmupReducer] Creating subscription', {
                warmupSubscriptionKey: action.payload.key,
            });
            state[action.payload.key] = { error: null, successCount: 0, errorCount: 0 };
        }
    });
    builder.addCase(actions.warmupFulfilled, (state, action) => {
        const { key } = action.payload;
        const subscription = state[key];
        if (!subscription) {
            modules_1.logger.error('[warmupReducer] Attempted to fulfill warmup request for a non-existing subscription', { warmupSubscriptionKey: key });
            return state;
        }
        subscription.successCount++;
        subscription.error = null;
        subscription.errorCount = 0;
        return state;
    });
    builder.addCase(actions.warmupFailed, (state, action) => {
        const { key, feedLabel: id, error } = action.payload;
        const subscription = state[key];
        if (!subscription) {
            modules_1.logger.error('[warmupReducer] Attempted to fulfill warmup request for a non-existing subscription', { warmupSubscriptionKey: key });
            return state;
        }
        modules_1.logger.error(`[${id}] Cache Warmer failed`, { error: error?.message });
        subscription.error = action.payload.error;
        subscription.errorCount++;
        subscription.successCount = 0;
        return state;
    });
    builder.addCase(actions.warmupUnsubscribed, (state, action) => {
        const { key, reason } = action.payload;
        modules_1.logger.info('[warmupReducer] Deleting subscription. ', { reason });
        delete state[key];
    });
    builder.addCase(actions.warmupShutdown, () => {
        modules_1.logger.info('[warmupReducer] Shutting down... ');
    });
    builder.addCase(actions.warmupStopped, (state, action) => {
        modules_1.logger.info('[warmupReducer] Stopping subscriptions', {
            warmupSubscriptionKey: action.payload.keys,
        });
        for (const key in action.payload.keys) {
            delete state[key];
        }
    });
});
exports.rootReducer = toolkit_1.combineReducers({
    subscriptions: exports.subscriptionsReducer,
    warmups: exports.warmupReducer,
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVkdWNlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9saWIvbWlkZGxld2FyZS9jYWNoZS13YXJtZXIvcmVkdWNlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQ0EsOENBQWlFO0FBQ2pFLDJDQUFzQztBQUN0QywyREFBb0M7QUFDcEMsaUNBQTJDO0FBQzNDLG1DQUFvQztBQWtEdkIsUUFBQSxvQkFBb0IsR0FBRyx1QkFBYSxDQUFvQixFQUFFLEVBQUUsQ0FBQyxPQUFPLEVBQUUsRUFBRTtJQUNuRixPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFLE9BQU8sRUFBRSxFQUFFLEVBQUU7UUFDL0QsTUFBTSxHQUFHLEdBQUcsT0FBTyxDQUFDLEdBQUcsSUFBSSxPQUFPLENBQUMsS0FBSyxFQUFFLFFBQVEsSUFBSSx5QkFBa0IsQ0FBQyxPQUFPLENBQUMsQ0FBQTtRQUNqRixLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUc7WUFDWCxNQUFNLEVBQUUsT0FBTyxDQUFDLElBQUk7WUFDcEIsU0FBUyxFQUFFLE9BQU8sQ0FBQyxTQUFTO1lBQzVCLFNBQVMsRUFBRSxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsU0FBUyxJQUFJLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDOUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDO1lBQ3pCLE1BQU0sRUFBRSxPQUFPLENBQUMsTUFBTSxJQUFJLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRSxNQUFNO1lBQzVDLHFCQUFxQixFQUFFLE9BQU8sQ0FBQyxxQkFBcUIsSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUscUJBQXFCO1lBQ3pGLGlCQUFpQixFQUFFLE9BQU8sRUFBRSxpQkFBaUI7U0FDOUMsQ0FBQTtJQUNILENBQUMsQ0FBQyxDQUFBO0lBRUYsT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsd0JBQXdCLEVBQUUsQ0FBQyxLQUFLLEVBQUUsRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFO1FBQ3ZFLEtBQUssTUFBTSxNQUFNLElBQUksT0FBTyxDQUFDLE9BQU8sRUFBRTtZQUNwQyxNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsR0FBRyxJQUFJLHlCQUFrQixDQUFDLE1BQU0sQ0FBQyxDQUFBO1lBQ3BELEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRztnQkFDWCxNQUFNLEVBQUUsTUFBTSxDQUFDLElBQUk7Z0JBQ25CLFNBQVMsRUFBRSxNQUFNLENBQUMsU0FBUztnQkFDM0IsU0FBUyxFQUFFLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRSxTQUFTLElBQUksSUFBSSxDQUFDLEdBQUcsRUFBRTtnQkFDOUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDO2dCQUN6QixNQUFNLEVBQUUsTUFBTSxDQUFDLE1BQU0sSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsTUFBTTtnQkFDM0MscUJBQXFCLEVBQUUsTUFBTSxDQUFDLHFCQUFxQixJQUFJLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRSxxQkFBcUI7Z0JBQ3hGLGlCQUFpQixFQUFFLE1BQU0sRUFBRSxpQkFBaUI7YUFDN0MsQ0FBQTtTQUNGO0lBQ0gsQ0FBQyxDQUFDLENBQUE7SUFFRixPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsRUFBRSxDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsRUFBRTtRQUM1RCxNQUFNLFlBQVksR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUM5QyxJQUFJLFlBQVksRUFBRTtZQUNoQixPQUFPLEtBQUssQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFBO1lBRWhDLElBQUksQ0FBQyxZQUFZLENBQUMsaUJBQWlCLEVBQUU7Z0JBQ25DLE9BQU07YUFDUDtZQUNELE1BQU0sUUFBUSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLGlCQUFpQixDQUFDLENBQUE7WUFDNUQsS0FBSyxNQUFNLFFBQVEsSUFBSSxRQUFRLEVBQUU7Z0JBQy9CLE9BQU8sS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFBO2FBQ3ZCO1NBQ0Y7SUFDSCxDQUFDLENBQUMsQ0FBQTtJQUVGLE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLGVBQWUsRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFLE9BQU8sRUFBRSxFQUFFLEVBQUU7UUFDOUQsTUFBTSxXQUFXLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUV6QyxXQUFXLENBQUMsaUJBQWlCLEdBQUc7WUFDOUIsR0FBRyxXQUFXLENBQUMsaUJBQWlCO1lBQ2hDLEdBQUcsT0FBTyxDQUFDLGlCQUFpQjtTQUM3QixDQUFBO1FBQ0QsS0FBSyxNQUFNLFFBQVEsSUFBSSxPQUFPLENBQUMsaUJBQWlCLEVBQUU7WUFDaEQsTUFBTSxnQkFBZ0IsR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDLEVBQUUsTUFBTSxDQUFBO1lBQ2hELElBQUksZ0JBQWdCLEVBQUU7Z0JBQ3BCLG9CQUFvQjtnQkFDcEIsS0FBSyxNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUksT0FBTyxDQUFDLHFCQUFxQixFQUFFO29CQUNwRCxNQUFNLG9CQUFvQixHQUFHLElBQUksR0FBRyxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQTtvQkFDOUQsTUFBTSxvQkFBb0IsR0FBRyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxnQkFBZ0IsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQTtvQkFDcEYsSUFBSSxvQkFBb0I7d0JBQUUsb0JBQW9CLENBQUMsR0FBRyxDQUFDLG9CQUFvQixDQUFDLENBQUE7O3dCQUV0RSxnQkFBTSxDQUFDLEtBQUssQ0FBQywrQkFBK0IsSUFBSSxnQ0FBZ0MsRUFBRTs0QkFDaEYsUUFBUTs0QkFDUixnQkFBZ0I7NEJBQ2hCLElBQUk7eUJBQ0wsQ0FBQyxDQUFBO29CQUNKLFdBQVcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLG9CQUFvQixDQUFDLENBQUE7aUJBQ3JEO2dCQUVELGlCQUFpQjtnQkFDakIsSUFBSSxXQUFXLENBQUMsTUFBTSxDQUFDLFNBQVMsSUFBSSxnQkFBZ0IsQ0FBQyxTQUFTO29CQUM1RCxXQUFXLENBQUMsTUFBTSxDQUFDLFNBQVMsR0FBRyxjQUFLLENBQ2xDLFdBQVcsQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUM1QixnQkFBZ0IsQ0FBQyxTQUFTLENBQzNCLENBQUE7Z0JBQ0gsSUFBSSxXQUFXLENBQUMsTUFBTSxDQUFDLGNBQWMsSUFBSSxnQkFBZ0IsQ0FBQyxjQUFjO29CQUN0RSxXQUFXLENBQUMsTUFBTSxDQUFDLGNBQWMsR0FBRyxjQUFLLENBQ3ZDLFdBQVcsQ0FBQyxNQUFNLENBQUMsY0FBYyxFQUNqQyxnQkFBZ0IsQ0FBQyxjQUFjLENBQ2hDLENBQUE7Z0JBQ0gsSUFBSSxXQUFXLENBQUMsTUFBTSxDQUFDLFFBQVEsSUFBSSxnQkFBZ0IsQ0FBQyxRQUFRO29CQUMxRCxXQUFXLENBQUMsTUFBTSxDQUFDLFFBQVEsR0FBRyxhQUFJLENBQUM7d0JBQ2pDLEdBQUcsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLFFBQVEsSUFBSSxFQUFFLENBQUM7d0JBQ3RDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLElBQUksRUFBRSxDQUFDO3FCQUNyQyxDQUFDLENBQUE7YUFDTDtTQUNGO0lBQ0gsQ0FBQyxDQUFDLENBQUE7SUFFRixPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFLE9BQU8sRUFBRSxFQUFFLEVBQUU7UUFDL0QsTUFBTSxXQUFXLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUV6QyxNQUFNLGdCQUFnQixHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUE7UUFFL0QsTUFBTSxpQkFBaUIsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxpQkFBaUIsSUFBSSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQy9FLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FDakQsQ0FBQTtRQUVELHlFQUF5RTtRQUN6RSxNQUFNLDJCQUEyQixHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQ3BELE9BQU8sQ0FBQyxxQkFBcUIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxJQUFJLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FDbkUsQ0FBQTtRQUVELCtEQUErRDtRQUMvRCxNQUFNLGdCQUFnQixHQUFHLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUUsRUFBRTtZQUNqRSxLQUFLLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxPQUFPLENBQUMscUJBQXFCLEVBQUU7Z0JBQ3BELEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFBO2FBQzNDO1lBQ0QsT0FBTyxHQUFHLENBQUE7UUFDWixDQUFDLEVBQUUsMkJBQTJCLENBQUMsQ0FBQTtRQUUvQixzQ0FBc0M7UUFDdEMsTUFBTSxvQkFBb0IsR0FBRyxNQUFNLENBQUMsV0FBVyxDQUM3QyxNQUFNLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQ3hFLENBQUE7UUFFRCx3QkFBd0I7UUFDeEIsTUFBTSxTQUFTLEdBQUcsaUJBQWlCLENBQUMsTUFBTSxDQUl2QyxDQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUUsRUFBRTtZQUNsQixNQUFNLGVBQWUsR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxDQUFBO1lBQzdDLElBQUksZUFBZSxDQUFDLFNBQVM7Z0JBQzNCLEdBQUcsQ0FBQyxTQUFTLEdBQUcsY0FBSyxDQUFDLEdBQUcsQ0FBQyxTQUFTLElBQUksRUFBRSxFQUFFLGVBQWUsQ0FBQyxTQUFTLENBQUMsQ0FBQTtZQUN2RSxJQUFJLGVBQWUsQ0FBQyxjQUFjO2dCQUNoQyxHQUFHLENBQUMsY0FBYyxHQUFHLGNBQUssQ0FBQyxHQUFHLENBQUMsY0FBYyxJQUFJLEVBQUUsRUFBRSxlQUFlLENBQUMsY0FBYyxDQUFDLENBQUE7WUFDdEYsSUFBSSxlQUFlLENBQUMsUUFBUTtnQkFDMUIsR0FBRyxDQUFDLFFBQVEsR0FBRyxhQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLFFBQVEsSUFBSSxFQUFFLENBQUMsRUFBRSxHQUFHLGVBQWUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFBO1lBQzdFLE9BQU8sR0FBRyxDQUFBO1FBQ1osQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFBO1FBRU4sV0FBVyxDQUFDLE1BQU0sR0FBRztZQUNuQixHQUFHLFdBQVcsQ0FBQyxNQUFNO1lBQ3JCLEdBQUcsb0JBQW9CO1lBQ3ZCLEdBQUcsU0FBUztTQUNiLENBQUE7UUFFRCxLQUFLLE1BQU0sUUFBUSxJQUFJLE9BQU8sQ0FBQyxpQkFBaUIsRUFBRTtZQUNoRCxJQUFJLFdBQVcsRUFBRSxpQkFBaUIsRUFBRSxDQUFDLFFBQVEsQ0FBQztnQkFDNUMsT0FBTyxXQUFXLENBQUMsaUJBQWlCLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQTtTQUNuRDtJQUNILENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQyxDQUFDLENBQUE7QUFvQlcsUUFBQSxhQUFhLEdBQUcsdUJBQWEsQ0FBZSxFQUFFLEVBQUUsQ0FBQyxPQUFPLEVBQUUsRUFBRTtJQUN2RSxPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxlQUFlLEVBQUUsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLEVBQUU7UUFDekQsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQzlCLGdCQUFNLENBQUMsSUFBSSxDQUFDLHVDQUF1QyxFQUFFO2dCQUNuRCxxQkFBcUIsRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUc7YUFDMUMsQ0FBQyxDQUFBO1lBQ0YsS0FBSyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxDQUFDLEVBQUUsVUFBVSxFQUFFLENBQUMsRUFBRSxDQUFBO1NBQzVFO0lBQ0gsQ0FBQyxDQUFDLENBQUE7SUFFRixPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxlQUFlLEVBQUUsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLEVBQUU7UUFDekQsTUFBTSxFQUFFLEdBQUcsRUFBRSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUE7UUFDOUIsTUFBTSxZQUFZLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBQy9CLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDakIsZ0JBQU0sQ0FBQyxLQUFLLENBQ1YscUZBQXFGLEVBQ3JGLEVBQUUscUJBQXFCLEVBQUUsR0FBRyxFQUFFLENBQy9CLENBQUE7WUFDRCxPQUFPLEtBQUssQ0FBQTtTQUNiO1FBQ0QsWUFBWSxDQUFDLFlBQVksRUFBRSxDQUFBO1FBQzNCLFlBQVksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFBO1FBQ3pCLFlBQVksQ0FBQyxVQUFVLEdBQUcsQ0FBQyxDQUFBO1FBQzNCLE9BQU8sS0FBSyxDQUFBO0lBQ2QsQ0FBQyxDQUFDLENBQUE7SUFFRixPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxZQUFZLEVBQUUsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLEVBQUU7UUFDdEQsTUFBTSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsRUFBRSxFQUFFLEtBQUssRUFBRSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUE7UUFDcEQsTUFBTSxZQUFZLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBQy9CLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDakIsZ0JBQU0sQ0FBQyxLQUFLLENBQ1YscUZBQXFGLEVBQ3JGLEVBQUUscUJBQXFCLEVBQUUsR0FBRyxFQUFFLENBQy9CLENBQUE7WUFDRCxPQUFPLEtBQUssQ0FBQTtTQUNiO1FBQ0QsZ0JBQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLHVCQUF1QixFQUFFLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFBO1FBQ3RFLFlBQVksQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUE7UUFDekMsWUFBWSxDQUFDLFVBQVUsRUFBRSxDQUFBO1FBQ3pCLFlBQVksQ0FBQyxZQUFZLEdBQUcsQ0FBQyxDQUFBO1FBQzdCLE9BQU8sS0FBSyxDQUFBO0lBQ2QsQ0FBQyxDQUFDLENBQUE7SUFFRixPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsRUFBRSxDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsRUFBRTtRQUM1RCxNQUFNLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUE7UUFDdEMsZ0JBQU0sQ0FBQyxJQUFJLENBQUMseUNBQXlDLEVBQUUsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFBO1FBQ2xFLE9BQU8sS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFBO0lBQ25CLENBQUMsQ0FBQyxDQUFBO0lBRUYsT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsY0FBYyxFQUFFLEdBQUcsRUFBRTtRQUMzQyxnQkFBTSxDQUFDLElBQUksQ0FBQyxtQ0FBbUMsQ0FBQyxDQUFBO0lBQ2xELENBQUMsQ0FBQyxDQUFBO0lBRUYsT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsYUFBYSxFQUFFLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxFQUFFO1FBQ3ZELGdCQUFNLENBQUMsSUFBSSxDQUFDLHdDQUF3QyxFQUFFO1lBQ3BELHFCQUFxQixFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSTtTQUMzQyxDQUFDLENBQUE7UUFDRixLQUFLLE1BQU0sR0FBRyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFO1lBQ3JDLE9BQU8sS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFBO1NBQ2xCO0lBQ0gsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDLENBQUMsQ0FBQTtBQUVXLFFBQUEsV0FBVyxHQUFHLHlCQUFlLENBQUM7SUFDekMsYUFBYSxFQUFFLDRCQUFvQjtJQUNuQyxPQUFPLEVBQUUscUJBQWE7Q0FDdkIsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWRhcHRlclJlcXVlc3QsIEV4ZWN1dGUgfSBmcm9tICdAY2hhaW5saW5rL3R5cGVzJ1xuaW1wb3J0IHsgY29tYmluZVJlZHVjZXJzLCBjcmVhdGVSZWR1Y2VyIH0gZnJvbSAnQHJlZHV4anMvdG9vbGtpdCdcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uLy4uL21vZHVsZXMnXG5pbXBvcnQgKiBhcyBhY3Rpb25zIGZyb20gJy4vYWN0aW9ucydcbmltcG9ydCB7IGdldFN1YnNjcmlwdGlvbktleSB9IGZyb20gJy4vdXRpbCdcbmltcG9ydCB7IG1lcmdlLCB1bmlxIH0gZnJvbSAnbG9kYXNoJ1xuXG5leHBvcnQgaW50ZXJmYWNlIEJhdGNoYWJsZVByb3BlcnR5IHtcbiAgbmFtZTogc3RyaW5nXG4gIGxpbWl0PzogbnVtYmVyXG59XG5cbi8qKlxuICogTWV0YWRhdGEgYWJvdXQgYSByZXF1ZXN0XG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgU3Vic2NyaXB0aW9uRGF0YSB7XG4gIC8qKlxuICAgKiBUaGUgb3JpZ2luYWwgcmVxdWVzdCBkYXRhIHRoYXQgdHJpZ2dlcmVkIHRoaXMgc3Vic2NyaXB0aW9uXG4gICAqL1xuICBvcmlnaW46IEFkYXB0ZXJSZXF1ZXN0WydkYXRhJ11cbiAgLyoqXG4gICAqIFRoZSB3cmFwcGVkIGV4ZWN1dGUgZnVuY3Rpb24gdGhhdCB3YXMgdXNlZCB0byBzZXJ2aWNlIHRoZSByZXF1ZXN0XG4gICAqL1xuICBleGVjdXRlRm46IEV4ZWN1dGVcbiAgLyoqXG4gICAqIFRoZSB0aW1lIHRoaXMgc3Vic2NyaXB0aW9uIHN0YXJ0ZWQgaW4gdW5peCB0aW1lXG4gICAqL1xuICBzdGFydGVkQXQ6IG51bWJlclxuICAvKipcbiAgICogQm9vbGVhbiB0cmlnZ2VyIHRvIHByZXZlbnQgbXVsdGlwbGUgc3Vic2NyaXB0aW9ucyBvbiB0aGUgc2FtZSBrZXlcbiAgICogV2UgbmVlZCB0aGlzIGJlY2F1c2UgY2hlY2tpbmcgc3RhdGUgZm9yIHRoaXMgd2l0aGluIGFuIGVwaWMgZG9lc250IHdvcmssXG4gICAqIHRoZSByZWR1Y2VycyBhcmUgYWx3YXlzIGV4ZWN1dGVkIGJlZm9yZSBlcGljcyBhcmVcbiAgICovXG4gIGlzRHVwbGljYXRlOiBib29sZWFuXG4gIC8qKlxuICAgKiBJZiBhIHN1YnNjcmlwdGlvbiBpcyBiZWluZyB3YXJtZWQgYnkgYSBwYXJlbnQgYmF0Y2ggcmVxdWVzdFxuICAgKiBUaGlzIHdpbGwgaG9sZCB0aGUgc3Vic2NyaXB0aW9uIGtleSBvZiB0aGUgcGFyZW50XG4gICAqL1xuICBwYXJlbnQ/OiBzdHJpbmdcbiAgLyoqXG4gICAqIElmIGEgc3Vic2NyaXB0aW9uIGlzIGJlaW5nIHdhcm1lZCBieSBhIHBhcmVudCBiYXRjaCByZXF1ZXN0XG4gICAqIFRoaXMgd2lsbCBob2xkIHRoZSBrZXkgb2YgdGhlIHJlcXVlc3QgZGF0YSB0byBqb2luXG4gICAqL1xuICBiYXRjaGFibGVQcm9wZXJ0eVBhdGg/OiBCYXRjaGFibGVQcm9wZXJ0eVtdXG4gIC8qKlxuICAgKiBJZiBhIHN1YnNjcmlwdGlvbiBpcyB3YXJtaW5nIG11bHRpcGxlIG90aGVyIHJlcXVlc3RzXG4gICAqIFRoaXMgd2lsbCBob2xkIGEgbWFwIG9mIHRoZSBzdWJzY3JpcHRpb24ga2V5IHRvIHRoZSBsYXN0IHRpbWUgaXQgd2FzIHNlZW5cbiAgICovXG4gIGNoaWxkTGFzdFNlZW5CeUlkPzogeyBbY2hpbGRLZXk6IHN0cmluZ106IG51bWJlciB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU3Vic2NyaXB0aW9uU3RhdGUge1xuICBbcmVxdWVzdEtleTogc3RyaW5nXTogU3Vic2NyaXB0aW9uRGF0YVxufVxuXG5leHBvcnQgY29uc3Qgc3Vic2NyaXB0aW9uc1JlZHVjZXIgPSBjcmVhdGVSZWR1Y2VyPFN1YnNjcmlwdGlvblN0YXRlPih7fSwgKGJ1aWxkZXIpID0+IHtcbiAgYnVpbGRlci5hZGRDYXNlKGFjdGlvbnMud2FybXVwU3Vic2NyaWJlZCwgKHN0YXRlLCB7IHBheWxvYWQgfSkgPT4ge1xuICAgIGNvbnN0IGtleSA9IHBheWxvYWQua2V5IHx8IHBheWxvYWQuZGVidWc/LmNhY2hlS2V5IHx8IGdldFN1YnNjcmlwdGlvbktleShwYXlsb2FkKVxuICAgIHN0YXRlW2tleV0gPSB7XG4gICAgICBvcmlnaW46IHBheWxvYWQuZGF0YSxcbiAgICAgIGV4ZWN1dGVGbjogcGF5bG9hZC5leGVjdXRlRm4sXG4gICAgICBzdGFydGVkQXQ6IHN0YXRlW2tleV0/LnN0YXJ0ZWRBdCA/PyBEYXRlLm5vdygpLFxuICAgICAgaXNEdXBsaWNhdGU6ICEhc3RhdGVba2V5XSxcbiAgICAgIHBhcmVudDogcGF5bG9hZC5wYXJlbnQgfHwgc3RhdGVba2V5XT8ucGFyZW50LFxuICAgICAgYmF0Y2hhYmxlUHJvcGVydHlQYXRoOiBwYXlsb2FkLmJhdGNoYWJsZVByb3BlcnR5UGF0aCB8fCBzdGF0ZVtrZXldPy5iYXRjaGFibGVQcm9wZXJ0eVBhdGgsXG4gICAgICBjaGlsZExhc3RTZWVuQnlJZDogcGF5bG9hZD8uY2hpbGRMYXN0U2VlbkJ5SWQsXG4gICAgfVxuICB9KVxuXG4gIGJ1aWxkZXIuYWRkQ2FzZShhY3Rpb25zLndhcm11cFN1YnNjcmliZWRNdWx0aXBsZSwgKHN0YXRlLCB7IHBheWxvYWQgfSkgPT4ge1xuICAgIGZvciAoY29uc3QgbWVtYmVyIG9mIHBheWxvYWQubWVtYmVycykge1xuICAgICAgY29uc3Qga2V5ID0gbWVtYmVyLmtleSB8fCBnZXRTdWJzY3JpcHRpb25LZXkobWVtYmVyKVxuICAgICAgc3RhdGVba2V5XSA9IHtcbiAgICAgICAgb3JpZ2luOiBtZW1iZXIuZGF0YSxcbiAgICAgICAgZXhlY3V0ZUZuOiBtZW1iZXIuZXhlY3V0ZUZuLFxuICAgICAgICBzdGFydGVkQXQ6IHN0YXRlW2tleV0/LnN0YXJ0ZWRBdCA/PyBEYXRlLm5vdygpLFxuICAgICAgICBpc0R1cGxpY2F0ZTogISFzdGF0ZVtrZXldLFxuICAgICAgICBwYXJlbnQ6IG1lbWJlci5wYXJlbnQgfHwgc3RhdGVba2V5XT8ucGFyZW50LFxuICAgICAgICBiYXRjaGFibGVQcm9wZXJ0eVBhdGg6IG1lbWJlci5iYXRjaGFibGVQcm9wZXJ0eVBhdGggfHwgc3RhdGVba2V5XT8uYmF0Y2hhYmxlUHJvcGVydHlQYXRoLFxuICAgICAgICBjaGlsZExhc3RTZWVuQnlJZDogbWVtYmVyPy5jaGlsZExhc3RTZWVuQnlJZCxcbiAgICAgIH1cbiAgICB9XG4gIH0pXG5cbiAgYnVpbGRlci5hZGRDYXNlKGFjdGlvbnMud2FybXVwVW5zdWJzY3JpYmVkLCAoc3RhdGUsIGFjdGlvbikgPT4ge1xuICAgIGNvbnN0IHN1YnNjcmlwdGlvbiA9IHN0YXRlW2FjdGlvbi5wYXlsb2FkLmtleV1cbiAgICBpZiAoc3Vic2NyaXB0aW9uKSB7XG4gICAgICBkZWxldGUgc3RhdGVbYWN0aW9uLnBheWxvYWQua2V5XVxuXG4gICAgICBpZiAoIXN1YnNjcmlwdGlvbi5jaGlsZExhc3RTZWVuQnlJZCkge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICAgIGNvbnN0IGNoaWxkcmVuID0gT2JqZWN0LmtleXMoc3Vic2NyaXB0aW9uLmNoaWxkTGFzdFNlZW5CeUlkKVxuICAgICAgZm9yIChjb25zdCBjaGlsZEtleSBvZiBjaGlsZHJlbikge1xuICAgICAgICBkZWxldGUgc3RhdGVbY2hpbGRLZXldXG4gICAgICB9XG4gICAgfVxuICB9KVxuXG4gIGJ1aWxkZXIuYWRkQ2FzZShhY3Rpb25zLndhcm11cEpvaW5Hcm91cCwgKHN0YXRlLCB7IHBheWxvYWQgfSkgPT4ge1xuICAgIGNvbnN0IGJhdGNoV2FybWVyID0gc3RhdGVbcGF5bG9hZC5wYXJlbnRdXG5cbiAgICBiYXRjaFdhcm1lci5jaGlsZExhc3RTZWVuQnlJZCA9IHtcbiAgICAgIC4uLmJhdGNoV2FybWVyLmNoaWxkTGFzdFNlZW5CeUlkLFxuICAgICAgLi4ucGF5bG9hZC5jaGlsZExhc3RTZWVuQnlJZCxcbiAgICB9XG4gICAgZm9yIChjb25zdCBjaGlsZEtleSBpbiBwYXlsb2FkLmNoaWxkTGFzdFNlZW5CeUlkKSB7XG4gICAgICBjb25zdCBjaGlsZFJlcXVlc3REYXRhID0gc3RhdGVbY2hpbGRLZXldPy5vcmlnaW5cbiAgICAgIGlmIChjaGlsZFJlcXVlc3REYXRhKSB7XG4gICAgICAgIC8vIEpvaW4gcmVxdWVzdCBkYXRhXG4gICAgICAgIGZvciAoY29uc3QgeyBuYW1lIH0gb2YgcGF5bG9hZC5iYXRjaGFibGVQcm9wZXJ0eVBhdGgpIHtcbiAgICAgICAgICBjb25zdCB1bmlxdWVCYXRjaGFibGVWYWx1ZSA9IG5ldyBTZXQoYmF0Y2hXYXJtZXIub3JpZ2luW25hbWVdKVxuICAgICAgICAgIGNvbnN0IHNpbmdsZUJhdGNoYWJsZXZhbHVlID0gY2hpbGRSZXF1ZXN0RGF0YVtuYW1lXSA/PyBjaGlsZFJlcXVlc3REYXRhLmRhdGE/LltuYW1lXVxuICAgICAgICAgIGlmIChzaW5nbGVCYXRjaGFibGV2YWx1ZSkgdW5pcXVlQmF0Y2hhYmxlVmFsdWUuYWRkKHNpbmdsZUJhdGNoYWJsZXZhbHVlKVxuICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihgW3N1YnNjcmlwdGlvbnNSZWR1Y2VyXSBuYW1lPSR7bmFtZX0gbm90IGZvdW5kIGluIGNoaWxkUmVxdWVzdERhdGFgLCB7XG4gICAgICAgICAgICAgIGNoaWxkS2V5LFxuICAgICAgICAgICAgICBjaGlsZFJlcXVlc3REYXRhLFxuICAgICAgICAgICAgICBuYW1lLFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICBiYXRjaFdhcm1lci5vcmlnaW5bbmFtZV0gPSBbLi4udW5pcXVlQmF0Y2hhYmxlVmFsdWVdXG4gICAgICAgIH1cblxuICAgICAgICAvLyBKb2luIG92ZXJyaWRlc1xuICAgICAgICBpZiAoYmF0Y2hXYXJtZXIub3JpZ2luLm92ZXJyaWRlcyB8fCBjaGlsZFJlcXVlc3REYXRhLm92ZXJyaWRlcylcbiAgICAgICAgICBiYXRjaFdhcm1lci5vcmlnaW4ub3ZlcnJpZGVzID0gbWVyZ2UoXG4gICAgICAgICAgICBiYXRjaFdhcm1lci5vcmlnaW4ub3ZlcnJpZGVzLFxuICAgICAgICAgICAgY2hpbGRSZXF1ZXN0RGF0YS5vdmVycmlkZXMsXG4gICAgICAgICAgKVxuICAgICAgICBpZiAoYmF0Y2hXYXJtZXIub3JpZ2luLnRva2VuT3ZlcnJpZGVzIHx8IGNoaWxkUmVxdWVzdERhdGEudG9rZW5PdmVycmlkZXMpXG4gICAgICAgICAgYmF0Y2hXYXJtZXIub3JpZ2luLnRva2VuT3ZlcnJpZGVzID0gbWVyZ2UoXG4gICAgICAgICAgICBiYXRjaFdhcm1lci5vcmlnaW4udG9rZW5PdmVycmlkZXMsXG4gICAgICAgICAgICBjaGlsZFJlcXVlc3REYXRhLnRva2VuT3ZlcnJpZGVzLFxuICAgICAgICAgIClcbiAgICAgICAgaWYgKGJhdGNoV2FybWVyLm9yaWdpbi5pbmNsdWRlcyB8fCBjaGlsZFJlcXVlc3REYXRhLmluY2x1ZGVzKVxuICAgICAgICAgIGJhdGNoV2FybWVyLm9yaWdpbi5pbmNsdWRlcyA9IHVuaXEoW1xuICAgICAgICAgICAgLi4uKGJhdGNoV2FybWVyLm9yaWdpbi5pbmNsdWRlcyB8fCBbXSksXG4gICAgICAgICAgICAuLi4oY2hpbGRSZXF1ZXN0RGF0YS5pbmNsdWRlcyB8fCBbXSksXG4gICAgICAgICAgXSlcbiAgICAgIH1cbiAgICB9XG4gIH0pXG5cbiAgYnVpbGRlci5hZGRDYXNlKGFjdGlvbnMud2FybXVwTGVhdmVHcm91cCwgKHN0YXRlLCB7IHBheWxvYWQgfSkgPT4ge1xuICAgIGNvbnN0IGJhdGNoV2FybWVyID0gc3RhdGVbcGF5bG9hZC5wYXJlbnRdXG5cbiAgICBjb25zdCBjaGlsZElkc1RvUmVtb3ZlID0gT2JqZWN0LmtleXMocGF5bG9hZC5jaGlsZExhc3RTZWVuQnlJZClcblxuICAgIGNvbnN0IHJlbWFpbmluZ0NoaWxkSWRzID0gT2JqZWN0LmtleXMoYmF0Y2hXYXJtZXIuY2hpbGRMYXN0U2VlbkJ5SWQgfHwge30pLmZpbHRlcihcbiAgICAgIChjaGlsZElkKSA9PiAhY2hpbGRJZHNUb1JlbW92ZS5pbmNsdWRlcyhjaGlsZElkKSxcbiAgICApXG5cbiAgICAvLyBUaGUgcmVxdWVzdCBkYXRhIGZvciBhIGJhdGNoIHJlcXVlc3Qgc2hvdWxkIG9ubHkgY29udGFpbiB1bmlxdWUgdmFsdWVzXG4gICAgY29uc3QgcmVxdWVzdERhdGFXaXRoVW5pcXVlVmFsdWVzID0gT2JqZWN0LmZyb21FbnRyaWVzPFNldDxzdHJpbmc+PihcbiAgICAgIHBheWxvYWQuYmF0Y2hhYmxlUHJvcGVydHlQYXRoLm1hcCgoeyBuYW1lIH0pID0+IFtuYW1lLCBuZXcgU2V0KCldKSxcbiAgICApXG5cbiAgICAvLyBSZWJ1aWxkIHRoZSByZXF1ZXN0IGRhdGEgd2l0aG91dCB0aGUgcmVtb3ZlZCBjaGlsZHJlbidzIGRhdGFcbiAgICBjb25zdCBiYXRjaFJlcXVlc3REYXRhID0gcmVtYWluaW5nQ2hpbGRJZHMucmVkdWNlKChhY2MsIGNoaWxkSWQpID0+IHtcbiAgICAgIGZvciAoY29uc3QgeyBuYW1lIH0gb2YgcGF5bG9hZC5iYXRjaGFibGVQcm9wZXJ0eVBhdGgpIHtcbiAgICAgICAgYWNjW25hbWVdLmFkZChzdGF0ZVtjaGlsZElkXS5vcmlnaW5bbmFtZV0pXG4gICAgICB9XG4gICAgICByZXR1cm4gYWNjXG4gICAgfSwgcmVxdWVzdERhdGFXaXRoVW5pcXVlVmFsdWVzKVxuXG4gICAgLy8gVHJhbnNmb3JtIHRoZSBzZXRzIGJhY2sgaW50byBhcnJheXNcbiAgICBjb25zdCBiYXRjaGFibGVSZXF1ZXN0RGF0YSA9IE9iamVjdC5mcm9tRW50cmllcyhcbiAgICAgIE9iamVjdC5lbnRyaWVzKGJhdGNoUmVxdWVzdERhdGEpLm1hcCgoW3BhdGgsIG1hcF0pID0+IFtwYXRoLCBbLi4ubWFwXV0pLFxuICAgIClcblxuICAgIC8vIFJlYnVpbGQgdGhlIG92ZXJyaWRlc1xuICAgIGNvbnN0IG92ZXJyaWRlcyA9IHJlbWFpbmluZ0NoaWxkSWRzLnJlZHVjZTx7XG4gICAgICBvdmVycmlkZXM/OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+XG4gICAgICB0b2tlbk92ZXJyaWRlcz86IFJlY29yZDxzdHJpbmcsIHN0cmluZz5cbiAgICAgIGluY2x1ZGVzPzogc3RyaW5nW11cbiAgICB9PigoYWNjLCBjaGlsZElkKSA9PiB7XG4gICAgICBjb25zdCBjaGlsZE9yaWdpbkRhdGEgPSBzdGF0ZVtjaGlsZElkXS5vcmlnaW5cbiAgICAgIGlmIChjaGlsZE9yaWdpbkRhdGEub3ZlcnJpZGVzKVxuICAgICAgICBhY2Mub3ZlcnJpZGVzID0gbWVyZ2UoYWNjLm92ZXJyaWRlcyB8fCB7fSwgY2hpbGRPcmlnaW5EYXRhLm92ZXJyaWRlcylcbiAgICAgIGlmIChjaGlsZE9yaWdpbkRhdGEudG9rZW5PdmVycmlkZXMpXG4gICAgICAgIGFjYy50b2tlbk92ZXJyaWRlcyA9IG1lcmdlKGFjYy50b2tlbk92ZXJyaWRlcyB8fCB7fSwgY2hpbGRPcmlnaW5EYXRhLnRva2VuT3ZlcnJpZGVzKVxuICAgICAgaWYgKGNoaWxkT3JpZ2luRGF0YS5pbmNsdWRlcylcbiAgICAgICAgYWNjLmluY2x1ZGVzID0gdW5pcShbLi4uKGFjYy5pbmNsdWRlcyB8fCBbXSksIC4uLmNoaWxkT3JpZ2luRGF0YS5pbmNsdWRlc10pXG4gICAgICByZXR1cm4gYWNjXG4gICAgfSwge30pXG5cbiAgICBiYXRjaFdhcm1lci5vcmlnaW4gPSB7XG4gICAgICAuLi5iYXRjaFdhcm1lci5vcmlnaW4sXG4gICAgICAuLi5iYXRjaGFibGVSZXF1ZXN0RGF0YSxcbiAgICAgIC4uLm92ZXJyaWRlcyxcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IGNoaWxkS2V5IGluIHBheWxvYWQuY2hpbGRMYXN0U2VlbkJ5SWQpIHtcbiAgICAgIGlmIChiYXRjaFdhcm1lcj8uY2hpbGRMYXN0U2VlbkJ5SWQ/LltjaGlsZEtleV0pXG4gICAgICAgIGRlbGV0ZSBiYXRjaFdhcm1lci5jaGlsZExhc3RTZWVuQnlJZD8uW2NoaWxkS2V5XVxuICAgIH1cbiAgfSlcbn0pXG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVxdWVzdERhdGEge1xuICAvKipcbiAgICogQ3VycmVudCBlcnJvciBmb3Igd2FybXVwIHJlcXVlc3QsIGlmIGFueVxuICAgKi9cbiAgZXJyb3I6IEVycm9yIHwgbnVsbFxuICAvKipcbiAgICogVGhlIGNvbnNlY3V0aXZlIG51bWJlciBvZiB0aW1lcyB3ZSd2ZSBoYWQgc3VjY2Vzc2Z1bCB3YXJtdXBzXG4gICAqL1xuICBzdWNjZXNzQ291bnQ6IG51bWJlclxuICAvKipcbiAgICogVGhlIGNvbnNlY3V0aXZlIG51bWJlciBvZiB0aW1lcyB3ZSd2ZSBoYWQgZXJyb3JzIHRyeWluZyB0byBzZW5kIGEgd2FybXVwIHJlcXVlc3RcbiAgICovXG4gIGVycm9yQ291bnQ6IG51bWJlclxufVxuZXhwb3J0IGludGVyZmFjZSBSZXF1ZXN0U3RhdGUge1xuICBba2V5OiBzdHJpbmddOiBSZXF1ZXN0RGF0YVxufVxuXG5leHBvcnQgY29uc3Qgd2FybXVwUmVkdWNlciA9IGNyZWF0ZVJlZHVjZXI8UmVxdWVzdFN0YXRlPih7fSwgKGJ1aWxkZXIpID0+IHtcbiAgYnVpbGRlci5hZGRDYXNlKGFjdGlvbnMud2FybXVwUmVxdWVzdGVkLCAoc3RhdGUsIGFjdGlvbikgPT4ge1xuICAgIGlmICghc3RhdGVbYWN0aW9uLnBheWxvYWQua2V5XSkge1xuICAgICAgbG9nZ2VyLmluZm8oJ1t3YXJtdXBSZWR1Y2VyXSBDcmVhdGluZyBzdWJzY3JpcHRpb24nLCB7XG4gICAgICAgIHdhcm11cFN1YnNjcmlwdGlvbktleTogYWN0aW9uLnBheWxvYWQua2V5LFxuICAgICAgfSlcbiAgICAgIHN0YXRlW2FjdGlvbi5wYXlsb2FkLmtleV0gPSB7IGVycm9yOiBudWxsLCBzdWNjZXNzQ291bnQ6IDAsIGVycm9yQ291bnQ6IDAgfVxuICAgIH1cbiAgfSlcblxuICBidWlsZGVyLmFkZENhc2UoYWN0aW9ucy53YXJtdXBGdWxmaWxsZWQsIChzdGF0ZSwgYWN0aW9uKSA9PiB7XG4gICAgY29uc3QgeyBrZXkgfSA9IGFjdGlvbi5wYXlsb2FkXG4gICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gc3RhdGVba2V5XVxuICAgIGlmICghc3Vic2NyaXB0aW9uKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoXG4gICAgICAgICdbd2FybXVwUmVkdWNlcl0gQXR0ZW1wdGVkIHRvIGZ1bGZpbGwgd2FybXVwIHJlcXVlc3QgZm9yIGEgbm9uLWV4aXN0aW5nIHN1YnNjcmlwdGlvbicsXG4gICAgICAgIHsgd2FybXVwU3Vic2NyaXB0aW9uS2V5OiBrZXkgfSxcbiAgICAgIClcbiAgICAgIHJldHVybiBzdGF0ZVxuICAgIH1cbiAgICBzdWJzY3JpcHRpb24uc3VjY2Vzc0NvdW50KytcbiAgICBzdWJzY3JpcHRpb24uZXJyb3IgPSBudWxsXG4gICAgc3Vic2NyaXB0aW9uLmVycm9yQ291bnQgPSAwXG4gICAgcmV0dXJuIHN0YXRlXG4gIH0pXG5cbiAgYnVpbGRlci5hZGRDYXNlKGFjdGlvbnMud2FybXVwRmFpbGVkLCAoc3RhdGUsIGFjdGlvbikgPT4ge1xuICAgIGNvbnN0IHsga2V5LCBmZWVkTGFiZWw6IGlkLCBlcnJvciB9ID0gYWN0aW9uLnBheWxvYWRcbiAgICBjb25zdCBzdWJzY3JpcHRpb24gPSBzdGF0ZVtrZXldXG4gICAgaWYgKCFzdWJzY3JpcHRpb24pIHtcbiAgICAgIGxvZ2dlci5lcnJvcihcbiAgICAgICAgJ1t3YXJtdXBSZWR1Y2VyXSBBdHRlbXB0ZWQgdG8gZnVsZmlsbCB3YXJtdXAgcmVxdWVzdCBmb3IgYSBub24tZXhpc3Rpbmcgc3Vic2NyaXB0aW9uJyxcbiAgICAgICAgeyB3YXJtdXBTdWJzY3JpcHRpb25LZXk6IGtleSB9LFxuICAgICAgKVxuICAgICAgcmV0dXJuIHN0YXRlXG4gICAgfVxuICAgIGxvZ2dlci5lcnJvcihgWyR7aWR9XSBDYWNoZSBXYXJtZXIgZmFpbGVkYCwgeyBlcnJvcjogZXJyb3I/Lm1lc3NhZ2UgfSlcbiAgICBzdWJzY3JpcHRpb24uZXJyb3IgPSBhY3Rpb24ucGF5bG9hZC5lcnJvclxuICAgIHN1YnNjcmlwdGlvbi5lcnJvckNvdW50KytcbiAgICBzdWJzY3JpcHRpb24uc3VjY2Vzc0NvdW50ID0gMFxuICAgIHJldHVybiBzdGF0ZVxuICB9KVxuXG4gIGJ1aWxkZXIuYWRkQ2FzZShhY3Rpb25zLndhcm11cFVuc3Vic2NyaWJlZCwgKHN0YXRlLCBhY3Rpb24pID0+IHtcbiAgICBjb25zdCB7IGtleSwgcmVhc29uIH0gPSBhY3Rpb24ucGF5bG9hZFxuICAgIGxvZ2dlci5pbmZvKCdbd2FybXVwUmVkdWNlcl0gRGVsZXRpbmcgc3Vic2NyaXB0aW9uLiAnLCB7IHJlYXNvbiB9KVxuICAgIGRlbGV0ZSBzdGF0ZVtrZXldXG4gIH0pXG5cbiAgYnVpbGRlci5hZGRDYXNlKGFjdGlvbnMud2FybXVwU2h1dGRvd24sICgpID0+IHtcbiAgICBsb2dnZXIuaW5mbygnW3dhcm11cFJlZHVjZXJdIFNodXR0aW5nIGRvd24uLi4gJylcbiAgfSlcblxuICBidWlsZGVyLmFkZENhc2UoYWN0aW9ucy53YXJtdXBTdG9wcGVkLCAoc3RhdGUsIGFjdGlvbikgPT4ge1xuICAgIGxvZ2dlci5pbmZvKCdbd2FybXVwUmVkdWNlcl0gU3RvcHBpbmcgc3Vic2NyaXB0aW9ucycsIHtcbiAgICAgIHdhcm11cFN1YnNjcmlwdGlvbktleTogYWN0aW9uLnBheWxvYWQua2V5cyxcbiAgICB9KVxuICAgIGZvciAoY29uc3Qga2V5IGluIGFjdGlvbi5wYXlsb2FkLmtleXMpIHtcbiAgICAgIGRlbGV0ZSBzdGF0ZVtrZXldXG4gICAgfVxuICB9KVxufSlcblxuZXhwb3J0IGNvbnN0IHJvb3RSZWR1Y2VyID0gY29tYmluZVJlZHVjZXJzKHtcbiAgc3Vic2NyaXB0aW9uczogc3Vic2NyaXB0aW9uc1JlZHVjZXIsXG4gIHdhcm11cHM6IHdhcm11cFJlZHVjZXIsXG59KVxuXG5leHBvcnQgdHlwZSBDYWNoZVdhcm1lclN0YXRlID0gUmV0dXJuVHlwZTx0eXBlb2Ygcm9vdFJlZHVjZXI+XG4iXX0=