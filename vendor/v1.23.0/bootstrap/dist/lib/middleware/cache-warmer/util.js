"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.concatenateBatchResults = exports.splitIntoBatches = exports.getSubscriptionKey = void 0;
const lodash_1 = require("lodash");
const config_1 = require("./config");
const util_1 = require("../../middleware/cache-key/util");
const conf = config_1.get();
/**
 * Returns hash of the input request payload excluding some volatile paths
 *
 * @param request payload
 */
function getSubscriptionKey(request) {
    return util_1.hash(lodash_1.omit(request, ['id', 'parent', 'children', 'result', 'batchablePropertyPath']), conf.hashOpts);
}
exports.getSubscriptionKey = getSubscriptionKey;
function splitIntoBatches(requestData) {
    const { batchablePropertyPath, origin } = requestData;
    if (!batchablePropertyPath) {
        return [];
    }
    const batchesByPath = groupBatchesByPath(batchablePropertyPath, origin);
    return getBatchesArray(batchesByPath);
}
exports.splitIntoBatches = splitIntoBatches;
function groupBatchesByPath(batchablePropertyPath, origin) {
    const batchesByPath = {};
    for (const { name, limit } of batchablePropertyPath) {
        if (origin[name]) {
            const batchedValues = origin[name];
            if (limit) {
                batchesByPath[name] = splitValuesIntoBatches(limit, batchedValues);
            }
            else {
                batchesByPath[name] = [batchedValues];
            }
        }
    }
    return batchesByPath;
}
function splitValuesIntoBatches(limit, values) {
    const batches = [];
    let idx = 0;
    while (idx < values.length) {
        const batch = values.slice(idx, Math.min(idx + limit, values.length));
        idx += limit;
        batches.push(batch);
    }
    return batches;
}
function getBatchesArray(batchesByPath) {
    const batches = [];
    populateBatchesArray(batchesByPath, batches, Object.keys(batchesByPath), 0, {});
    return batches;
}
function populateBatchesArray(batchesByPath, batches, batchPaths, idx, currBatch) {
    if (idx >= batchPaths.length) {
        batches.push(JSON.parse(JSON.stringify(currBatch)));
    }
    else {
        const currPath = batchPaths[idx];
        const pathBatch = batchesByPath[currPath];
        for (const batchValue of pathBatch) {
            currBatch[currPath] = batchValue;
            populateBatchesArray(batchesByPath, batches, batchPaths, idx + 1, currBatch);
            delete currBatch[currPath];
        }
    }
}
function concatenateBatchResults(result, latestResult) {
    if (!result) {
        return latestResult;
    }
    const mergedResult = JSON.parse(JSON.stringify(result));
    const bases = Object.keys(latestResult.data).filter((base) => base !== 'results');
    for (const base of bases) {
        if (mergedResult.data[base]) {
            mergedResult.data[base] = {
                ...mergedResult.data[base],
                ...latestResult.data[base],
            };
        }
        else {
            mergedResult.data[base] = latestResult.data[base];
        }
    }
    mergedResult.data.results = mergedResult.data.results.concat(latestResult.data.results);
    return mergedResult;
}
exports.concatenateBatchResults = concatenateBatchResults;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9saWIvbWlkZGxld2FyZS9jYWNoZS13YXJtZXIvdXRpbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxtQ0FBNkI7QUFFN0IscUNBQThCO0FBRzlCLDBEQUFzRDtBQUV0RCxNQUFNLElBQUksR0FBRyxZQUFHLEVBQUUsQ0FBQTtBQUVsQjs7OztHQUlHO0FBQ0gsU0FBZ0Isa0JBQWtCLENBQ2hDLE9BQXVEO0lBRXZELE9BQU8sV0FBSSxDQUNULGFBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsdUJBQXVCLENBQUMsQ0FBQyxFQUM5RSxJQUFJLENBQUMsUUFBUSxDQUNkLENBQUE7QUFDSCxDQUFDO0FBUEQsZ0RBT0M7QUFRRCxTQUFnQixnQkFBZ0IsQ0FBQyxXQUE2QjtJQUM1RCxNQUFNLEVBQUUscUJBQXFCLEVBQUUsTUFBTSxFQUFFLEdBQUcsV0FBVyxDQUFBO0lBQ3JELElBQUksQ0FBQyxxQkFBcUIsRUFBRTtRQUMxQixPQUFPLEVBQUUsQ0FBQTtLQUNWO0lBQ0QsTUFBTSxhQUFhLEdBQUcsa0JBQWtCLENBQUMscUJBQXFCLEVBQUUsTUFBTSxDQUFDLENBQUE7SUFDdkUsT0FBTyxlQUFlLENBQUMsYUFBYSxDQUFDLENBQUE7QUFDdkMsQ0FBQztBQVBELDRDQU9DO0FBTUQsU0FBUyxrQkFBa0IsQ0FDekIscUJBQTBDLEVBQzFDLE1BQThCO0lBRTlCLE1BQU0sYUFBYSxHQUFtQixFQUFFLENBQUE7SUFDeEMsS0FBSyxNQUFNLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLHFCQUFxQixFQUFFO1FBQ25ELElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ2hCLE1BQU0sYUFBYSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQTtZQUNsQyxJQUFJLEtBQUssRUFBRTtn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QUksQ0FBQyxJQUFJLENBQUMsR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1NBQ2xEO0tBQ0Y7SUFDRCxZQUFZLENBQUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtJQUN2RixPQUFPLFlBQVksQ0FBQTtBQUNyQixDQUFDO0FBckJELDBEQXFCQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IG9taXQgfSBmcm9tICdsb2Rhc2gnXG5pbXBvcnQgeyBXYXJtdXBFeGVjdXRlUGF5bG9hZCwgV2FybXVwU3Vic2NyaWJlZFBheWxvYWQgfSBmcm9tICcuL2FjdGlvbnMnXG5pbXBvcnQgeyBnZXQgfSBmcm9tICcuL2NvbmZpZydcbmltcG9ydCB7IEJhdGNoYWJsZVByb3BlcnR5LCBTdWJzY3JpcHRpb25EYXRhIH0gZnJvbSAnLi9yZWR1Y2VyJ1xuaW1wb3J0IHsgQWRhcHRlclJlcXVlc3QsIEFkYXB0ZXJSZXNwb25zZSB9IGZyb20gJ0BjaGFpbmxpbmsvdHlwZXMnXG5pbXBvcnQgeyBoYXNoIH0gZnJvbSAnLi4vLi4vbWlkZGxld2FyZS9jYWNoZS1rZXkvdXRpbCdcblxuY29uc3QgY29uZiA9IGdldCgpXG5cbi8qKlxuICogUmV0dXJucyBoYXNoIG9mIHRoZSBpbnB1dCByZXF1ZXN0IHBheWxvYWQgZXhjbHVkaW5nIHNvbWUgdm9sYXRpbGUgcGF0aHNcbiAqXG4gKiBAcGFyYW0gcmVxdWVzdCBwYXlsb2FkXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRTdWJzY3JpcHRpb25LZXkoXG4gIHJlcXVlc3Q6IFdhcm11cFN1YnNjcmliZWRQYXlsb2FkIHwgV2FybXVwRXhlY3V0ZVBheWxvYWQsXG4pOiBzdHJpbmcge1xuICByZXR1cm4gaGFzaChcbiAgICBvbWl0KHJlcXVlc3QsIFsnaWQnLCAncGFyZW50JywgJ2NoaWxkcmVuJywgJ3Jlc3VsdCcsICdiYXRjaGFibGVQcm9wZXJ0eVBhdGgnXSksXG4gICAgY29uZi5oYXNoT3B0cyxcbiAgKVxufVxuXG50eXBlIEJhdGNoUGF0aCA9IHN0cmluZ1tdXG5cbmludGVyZmFjZSBCYXRjaFJlcXVlc3RDaHVuayB7XG4gIFtwYXRoOiBzdHJpbmddOiBCYXRjaFBhdGhcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNwbGl0SW50b0JhdGNoZXMocmVxdWVzdERhdGE6IFN1YnNjcmlwdGlvbkRhdGEpOiBCYXRjaFJlcXVlc3RDaHVua1tdIHtcbiAgY29uc3QgeyBiYXRjaGFibGVQcm9wZXJ0eVBhdGgsIG9yaWdpbiB9ID0gcmVxdWVzdERhdGFcbiAgaWYgKCFiYXRjaGFibGVQcm9wZXJ0eVBhdGgpIHtcbiAgICByZXR1cm4gW11cbiAgfVxuICBjb25zdCBiYXRjaGVzQnlQYXRoID0gZ3JvdXBCYXRjaGVzQnlQYXRoKGJhdGNoYWJsZVByb3BlcnR5UGF0aCwgb3JpZ2luKVxuICByZXR1cm4gZ2V0QmF0Y2hlc0FycmF5KGJhdGNoZXNCeVBhdGgpXG59XG5cbnR5cGUgR3JvdXBlZEJhdGNoZXMgPSB7XG4gIFtwYXRoOiBzdHJpbmddOiBCYXRjaFBhdGhbXVxufVxuXG5mdW5jdGlvbiBncm91cEJhdGNoZXNCeVBhdGgoXG4gIGJhdGNoYWJsZVByb3BlcnR5UGF0aDogQmF0Y2hhYmxlUHJvcGVydHlbXSxcbiAgb3JpZ2luOiBBZGFwdGVyUmVxdWVzdFsnZGF0YSddLFxuKTogR3JvdXBlZEJhdGNoZXMge1xuICBjb25zdCBiYXRjaGVzQnlQYXRoOiBHcm91cGVkQmF0Y2hlcyA9IHt9XG4gIGZvciAoY29uc3QgeyBuYW1lLCBsaW1pdCB9IG9mIGJhdGNoYWJsZVByb3BlcnR5UGF0aCkge1xuICAgIGlmIChvcmlnaW5bbmFtZV0pIHtcbiAgICAgIGNvbnN0IGJhdGNoZWRWYWx1ZXMgPSBvcmlnaW5bbmFtZV1cbiAgICAgIGlmIChsaW1pdCkge1xuICAgICAgICBiYXRjaGVzQnlQYXRoW25hbWVdID0gc3BsaXRWYWx1ZXNJbnRvQmF0Y2hlcyhsaW1pdCwgYmF0Y2hlZFZhbHVlcylcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGJhdGNoZXNCeVBhdGhbbmFtZV0gPSBbYmF0Y2hlZFZhbHVlc11cbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgcmV0dXJuIGJhdGNoZXNCeVBhdGhcbn1cblxuZnVuY3Rpb24gc3BsaXRWYWx1ZXNJbnRvQmF0Y2hlcyhsaW1pdDogbnVtYmVyLCB2YWx1ZXM6IHN0cmluZ1tdKTogQmF0Y2hQYXRoW10ge1xuICBjb25zdCBiYXRjaGVzID0gW11cbiAgbGV0IGlkeCA9IDBcbiAgd2hpbGUgKGlkeCA8IHZhbHVlcy5sZW5ndGgpIHtcbiAgICBjb25zdCBiYXRjaCA9IHZhbHVlcy5zbGljZShpZHgsIE1hdGgubWluKGlkeCArIGxpbWl0LCB2YWx1ZXMubGVuZ3RoKSlcbiAgICBpZHggKz0gbGltaXRcbiAgICBiYXRjaGVzLnB1c2goYmF0Y2gpXG4gIH1cbiAgcmV0dXJuIGJhdGNoZXNcbn1cblxuZnVuY3Rpb24gZ2V0QmF0Y2hlc0FycmF5KGJhdGNoZXNCeVBhdGg6IEdyb3VwZWRCYXRjaGVzKTogQmF0Y2hSZXF1ZXN0Q2h1bmtbXSB7XG4gIGNvbnN0IGJhdGNoZXM6IEJhdGNoUmVxdWVzdENodW5rW10gPSBbXVxuICBwb3B1bGF0ZUJhdGNoZXNBcnJheShiYXRjaGVzQnlQYXRoLCBiYXRjaGVzLCBPYmplY3Qua2V5cyhiYXRjaGVzQnlQYXRoKSwgMCwge30pXG4gIHJldHVybiBiYXRjaGVzXG59XG5cbmZ1bmN0aW9uIHBvcHVsYXRlQmF0Y2hlc0FycmF5KFxuICBiYXRjaGVzQnlQYXRoOiBHcm91cGVkQmF0Y2hlcyxcbiAgYmF0Y2hlczogQmF0Y2hSZXF1ZXN0Q2h1bmtbXSxcbiAgYmF0Y2hQYXRoczogQmF0Y2hQYXRoLFxuICBpZHg6IG51bWJlcixcbiAgY3VyckJhdGNoOiBCYXRjaFJlcXVlc3RDaHVuayxcbik6IHZvaWQge1xuICBpZiAoaWR4ID49IGJhdGNoUGF0aHMubGVuZ3RoKSB7XG4gICAgYmF0Y2hlcy5wdXNoKEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoY3VyckJhdGNoKSkpXG4gIH0gZWxzZSB7XG4gICAgY29uc3QgY3VyclBhdGggPSBiYXRjaFBhdGhzW2lkeF1cbiAgICBjb25zdCBwYXRoQmF0Y2ggPSBiYXRjaGVzQnlQYXRoW2N1cnJQYXRoXVxuICAgIGZvciAoY29uc3QgYmF0Y2hWYWx1ZSBvZiBwYXRoQmF0Y2gpIHtcbiAgICAgIGN1cnJCYXRjaFtjdXJyUGF0aF0gPSBiYXRjaFZhbHVlXG4gICAgICBwb3B1bGF0ZUJhdGNoZXNBcnJheShiYXRjaGVzQnlQYXRoLCBiYXRjaGVzLCBiYXRjaFBhdGhzLCBpZHggKyAxLCBjdXJyQmF0Y2gpXG4gICAgICBkZWxldGUgY3VyckJhdGNoW2N1cnJQYXRoXVxuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gY29uY2F0ZW5hdGVCYXRjaFJlc3VsdHMoXG4gIHJlc3VsdDogQWRhcHRlclJlc3BvbnNlIHwgbnVsbCxcbiAgbGF0ZXN0UmVzdWx0OiBBZGFwdGVyUmVzcG9uc2UsXG4pOiBBZGFwdGVyUmVzcG9uc2Uge1xuICBpZiAoIXJlc3VsdCkge1xuICAgIHJldHVybiBsYXRlc3RSZXN1bHRcbiAgfVxuICBjb25zdCBtZXJnZWRSZXN1bHQgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHJlc3VsdCkpXG4gIGNvbnN0IGJhc2VzID0gT2JqZWN0LmtleXMobGF0ZXN0UmVzdWx0LmRhdGEpLmZpbHRlcigoYmFzZSkgPT4gYmFzZSAhPT0gJ3Jlc3VsdHMnKVxuICBmb3IgKGNvbnN0IGJhc2Ugb2YgYmFzZXMpIHtcbiAgICBpZiAobWVyZ2VkUmVzdWx0LmRhdGFbYmFzZV0pIHtcbiAgICAgIG1lcmdlZFJlc3VsdC5kYXRhW2Jhc2VdID0ge1xuICAgICAgICAuLi5tZXJnZWRSZXN1bHQuZGF0YVtiYXNlXSxcbiAgICAgICAgLi4ubGF0ZXN0UmVzdWx0LmRhdGFbYmFzZV0sXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIG1lcmdlZFJlc3VsdC5kYXRhW2Jhc2VdID0gbGF0ZXN0UmVzdWx0LmRhdGFbYmFzZV1cbiAgICB9XG4gIH1cbiAgbWVyZ2VkUmVzdWx0LmRhdGEucmVzdWx0cyA9IG1lcmdlZFJlc3VsdC5kYXRhLnJlc3VsdHMuY29uY2F0KGxhdGVzdFJlc3VsdC5kYXRhLnJlc3VsdHMpXG4gIHJldHVybiBtZXJnZWRSZXN1bHRcbn1cbiJdfQ==