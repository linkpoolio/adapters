"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getWSLimits = exports.getRateLimit = exports.getHTTPLimit = exports.DEFAULT_WS_SUBSCRIPTIONS = exports.DEFAULT_WS_CONNECTIONS = exports.BURST_UNDEFINED_QUOTA_MULTIPLE = exports.DEFAULT_MINUTE_RATE_LIMIT = void 0;
const modules_1 = require("../../modules");
exports.DEFAULT_MINUTE_RATE_LIMIT = 60;
exports.BURST_UNDEFINED_QUOTA_MULTIPLE = 2;
exports.DEFAULT_WS_CONNECTIONS = 2;
exports.DEFAULT_WS_SUBSCRIPTIONS = 10;
const getHTTPLimit = (provider, limits, tier, timeframe) => {
    const providerLimit = getProviderLimits(provider, limits, tier, 'http');
    return providerLimit?.[timeframe] || 0;
};
exports.getHTTPLimit = getHTTPLimit;
const getRateLimit = (provider, limits, tier) => {
    const providerLimit = getProviderLimits(provider, limits, tier, 'http');
    return calculateRateLimit(providerLimit);
};
exports.getRateLimit = getRateLimit;
const getWSLimits = (provider, limits, tier) => {
    const providerLimit = getProviderLimits(provider, limits, tier, 'ws');
    return calculateWSLimits(providerLimit);
};
exports.getWSLimits = getWSLimits;
const getProviderLimits = (provider, limits, tier, protocol) => {
    const providerConfig = parseLimits(limits);
    if (!providerConfig)
        throw new Error(`Rate Limit: Provider: "${provider}" doesn't match any provider spec in limits.json`);
    const protocolConfig = providerConfig[protocol];
    if (!protocolConfig)
        throw new Error(`Rate Limit: "${provider}" doesn't have any configuration for ${protocol} in limits.json`);
    let limitsConfig = protocolConfig[tier.toLowerCase()];
    if (!limitsConfig) {
        modules_1.logger.debug(`Rate Limit: "${provider} does not have tier ${tier} defined. Falling back to lowest tier"`);
        limitsConfig = Object.values(protocolConfig)?.[0];
    }
    if (!limitsConfig)
        throw new Error(`Rate Limit: Provider: "${provider}" has no tiers defined for ${protocol} in limits.json`);
    return limitsConfig;
};
const parseLimits = (limits) => {
    const _mapObject = (fn) => (o) => Object.fromEntries(Object.entries(o).map(fn));
    const _formatProtocol = _mapObject((entry) => {
        const [tierName, rest] = entry;
        return [tierName.toLowerCase(), { ...rest }];
    });
    const _formatProvider = (limits) => {
        const http = _formatProtocol(limits.http);
        const ws = _formatProtocol(limits?.ws);
        return { http, ws };
    };
    return _formatProvider(limits);
};
const calculateWSLimits = (providerLimit) => {
    return {
        connections: providerLimit.connections,
        subscriptions: providerLimit.subscriptions,
    };
};
const calculateRateLimit = (providerLimit) => {
    let quota = providerLimit.rateLimit1m;
    if (!quota && providerLimit?.rateLimit1h) {
        quota = providerLimit?.rateLimit1h / 60;
    }
    else if (!quota && providerLimit?.rateLimit1s) {
        quota = providerLimit?.rateLimit1s * 60;
    }
    return {
        second: providerLimit?.rateLimit1s || (quota / 60) * exports.BURST_UNDEFINED_QUOTA_MULTIPLE,
        minute: quota,
    };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbGliL2NvbmZpZy9wcm92aWRlci1saW1pdHMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsMkNBQXNDO0FBRXpCLFFBQUEseUJBQXlCLEdBQUcsRUFBRSxDQUFBO0FBQzlCLFFBQUEsOEJBQThCLEdBQUcsQ0FBQyxDQUFBO0FBRWxDLFFBQUEsc0JBQXNCLEdBQUcsQ0FBQyxDQUFBO0FBQzFCLFFBQUEsd0JBQXdCLEdBQUcsRUFBRSxDQUFBO0FBOEJuQyxNQUFNLFlBQVksR0FBRyxDQUMxQixRQUFnQixFQUNoQixNQUFjLEVBQ2QsSUFBWSxFQUNaLFNBQTZCLEVBQ3JCLEVBQUU7SUFDVixNQUFNLGFBQWEsR0FBRyxpQkFBaUIsQ0FBQyxRQUFRLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQTtJQUN2RSxPQUFRLGFBQTBCLEVBQUUsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUE7QUFDdEQsQ0FBQyxDQUFBO0FBUlksUUFBQSxZQUFZLGdCQVF4QjtBQUVNLE1BQU0sWUFBWSxHQUFHLENBQUMsUUFBZ0IsRUFBRSxNQUFjLEVBQUUsSUFBWSxFQUFxQixFQUFFO0lBQ2hHLE1BQU0sYUFBYSxHQUFHLGlCQUFpQixDQUFDLFFBQVEsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFBO0lBQ3ZFLE9BQU8sa0JBQWtCLENBQUMsYUFBeUIsQ0FBQyxDQUFBO0FBQ3RELENBQUMsQ0FBQTtBQUhZLFFBQUEsWUFBWSxnQkFHeEI7QUFFTSxNQUFNLFdBQVcsR0FBRyxDQUFDLFFBQWdCLEVBQUUsTUFBYyxFQUFFLElBQVksRUFBVSxFQUFFO0lBQ3BGLE1BQU0sYUFBYSxHQUFHLGlCQUFpQixDQUFDLFFBQVEsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFBO0lBQ3JFLE9BQU8saUJBQWlC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LEVBQUUsQ0FBQTtLQUN4QztJQUNELE9BQU87UUFDTCxNQUFNLEVBQUUsYUFBYSxFQUFFLFdBQVcsSUFBSSxDQUFFLEtBQWdCLEdBQUcsRUFBRSxDQUFDLEdBQUcsc0NBQThCO1FBQy9GLE1BQU0sRUFBRSxLQUFlO0tBQ3hCLENBQUE7QUFDSCxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi8uLi9tb2R1bGVzJ1xuXG5leHBvcnQgY29uc3QgREVGQVVMVF9NSU5VVEVfUkFURV9MSU1JVCA9IDYwXG5leHBvcnQgY29uc3QgQlVSU1RfVU5ERUZJTkVEX1FVT1RBX01VTFRJUExFID0gMlxuXG5leHBvcnQgY29uc3QgREVGQVVMVF9XU19DT05ORUNUSU9OUyA9IDJcbmV4cG9ydCBjb25zdCBERUZBVUxUX1dTX1NVQlNDUklQVElPTlMgPSAxMFxuXG50eXBlIFJhdGVMaW1pdFRpbWVGcmFtZSA9ICdyYXRlTGltaXQxcycgfCAncmF0ZUxpbWl0MW0nIHwgJ3JhdGVMaW1pdDFoJ1xuXG50eXBlIEhUVFBUaWVyID0ge1xuICByYXRlTGltaXQxcz86IG51bWJlclxuICByYXRlTGltaXQxbT86IG51bWJlclxuICByYXRlTGltaXQxaD86IG51bWJlclxuICBub3RlPzogc3RyaW5nXG59XG5cbnR5cGUgV1NUaWVyID0ge1xuICBjb25uZWN0aW9uczogbnVtYmVyXG4gIHN1YnNjcmlwdGlvbnM6IG51bWJlclxufVxuXG5leHBvcnQgaW50ZXJmYWNlIExpbWl0cyB7XG4gIGh0dHA6IHtcbiAgICBbdGllck5hbWU6IHN0cmluZ106IEhUVFBUaWVyXG4gIH1cbiAgd3M6IHtcbiAgICBbdGllck5hbWU6IHN0cmluZ106IFdTVGllclxuICB9XG59XG5cbmludGVyZmFjZSBQcm92aWRlclJhdGVMaW1pdCB7XG4gIHNlY29uZDogbnVtYmVyXG4gIG1pbnV0ZTogbnVtYmVyXG59XG5cbmV4cG9ydCBjb25zdCBnZXRIVFRQTGltaXQgPSAoXG4gIHByb3ZpZGVyOiBzdHJpbmcsXG4gIGxpbWl0czogTGltaXRzLFxuICB0aWVyOiBzdHJpbmcsXG4gIHRpbWVmcmFtZTogUmF0ZUxpbWl0VGltZUZyYW1lLFxuKTogbnVtYmVyID0+IHtcbiAgY29uc3QgcHJvdmlkZXJMaW1pdCA9IGdldFByb3ZpZGVyTGltaXRzKHByb3ZpZGVyLCBsaW1pdHMsIHRpZXIsICdodHRwJylcbiAgcmV0dXJuIChwcm92aWRlckxpbWl0IGFzIEhUVFBUaWVyKT8uW3RpbWVmcmFtZV0gfHwgMFxufVxuXG5leHBvcnQgY29uc3QgZ2V0UmF0ZUxpbWl0ID0gKHByb3ZpZGVyOiBzdHJpbmcsIGxpbWl0czogTGltaXRzLCB0aWVyOiBzdHJpbmcpOiBQcm92aWRlclJhdGVMaW1pdCA9PiB7XG4gIGNvbnN0IHByb3ZpZGVyTGltaXQgPSBnZXRQcm92aWRlckxpbWl0cyhwcm92aWRlciwgbGltaXRzLCB0aWVyLCAnaHR0cCcpXG4gIHJldHVybiBjYWxjdWxhdGVSYXRlTGltaXQocHJvdmlkZXJMaW1pdCBhcyBIVFRQVGllcilcbn1cblxuZXhwb3J0IGNvbnN0IGdldFdTTGltaXRzID0gKHByb3ZpZGVyOiBzdHJpbmcsIGxpbWl0czogTGltaXRzLCB0aWVyOiBzdHJpbmcpOiBXU1RpZXIgPT4ge1xuICBjb25zdCBwcm92aWRlckxpbWl0ID0gZ2V0UHJvdmlkZXJMaW1pdHMocHJvdmlkZXIsIGxpbWl0cywgdGllciwgJ3dzJylcbiAgcmV0dXJuIGNhbGN1bGF0ZVdTTGltaXRzKHByb3ZpZGVyTGltaXQgYXMgV1NUaWVyKVxufVxuXG5jb25zdCBnZXRQcm92aWRlckxpbWl0cyA9IChcbiAgcHJvdmlkZXI6IHN0cmluZyxcbiAgbGltaXRzOiBMaW1pdHMsXG4gIHRpZXI6IHN0cmluZyxcbiAgcHJvdG9jb2w6ICd3cycgfCAnaHR0cCcsXG4pOiBIVFRQVGllciB8IFdTVGllciB8IHVuZGVmaW5lZCA9PiB7XG4gIGNvbnN0IHByb3ZpZGVyQ29uZmlnID0gcGFyc2VMaW1pdHMobGltaXRzKVxuICBpZiAoIXByb3ZpZGVyQ29uZmlnKVxuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIGBSYXRlIExpbWl0OiBQcm92aWRlcjogXCIke3Byb3ZpZGVyfVwiIGRvZXNuJ3QgbWF0Y2ggYW55IHByb3ZpZGVyIHNwZWMgaW4gbGltaXRzLmpzb25gLFxuICAgIClcblxuICBjb25zdCBwcm90b2NvbENvbmZpZyA9IHByb3ZpZGVyQ29uZmlnW3Byb3RvY29sXVxuICBpZiAoIXByb3RvY29sQ29uZmlnKVxuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIGBSYXRlIExpbWl0OiBcIiR7cHJvdmlkZXJ9XCIgZG9lc24ndCBoYXZlIGFueSBjb25maWd1cmF0aW9uIGZvciAke3Byb3RvY29sfSBpbiBsaW1pdHMuanNvbmAsXG4gICAgKVxuXG4gIGxldCBsaW1pdHNDb25maWcgPSBwcm90b2NvbENvbmZpZ1t0aWVyLnRvTG93ZXJDYXNlKCldXG5cbiAgaWYgKCFsaW1pdHNDb25maWcpIHtcbiAgICBsb2dnZXIuZGVidWcoXG4gICAgICBgUmF0ZSBMaW1pdDogXCIke3Byb3ZpZGVyfSBkb2VzIG5vdCBoYXZlIHRpZXIgJHt0aWVyfSBkZWZpbmVkLiBGYWxsaW5nIGJhY2sgdG8gbG93ZXN0IHRpZXJcImAsXG4gICAgKVxuICAgIGxpbWl0c0NvbmZpZyA9IE9iamVjdC52YWx1ZXMocHJvdG9jb2xDb25maWcpPy5bMF1cbiAgfVxuXG4gIGlmICghbGltaXRzQ29uZmlnKVxuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIGBSYXRlIExpbWl0OiBQcm92aWRlcjogXCIke3Byb3ZpZGVyfVwiIGhhcyBubyB0aWVycyBkZWZpbmVkIGZvciAke3Byb3RvY29sfSBpbiBsaW1pdHMuanNvbmAsXG4gICAgKVxuXG4gIHJldHVybiBsaW1pdHNDb25maWdcbn1cblxuY29uc3QgcGFyc2VMaW1pdHMgPSAobGltaXRzOiBMaW1pdHMpOiBMaW1pdHMgPT4ge1xuICBjb25zdCBfbWFwT2JqZWN0ID0gKGZuOiBhbnkpID0+IChvOiBhbnkpID0+IE9iamVjdC5mcm9tRW50cmllcyhPYmplY3QuZW50cmllcyhvKS5tYXAoZm4pKVxuICBjb25zdCBfZm9ybWF0UHJvdG9jb2wgPSBfbWFwT2JqZWN0KChlbnRyeTogYW55W10pID0+IHtcbiAgICBjb25zdCBbdGllck5hbWUsIHJlc3RdID0gZW50cnlcbiAgICByZXR1cm4gW3RpZXJOYW1lLnRvTG93ZXJDYXNlKCksIHsgLi4uKHJlc3QgYXMgYW55KSB9XVxuICB9KVxuICBjb25zdCBfZm9ybWF0UHJvdmlkZXIgPSAobGltaXRzOiBMaW1pdHMpID0+IHtcbiAgICBjb25zdCBodHRwID0gX2Zvcm1hdFByb3RvY29sKGxpbWl0cy5odHRwKVxuICAgIGNvbnN0IHdzID0gX2Zvcm1hdFByb3RvY29sKGxpbWl0cz8ud3MpXG4gICAgcmV0dXJuIHsgaHR0cCwgd3MgfVxuICB9XG5cbiAgcmV0dXJuIF9mb3JtYXRQcm92aWRlcihsaW1pdHMpXG59XG5cbmNvbnN0IGNhbGN1bGF0ZVdTTGltaXRzID0gKHByb3ZpZGVyTGltaXQ6IFdTVGllcik6IFdTVGllciA9PiB7XG4gIHJldHVybiB7XG4gICAgY29ubmVjdGlvbnM6IHByb3ZpZGVyTGltaXQuY29ubmVjdGlvbnMsXG4gICAgc3Vic2NyaXB0aW9uczogcHJvdmlkZXJMaW1pdC5zdWJzY3JpcHRpb25zLFxuICB9XG59XG5cbmNvbnN0IGNhbGN1bGF0ZVJhdGVMaW1pdCA9IChwcm92aWRlckxpbWl0OiBIVFRQVGllcik6IFByb3ZpZGVyUmF0ZUxpbWl0ID0+IHtcbiAgbGV0IHF1b3RhID0gcHJvdmlkZXJMaW1pdC5yYXRlTGltaXQxbVxuICBpZiAoIXF1b3RhICYmIHByb3ZpZGVyTGltaXQ/LnJhdGVMaW1pdDFoKSB7XG4gICAgcXVvdGEgPSBwcm92aWRlckxpbWl0Py5yYXRlTGltaXQxaCAvIDYwXG4gIH0gZWxzZSBpZiAoIXF1b3RhICYmIHByb3ZpZGVyTGltaXQ/LnJhdGVMaW1pdDFzKSB7XG4gICAgcXVvdGEgPSBwcm92aWRlckxpbWl0Py5yYXRlTGltaXQxcyAqIDYwXG4gIH1cbiAgcmV0dXJuIHtcbiAgICBzZWNvbmQ6IHByb3ZpZGVyTGltaXQ/LnJhdGVMaW1pdDFzIHx8ICgocXVvdGEgYXMgbnVtYmVyKSAvIDYwKSAqIEJVUlNUX1VOREVGSU5FRF9RVU9UQV9NVUxUSVBMRSxcbiAgICBtaW51dGU6IHF1b3RhIGFzIG51bWJlcixcbiAgfVxufVxuIl19