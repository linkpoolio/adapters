"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RateLimit = exports.server = exports.util = exports.Logger = exports.Builder = exports.AdapterError = exports.CacheKey = exports.Overrider = exports.Validator = exports.Requester = exports.expose = exports.executeSync = exports.withMiddleware = exports.makeMiddleware = exports.storeSlice = exports.store = void 0;
const tslib_1 = require("tslib");
const redux_1 = require("redux");
const cache_1 = require("./lib/middleware/cache");
const cacheWarmer = tslib_1.__importStar(require("./lib/middleware/cache-warmer"));
const modules_1 = require("./lib/modules");
Object.defineProperty(exports, "AdapterError", { enumerable: true, get: function () { return modules_1.AdapterError; } });
Object.defineProperty(exports, "Logger", { enumerable: true, get: function () { return modules_1.logger; } });
Object.defineProperty(exports, "Requester", { enumerable: true, get: function () { return modules_1.Requester; } });
Object.defineProperty(exports, "Validator", { enumerable: true, get: function () { return modules_1.Validator; } });
Object.defineProperty(exports, "Overrider", { enumerable: true, get: function () { return modules_1.Overrider; } });
Object.defineProperty(exports, "Builder", { enumerable: true, get: function () { return modules_1.Builder; } });
const metrics = tslib_1.__importStar(require("./lib/metrics"));
const RateLimit = tslib_1.__importStar(require("./lib/middleware/rate-limit"));
exports.RateLimit = RateLimit;
const burstLimit = tslib_1.__importStar(require("./lib/middleware/burst-limit"));
const ErrorBackoff = tslib_1.__importStar(require("./lib/middleware/error-backoff"));
const ioLogger = tslib_1.__importStar(require("./lib/middleware/io-logger"));
const statusCode = tslib_1.__importStar(require("./lib/middleware/status-code"));
const debug = tslib_1.__importStar(require("./lib/middleware/debugger"));
const normalize = tslib_1.__importStar(require("./lib/middleware/normalize"));
const CacheKey = tslib_1.__importStar(require("./lib/middleware/cache-key"));
exports.CacheKey = CacheKey;
const server = tslib_1.__importStar(require("./lib/server"));
exports.server = server;
const store_1 = require("./lib/store");
const util = tslib_1.__importStar(require("./lib/util"));
exports.util = util;
const ws = tslib_1.__importStar(require("./lib/middleware/ws"));
const REDUX_MIDDLEWARE = ['burstLimit', 'cacheWarmer', 'errorBackoff', 'rateLimit', 'ws'];
const rootReducer = redux_1.combineReducers({
    errorBackoff: ErrorBackoff.reducer.rootReducer,
    burstLimit: burstLimit.reducer.rootReducer,
    cacheWarmer: cacheWarmer.reducer.rootReducer,
    rateLimit: RateLimit.reducer.rootReducer,
    ws: ws.reducer.rootReducer,
});
// Init store
const initState = { burstLimit: {}, cacheWarmer: {}, errorBackoff: {}, rateLimit: {}, ws: {} };
exports.store = store_1.configureStore(rootReducer, initState, [
    cacheWarmer.epics.epicMiddleware,
    ws.epics.epicMiddleware,
]);
// Run epics
cacheWarmer.epics.epicMiddleware.run(cacheWarmer.epics.rootEpic);
ws.epics.epicMiddleware.run(ws.epics.rootEpic);
const storeSlice = (slice) => ({
    getState: () => exports.store.getState()[slice],
    dispatch: (a) => exports.store.dispatch(a),
});
exports.storeSlice = storeSlice;
const makeMiddleware = (execute, makeWsHandler, endpointSelector) => {
    const warmerMiddleware = [
        cache_1.withCache(exports.storeSlice('burstLimit')),
        RateLimit.withRateLimit(exports.storeSlice('rateLimit')),
        statusCode.withStatusCode,
        CacheKey.withCacheKey(endpointSelector),
        normalize.withNormalizedInput(endpointSelector),
    ].concat(metrics.METRICS_ENABLED ? [metrics.withMetrics] : []);
    return [
        ErrorBackoff.withErrorBackoff(exports.storeSlice('errorBackoff')),
        ioLogger.withIOLogger,
        cache_1.withCache(exports.storeSlice('burstLimit')),
        cacheWarmer.withCacheWarmer(exports.storeSlice('cacheWarmer'), warmerMiddleware, {
            store: exports.storeSlice('ws'),
            makeWSHandler: makeWsHandler,
        })(execute),
        ws.withWebSockets(exports.storeSlice('ws'), makeWsHandler),
        RateLimit.withRateLimit(exports.storeSlice('rateLimit')),
        statusCode.withStatusCode,
        CacheKey.withCacheKey(endpointSelector),
        normalize.withNormalizedInput(endpointSelector),
    ].concat(metrics.METRICS_ENABLED ? [metrics.withMetrics, debug.withDebug] : [debug.withDebug]);
};
exports.makeMiddleware = makeMiddleware;
// Wrap raw Execute function with middleware
const withMiddleware = async (execute, context, middleware) => {
    // Init and wrap middleware one by one
    for (let i = 0; i < middleware.length; i++) {
        execute = await middleware[i](execute, context);
    }
    return execute;
};
exports.withMiddleware = withMiddleware;
// Execution helper async => sync
const executeSync = async (data, execute, context, callback) => {
    try {
        const result = await execute(data, context);
        return callback(result.statusCode, result);
    }
    catch (error) {
        const feedID = metrics.util.getFeedId(data);
        return callback(error.statusCode || 500, modules_1.Requester.errored(data.id, error, error.providerResponseStatusCode || error.statusCode, feedID));
    }
};
exports.executeSync = executeSync;
const expose = (context, execute, makeWsHandler, endpointSelector) => {
    util.registerUnhandledRejectionHandler();
    const middleware = exports.makeMiddleware(execute, makeWsHandler, endpointSelector);
    return {
        server: server.initHandler(context, execute, middleware),
    };
};
exports.expose = expose;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQVdBLGlDQUE4QztBQUM5QyxrREFBeUQ7QUFDekQsbUZBQTREO0FBQzVELDJDQU9zQjtBQThJcEIsNkZBcEpBLHNCQUFZLE9Bb0pBO0FBRVosdUZBckpVLGdCQUFNLE9BcUpWO0FBTk4sMEZBOUlBLG1CQUFTLE9BOElBO0FBQ1QsMEZBOUlBLG1CQUFTLE9BOElBO0FBQ1QsMEZBOUlBLG1CQUFTLE9BOElBO0FBR1Qsd0ZBaEpBLGlCQUFPLE9BZ0pBO0FBOUlULCtEQUF3QztBQUN4QywrRUFBd0Q7QUFrSnRELDhCQUFTO0FBakpYLGlGQUEwRDtBQUMxRCxxRkFBOEQ7QUFDOUQsNkVBQXNEO0FBQ3RELGlGQUEwRDtBQUMxRCx5RUFBa0Q7QUFDbEQsOEVBQXVEO0FBQ3ZELDZFQUFzRDtBQW9JcEQsNEJBQVE7QUFuSVYsNkRBQXNDO0FBd0lwQyx3QkFBTTtBQXZJUix1Q0FBNEM7QUFDNUMseURBQWtDO0FBcUloQyxvQkFBSTtBQXBJTixnRUFBeUM7QUFHekMsTUFBTSxnQkFBZ0IsR0FBRyxDQUFDLFlBQVksRUFBRSxhQUFhLEVBQUUsY0FBYyxFQUFFLFdBQVcsRUFBRSxJQUFJLENBQVUsQ0FBQTtBQUdsRyxNQUFNLFdBQVcsR0FBRyx1QkFBZSxDQUFDO0lBQ2xDLFlBQVksRUFBRSxZQUFZLENBQUMsT0FBTyxDQUFDLFdBQVc7SUFDOUMsVUFBVSxFQUFFLFVBQVUsQ0FBQyxPQUFPLENBQUMsV0FBVztJQUMxQyxXQUFXLEVBQUUsV0FBVyxDQUFDLE9BQU8sQ0FBQyxXQUFXO0lBQzVDLFNBQVMsRUFBRSxTQUFTLENBQUMsT0FBTyxDQUFDLFdBQVc7SUFDeEMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxPQUFPLENBQUMsV0FBVztDQUMzQixDQUFDLENBQUE7QUFJRixhQUFhO0FBQ2IsTUFBTSxTQUFTLEdBQUcsRUFBRSxVQUFVLEVBQUUsRUFBRSxFQUFFLFdBQVcsRUFBRSxFQUFFLEVBQUUsWUFBWSxFQUFFLEVBQUUsRUFBRSxTQUFTLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQTtBQUNqRixRQUFBLEtBQUssR0FBRyxzQkFBYyxDQUFDLFdBQVcsRUFBRSxTQUFTLEVBQUU7SUFDMUQsV0FBVyxDQUFDLEtBQUssQ0FBQyxjQUFjO0lBQ2hDLEVBQUUsQ0FBQyxLQUFLLENBQUMsY0FBYztDQUN4QixDQUFDLENBQUE7QUFFRixZQUFZO0FBQ1osV0FBVyxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUE7QUFDaEUsRUFBRSxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUE7QUFFdkMsTUFBTSxVQUFVLEdBQUcsQ0FBQyxLQUFzQixFQUFTLEVBQUUsQ0FDMUQsQ0FBQztJQUNDLFFBQVEsRUFBRSxHQUFHLEVBQUUsQ0FBQyxhQUFLLENBQUMsUUFBUSxFQUFFLENBQUMsS0FBSyxDQUFDO0lBQ3ZDLFFBQVEsRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsYUFBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7Q0FDekIsQ0FBQSxDQUFBO0FBSkEsUUFBQSxVQUFVLGNBSVY7QUFFTixNQUFNLGNBQWMsR0FBRyxDQUM1QixPQUFnQixFQUNoQixhQUE2QixFQUM3QixnQkFBOEQsRUFDaEQsRUFBRTtJQUNoQixNQUFNLGdCQUFnQixHQUFHO1FBQ3ZCLGlCQUFTLENBQUMsa0JBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUNuQyxTQUFTLENBQUMsYUFBYSxDQUFDLGtCQUFVLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDaEQsVUFBVSxDQUFDLGNBQWM7UUFDekIsUUFBUSxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQztRQUN2QyxTQUFTLENBQUMsbUJBQW1CLENBQUMsZ0JBQWdCLENBQUM7S0FDaEQsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFBO0lBRTlELE9BQU87UUFDTCxZQUFZLENBQUMsZ0JBQWdCLENBQUMsa0JBQVUsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUN6RCxRQUFRLENBQUMsWUFBWTtRQUNyQixpQkFBUyxDQUFDLGtCQUFVLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDbkMsV0FBVyxDQUFDLGVBQWUsQ0FBQyxrQkFBVSxDQUFDLGFBQWEsQ0FBQyxFQUFFLGdCQUFnQixFQUFFO1lBQ3ZFLEtBQUssRUFBRSxrQkFBVSxDQUFDLElBQUksQ0FBQztZQUN2QixhQUFhLEVBQUUsYUFBYTtTQUM3QixDQUFDLENBQUMsT0FBTyxDQUFDO1FBQ1gsRUFBRSxDQUFDLGNBQWMsQ0FBQyxrQkFBVSxDQUFDLElBQUksQ0FBQyxFQUFFLGFBQWEsQ0FBQztRQUNsRCxTQUFTLENBQUMsYUFBYSxDQUFDLGtCQUFVLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDaEQsVUFBVSxDQUFDLGNBQWM7UUFDekIsUUFBUSxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQztRQUN2QyxTQUFTLENBQUMsbUJBQW1CLENBQUMsZ0JBQWdCLENBQUM7S0FDaEQsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQTtBQUNoRyxDQUFDLENBQUE7QUEzQlksUUFBQSxjQUFjLGtCQTJCMUI7QUFFRCw0Q0FBNEM7QUFDckMsTUFBTSxjQUFjLEdBQUcsS0FBSyxFQUNqQyxPQUFnQixFQUNoQixPQUF1QixFQUN2QixVQUF3QixFQUNOLEVBQUU7SUFDcEIsc0NBQXNDO0lBQ3RDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxVQUFVLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1FBQzFDLE9BQU8sR0FBRyxNQUFNLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUE7S0FDaEQ7SUFDRCxPQUFPLE9BQU8sQ0FBQTtBQUNoQixDQUFDLENBQUE7QUFWWSxRQUFBLGNBQWMsa0JBVTFCO0FBRUQsaUNBQWlDO0FBQzFCLE1BQU0sV0FBVyxHQUFnQixLQUFLLEVBQzNDLElBQW9CLEVBQ3BCLE9BQWdCLEVBQ2hCLE9BQXVCLEVBQ3ZCLFFBQWtCLEVBQ2xCLEVBQUU7SUFDRixJQUFJO1FBQ0YsTUFBTSxNQUFNLEdBQUcsTUFBTSxPQUFPLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFBO1FBRTNDLE9BQU8sUUFBUSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUUsTUFBTSxDQUFDLENBQUE7S0FDM0M7SUFBQyxPQUFPLEtBQUssRUFBRTtRQUNkLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQzNDLE9BQU8sUUFBUSxDQUNiLEtBQUssQ0FBQyxVQUFVLElBQUksR0FBRyxFQUN2QixtQkFBUyxDQUFDLE9BQU8sQ0FDZixJQUFJLENBQUMsRUFBRSxFQUNQLEtBQUssRUFDTCxLQUFLLENBQUMsMEJBQTBCLElBQUksS0FBSyxDQUFDLFVBQVUsRUFDcEQsTUFBTSxDQUNQLENBQ0YsQ0FBQTtLQUNGO0FBQ0gsQ0FBQyxDQUFBO0FBdEJZLFFBQUEsV0FBVyxlQXNCdkI7QUFZTSxNQUFNLE1BQU0sR0FBRyxDQUNwQixPQUF1QixFQUN2QixPQUFnQixFQUNoQixhQUE2QixFQUM3QixnQkFBOEQsRUFDOUMsRUFBRTtJQUNsQixJQUFJLENBQUMsaUNBQWlDLEVBQUUsQ0FBQTtJQUV4QyxNQUFNLFVBQVUsR0FBRyxzQkFBYyxDQUFDLE9BQU8sRUFBRSxhQUFhLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQTtJQUMzRSxPQUFPO1FBQ0wsTUFBTSxFQUFFLE1BQU0sQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxVQUFVLENBQUM7S0FDekQsQ0FBQTtBQUNILENBQUMsQ0FBQTtBQVpZLFFBQUEsTUFBTSxVQVlsQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEFkYXB0ZXJSZXF1ZXN0LFxuICBBZGFwdGVyQ29udGV4dCxcbiAgRXhlY3V0ZSxcbiAgRXhlY3V0ZVN5bmMsXG4gIE1ha2VXU0hhbmRsZXIsXG4gIE1pZGRsZXdhcmUsXG4gIEFQSUVuZHBvaW50LFxuICBDYWxsYmFjayxcbiAgQ29uZmlnLFxufSBmcm9tICdAY2hhaW5saW5rL3R5cGVzJ1xuaW1wb3J0IHsgY29tYmluZVJlZHVjZXJzLCBTdG9yZSB9IGZyb20gJ3JlZHV4J1xuaW1wb3J0IHsgQ2FjaGUsIHdpdGhDYWNoZSB9IGZyb20gJy4vbGliL21pZGRsZXdhcmUvY2FjaGUnXG5pbXBvcnQgKiBhcyBjYWNoZVdhcm1lciBmcm9tICcuL2xpYi9taWRkbGV3YXJlL2NhY2hlLXdhcm1lcidcbmltcG9ydCB7XG4gIEFkYXB0ZXJFcnJvcixcbiAgbG9nZ2VyIGFzIExvZ2dlcixcbiAgUmVxdWVzdGVyLFxuICBWYWxpZGF0b3IsXG4gIE92ZXJyaWRlcixcbiAgQnVpbGRlcixcbn0gZnJvbSAnLi9saWIvbW9kdWxlcydcbmltcG9ydCAqIGFzIG1ldHJpY3MgZnJvbSAnLi9saWIvbWV0cmljcydcbmltcG9ydCAqIGFzIFJhdGVMaW1pdCBmcm9tICcuL2xpYi9taWRkbGV3YXJlL3JhdGUtbGltaXQnXG5pbXBvcnQgKiBhcyBidXJzdExpbWl0IGZyb20gJy4vbGliL21pZGRsZXdhcmUvYnVyc3QtbGltaXQnXG5pbXBvcnQgKiBhcyBFcnJvckJhY2tvZmYgZnJvbSAnLi9saWIvbWlkZGxld2FyZS9lcnJvci1iYWNrb2ZmJ1xuaW1wb3J0ICogYXMgaW9Mb2dnZXIgZnJvbSAnLi9saWIvbWlkZGxld2FyZS9pby1sb2dnZXInXG5pbXBvcnQgKiBhcyBzdGF0dXNDb2RlIGZyb20gJy4vbGliL21pZGRsZXdhcmUvc3RhdHVzLWNvZGUnXG5pbXBvcnQgKiBhcyBkZWJ1ZyBmcm9tICcuL2xpYi9taWRkbGV3YXJlL2RlYnVnZ2VyJ1xuaW1wb3J0ICogYXMgbm9ybWFsaXplIGZyb20gJy4vbGliL21pZGRsZXdhcmUvbm9ybWFsaXplJ1xuaW1wb3J0ICogYXMgQ2FjaGVLZXkgZnJvbSAnLi9saWIvbWlkZGxld2FyZS9jYWNoZS1rZXknXG5pbXBvcnQgKiBhcyBzZXJ2ZXIgZnJvbSAnLi9saWIvc2VydmVyJ1xuaW1wb3J0IHsgY29uZmlndXJlU3RvcmUgfSBmcm9tICcuL2xpYi9zdG9yZSdcbmltcG9ydCAqIGFzIHV0aWwgZnJvbSAnLi9saWIvdXRpbCdcbmltcG9ydCAqIGFzIHdzIGZyb20gJy4vbGliL21pZGRsZXdhcmUvd3MnXG5pbXBvcnQgaHR0cCBmcm9tICdodHRwJ1xuXG5jb25zdCBSRURVWF9NSURETEVXQVJFID0gWydidXJzdExpbWl0JywgJ2NhY2hlV2FybWVyJywgJ2Vycm9yQmFja29mZicsICdyYXRlTGltaXQnLCAnd3MnXSBhcyBjb25zdFxudHlwZSBSZWR1eE1pZGRsZXdhcmUgPSB0eXBlb2YgUkVEVVhfTUlERExFV0FSRVtudW1iZXJdXG5cbmNvbnN0IHJvb3RSZWR1Y2VyID0gY29tYmluZVJlZHVjZXJzKHtcbiAgZXJyb3JCYWNrb2ZmOiBFcnJvckJhY2tvZmYucmVkdWNlci5yb290UmVkdWNlcixcbiAgYnVyc3RMaW1pdDogYnVyc3RMaW1pdC5yZWR1Y2VyLnJvb3RSZWR1Y2VyLFxuICBjYWNoZVdhcm1lcjogY2FjaGVXYXJtZXIucmVkdWNlci5yb290UmVkdWNlcixcbiAgcmF0ZUxpbWl0OiBSYXRlTGltaXQucmVkdWNlci5yb290UmVkdWNlcixcbiAgd3M6IHdzLnJlZHVjZXIucm9vdFJlZHVjZXIsXG59KVxuXG5leHBvcnQgdHlwZSBSb290U3RhdGUgPSBSZXR1cm5UeXBlPHR5cGVvZiByb290UmVkdWNlcj5cblxuLy8gSW5pdCBzdG9yZVxuY29uc3QgaW5pdFN0YXRlID0geyBidXJzdExpbWl0OiB7fSwgY2FjaGVXYXJtZXI6IHt9LCBlcnJvckJhY2tvZmY6IHt9LCByYXRlTGltaXQ6IHt9LCB3czoge30gfVxuZXhwb3J0IGNvbnN0IHN0b3JlID0gY29uZmlndXJlU3RvcmUocm9vdFJlZHVjZXIsIGluaXRTdGF0ZSwgW1xuICBjYWNoZVdhcm1lci5lcGljcy5lcGljTWlkZGxld2FyZSxcbiAgd3MuZXBpY3MuZXBpY01pZGRsZXdhcmUsXG5dKVxuXG4vLyBSdW4gZXBpY3NcbmNhY2hlV2FybWVyLmVwaWNzLmVwaWNNaWRkbGV3YXJlLnJ1bihjYWNoZVdhcm1lci5lcGljcy5yb290RXBpYylcbndzLmVwaWNzLmVwaWNNaWRkbGV3YXJlLnJ1bih3cy5lcGljcy5yb290RXBpYylcblxuZXhwb3J0IGNvbnN0IHN0b3JlU2xpY2UgPSAoc2xpY2U6IFJlZHV4TWlkZGxld2FyZSk6IFN0b3JlID0+XG4gICh7XG4gICAgZ2V0U3RhdGU6ICgpID0+IHN0b3JlLmdldFN0YXRlKClbc2xpY2VdLFxuICAgIGRpc3BhdGNoOiAoYSkgPT4gc3RvcmUuZGlzcGF0Y2goYSksXG4gIH0gYXMgU3RvcmUpXG5cbmV4cG9ydCBjb25zdCBtYWtlTWlkZGxld2FyZSA9IDxDIGV4dGVuZHMgQ29uZmlnPihcbiAgZXhlY3V0ZTogRXhlY3V0ZSxcbiAgbWFrZVdzSGFuZGxlcj86IE1ha2VXU0hhbmRsZXIsXG4gIGVuZHBvaW50U2VsZWN0b3I/OiAocmVxdWVzdDogQWRhcHRlclJlcXVlc3QpID0+IEFQSUVuZHBvaW50PEM+LFxuKTogTWlkZGxld2FyZVtdID0+IHtcbiAgY29uc3Qgd2FybWVyTWlkZGxld2FyZSA9IFtcbiAgICB3aXRoQ2FjaGUoc3RvcmVTbGljZSgnYnVyc3RMaW1pdCcpKSxcbiAgICBSYXRlTGltaXQud2l0aFJhdGVMaW1pdChzdG9yZVNsaWNlKCdyYXRlTGltaXQnKSksXG4gICAgc3RhdHVzQ29kZS53aXRoU3RhdHVzQ29kZSxcbiAgICBDYWNoZUtleS53aXRoQ2FjaGVLZXkoZW5kcG9pbnRTZWxlY3RvciksXG4gICAgbm9ybWFsaXplLndpdGhOb3JtYWxpemVkSW5wdXQoZW5kcG9pbnRTZWxlY3RvciksXG4gIF0uY29uY2F0KG1ldHJpY3MuTUVUUklDU19FTkFCTEVEID8gW21ldHJpY3Mud2l0aE1ldHJpY3NdIDogW10pXG5cbiAgcmV0dXJuIFtcbiAgICBFcnJvckJhY2tvZmYud2l0aEVycm9yQmFja29mZihzdG9yZVNsaWNlKCdlcnJvckJhY2tvZmYnKSksXG4gICAgaW9Mb2dnZXIud2l0aElPTG9nZ2VyLFxuICAgIHdpdGhDYWNoZShzdG9yZVNsaWNlKCdidXJzdExpbWl0JykpLFxuICAgIGNhY2hlV2FybWVyLndpdGhDYWNoZVdhcm1lcihzdG9yZVNsaWNlKCdjYWNoZVdhcm1lcicpLCB3YXJtZXJNaWRkbGV3YXJlLCB7XG4gICAgICBzdG9yZTogc3RvcmVTbGljZSgnd3MnKSxcbiAgICAgIG1ha2VXU0hhbmRsZXI6IG1ha2VXc0hhbmRsZXIsXG4gICAgfSkoZXhlY3V0ZSksXG4gICAgd3Mud2l0aFdlYlNvY2tldHMoc3RvcmVTbGljZSgnd3MnKSwgbWFrZVdzSGFuZGxlciksXG4gICAgUmF0ZUxpbWl0LndpdGhSYXRlTGltaXQoc3RvcmVTbGljZSgncmF0ZUxpbWl0JykpLFxuICAgIHN0YXR1c0NvZGUud2l0aFN0YXR1c0NvZGUsXG4gICAgQ2FjaGVLZXkud2l0aENhY2hlS2V5KGVuZHBvaW50U2VsZWN0b3IpLFxuICAgIG5vcm1hbGl6ZS53aXRoTm9ybWFsaXplZElucHV0KGVuZHBvaW50U2VsZWN0b3IpLFxuICBdLmNvbmNhdChtZXRyaWNzLk1FVFJJQ1NfRU5BQkxFRCA/IFttZXRyaWNzLndpdGhNZXRyaWNzLCBkZWJ1Zy53aXRoRGVidWddIDogW2RlYnVnLndpdGhEZWJ1Z10pXG59XG5cbi8vIFdyYXAgcmF3IEV4ZWN1dGUgZnVuY3Rpb24gd2l0aCBtaWRkbGV3YXJlXG5leHBvcnQgY29uc3Qgd2l0aE1pZGRsZXdhcmUgPSBhc3luYyAoXG4gIGV4ZWN1dGU6IEV4ZWN1dGUsXG4gIGNvbnRleHQ6IEFkYXB0ZXJDb250ZXh0LFxuICBtaWRkbGV3YXJlOiBNaWRkbGV3YXJlW10sXG4pOiBQcm9taXNlPEV4ZWN1dGU+ID0+IHtcbiAgLy8gSW5pdCBhbmQgd3JhcCBtaWRkbGV3YXJlIG9uZSBieSBvbmVcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBtaWRkbGV3YXJlLmxlbmd0aDsgaSsrKSB7XG4gICAgZXhlY3V0ZSA9IGF3YWl0IG1pZGRsZXdhcmVbaV0oZXhlY3V0ZSwgY29udGV4dClcbiAgfVxuICByZXR1cm4gZXhlY3V0ZVxufVxuXG4vLyBFeGVjdXRpb24gaGVscGVyIGFzeW5jID0+IHN5bmNcbmV4cG9ydCBjb25zdCBleGVjdXRlU3luYzogRXhlY3V0ZVN5bmMgPSBhc3luYyAoXG4gIGRhdGE6IEFkYXB0ZXJSZXF1ZXN0LFxuICBleGVjdXRlOiBFeGVjdXRlLFxuICBjb250ZXh0OiBBZGFwdGVyQ29udGV4dCxcbiAgY2FsbGJhY2s6IENhbGxiYWNrLFxuKSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZXhlY3V0ZShkYXRhLCBjb250ZXh0KVxuXG4gICAgcmV0dXJuIGNhbGxiYWNrKHJlc3VsdC5zdGF0dXNDb2RlLCByZXN1bHQpXG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc3QgZmVlZElEID0gbWV0cmljcy51dGlsLmdldEZlZWRJZChkYXRhKVxuICAgIHJldHVybiBjYWxsYmFjayhcbiAgICAgIGVycm9yLnN0YXR1c0NvZGUgfHwgNTAwLFxuICAgICAgUmVxdWVzdGVyLmVycm9yZWQoXG4gICAgICAgIGRhdGEuaWQsXG4gICAgICAgIGVycm9yLFxuICAgICAgICBlcnJvci5wcm92aWRlclJlc3BvbnNlU3RhdHVzQ29kZSB8fCBlcnJvci5zdGF0dXNDb2RlLFxuICAgICAgICBmZWVkSUQsXG4gICAgICApLFxuICAgIClcbiAgfVxufVxuXG5leHBvcnQgdHlwZSBFeHRlcm5hbEFkYXB0ZXIgPSB7XG4gIGV4ZWN1dGU6IEV4ZWN1dGVcbiAgbWFrZVdzSGFuZGxlcj86IE1ha2VXU0hhbmRsZXJcbiAgZW5kcG9pbnRTZWxlY3Rvcj86IChyZXF1ZXN0OiBBZGFwdGVyUmVxdWVzdCkgPT4gQVBJRW5kcG9pbnRcbn1cblxuZXhwb3J0IHR5cGUgRXhlY3V0ZUhhbmRsZXIgPSB7XG4gIHNlcnZlcjogKCkgPT4gUHJvbWlzZTxodHRwLlNlcnZlcj5cbn1cblxuZXhwb3J0IGNvbnN0IGV4cG9zZSA9IDxDIGV4dGVuZHMgQ29uZmlnPihcbiAgY29udGV4dDogQWRhcHRlckNvbnRleHQsXG4gIGV4ZWN1dGU6IEV4ZWN1dGUsXG4gIG1ha2VXc0hhbmRsZXI/OiBNYWtlV1NIYW5kbGVyLFxuICBlbmRwb2ludFNlbGVjdG9yPzogKHJlcXVlc3Q6IEFkYXB0ZXJSZXF1ZXN0KSA9PiBBUElFbmRwb2ludDxDPixcbik6IEV4ZWN1dGVIYW5kbGVyID0+IHtcbiAgdXRpbC5yZWdpc3RlclVuaGFuZGxlZFJlamVjdGlvbkhhbmRsZXIoKVxuXG4gIGNvbnN0IG1pZGRsZXdhcmUgPSBtYWtlTWlkZGxld2FyZShleGVjdXRlLCBtYWtlV3NIYW5kbGVyLCBlbmRwb2ludFNlbGVjdG9yKVxuICByZXR1cm4ge1xuICAgIHNlcnZlcjogc2VydmVyLmluaXRIYW5kbGVyKGNvbnRleHQsIGV4ZWN1dGUsIG1pZGRsZXdhcmUpLFxuICB9XG59XG5cbmV4cG9ydCB7XG4gIFJlcXVlc3RlcixcbiAgVmFsaWRhdG9yLFxuICBPdmVycmlkZXIsXG4gIENhY2hlS2V5LFxuICBBZGFwdGVyRXJyb3IsXG4gIEJ1aWxkZXIsXG4gIExvZ2dlcixcbiAgdXRpbCxcbiAgc2VydmVyLFxuICBDYWNoZSxcbiAgUmF0ZUxpbWl0LFxufVxuIl19