"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.make = exports.inputParameters = void 0;
const tslib_1 = require("tslib");
const ea_bootstrap_1 = require("@chainlink/ea-bootstrap");
const object_path_1 = tslib_1.__importDefault(require("object-path"));
const DEFAULT_DATA_PATH = 'result';
const DEFAULT_CONFIRMATIONS = 6;
const WARNING_UNSUPPORTED_PARAMS = 'No Operation: this provider does not support';
const ERROR_MISSING_ADDRESS = 'No Operation: address param is missing';
const requireArray = (jobRunID, dataPath, data) => {
    const inputData = object_path_1.default.get(data, dataPath);
    // Check if input data is valid
    if (!inputData || !Array.isArray(inputData) || inputData.length === 0)
        throw new ea_bootstrap_1.AdapterError({
            jobRunID,
            message: `Input, at '${dataPath}' path, must be a non-empty array.`,
            statusCode: 400,
        });
    return inputData;
};
const toValidAccount = (jobRunID, account, config) => {
    // Is it possible to process?
    if (!account.address)
        throw new ea_bootstrap_1.AdapterError({
            jobRunID,
            message: ERROR_MISSING_ADDRESS,
            statusCode: 400,
        });
    // Defaults
    if (!account.chain)
        account.chain = 'mainnet';
    if (!account.coin)
        account.coin = 'btc';
    // Do we support processing?
    const supported = config.isSupported(account.coin, account.chain);
    if (!supported)
        return { ...account, warning: WARNING_UNSUPPORTED_PARAMS + ` ${account.chain} ${account.coin}` };
    // If warning, clear and continue to processing
    const { warning, ...accNoWarning } = account;
    return accNoWarning;
};
const toGetBalances = (getBalance) => (accounts, config) => {
    return accounts.map((acc) => getBalance(acc, config));
};
exports.inputParameters = {
    dataPath: false,
    confirmations: false,
    addresses: false,
};
const make = (config) => async (input) => {
    const validator = new ea_bootstrap_1.Validator(input, exports.inputParameters);
    if (!config)
        throw new Error('No configuration supplied');
    config.confirmations = validator.validated.confirmations || DEFAULT_CONFIRMATIONS;
    const jobRunID = validator.validated.id;
    const dataPath = validator.validated.data.dataPath || DEFAULT_DATA_PATH;
    const accounts = requireArray(jobRunID, dataPath, input.data).map((acc) => toValidAccount(jobRunID, acc, config));
    const accountsToProcess = accounts.filter((acc) => !acc.warning);
    const getBalances = config.getBalances || toGetBalances(config.getBalance);
    const key = (acc) => `${acc.coin}-${acc.chain}`;
    const groups = Array.from(ea_bootstrap_1.util.groupBy(accountsToProcess, key).values());
    const requests = groups.flatMap((group) => getBalances(group, config));
    const responses = await Promise.all(requests);
    const responseLookup = Object.fromEntries(responses.flatMap((r) => r.result).map((a) => [`${a.address}-${a.coin}-${a.chain}`, a]));
    const data = {
        responses: responses.map((r) => r.payload),
        result: accounts.map((a) => responseLookup[`${a.address}-${a.coin}-${a.chain}`] || a),
    };
    if (!config.verbose)
        delete data.responses;
    return { jobRunID, statusCode: 200, data, result: data.result };
};
exports.make = make;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFsYW5jZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mYWN0b3JpZXMvYmFsYW5jZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsMERBQXVFO0FBU3ZFLHNFQUFvQztBQUVwQyxNQUFNLGlCQUFpQixHQUFHLFFBQVEsQ0FBQTtBQUNsQyxNQUFNLHFCQUFxQixHQUFHLENBQUMsQ0FBQTtBQUUvQixNQUFNLDBCQUEwQixHQUFHLDhDQUE4QyxDQUFBO0FBQ2pGLE1BQU0scUJBQXFCLEdBQUcsd0NBQXdDLENBQUE7QUEyQnRFLE1BQU0sWUFBWSxHQUFHLENBQUMsUUFBZ0IsRUFBRSxRQUFnQixFQUFFLElBQVMsRUFBRSxFQUFFO0lBQ3JFLE1BQU0sU0FBUyxHQUFjLHFCQUFVLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQTtJQUUzRCwrQkFBK0I7SUFDL0IsSUFBSSxDQUFDLFNBQVMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLElBQUksU0FBUyxDQUFDLE1BQU0sS0FBSyxDQUFDO1FBQ25FLE1BQU0sSUFBSSwyQkFBWSxDQUFDO1lBQ3JCLFFBQVE7WUFDUixPQUFPLEVBQUUsY0FBYyxRQUFRLG9DQUFvQztZQUNuRSxVQUFVLEVBQUUsR0FBRztTQUNoQixDQUFDLENBQUE7SUFFSixPQUFPLFNBQVMsQ0FBQTtBQUNsQixDQUFDLENBQUE7QUFFRCxNQUFNLGNBQWMsR0FBRyxDQUFDLFFBQWdCLEVBQUUsT0FBZ0IsRUFBRSxNQUFxQixFQUFXLEVBQUU7SUFDNUYsNkJBQTZCO0lBQzdCLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTztRQUNsQixNQUFNLElBQUksMkJBQVksQ0FBQztZQUNyQixRQUFRO1lBQ1IsT0FBTyxFQUFFLHFCQUFxQjtZQUM5QixVQUFVLEVBQUUsR0FBRztTQUNoQixDQUFDLENBQUE7SUFFSixXQUFXO0lBQ1gsSUFBSSxDQUFDLE9BQU8sQ0FBQyxL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Q0FBQyxRQUFRLENBQUMsQ0FBQTtJQUM3QyxNQUFNLGNBQWMsR0FBRyxNQUFNLENBQUMsV0FBVyxDQUN2QyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sSUFBSSxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUN4RixDQUFBO0lBRUQsTUFBTSxJQUFJLEdBQWtDO1FBQzFDLFNBQVMsRUFBRSxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDO1FBQy9DLE1BQU0sRUFBRSxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLENBQUMsT0FBTyxJQUFJLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO0tBQ3RGLENBQUE7SUFFRCxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU87UUFBRSxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUE7SUFFMUMsT0FBTyxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFBO0FBQ2pFLENBQUMsQ0FBQTtBQWhDWSxRQUFBLElBQUksUUFnQ2hCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWRhcHRlckVycm9yLCB1dGlsLCBWYWxpZGF0b3IgfSBmcm9tICdAY2hhaW5saW5rL2VhLWJvb3RzdHJhcCdcbmltcG9ydCB7XG4gIEFjY291bnQsXG4gIENvbmZpZyxcbiAgRGF0YVJlc3BvbnNlLFxuICBFeGVjdXRlRmFjdG9yeSxcbiAgU2VxdWVuY2VSZXNwb25zZURhdGEsXG4gIElucHV0UGFyYW1ldGVycyxcbn0gZnJvbSAnQGNoYWlubGluay90eXBlcydcbmltcG9ydCBvYmplY3RQYXRoIGZyb20gJ29iamVjdC1wYXRoJ1xuXG5jb25zdCBERUZBVUxUX0RBVEFfUEFUSCA9ICdyZXN1bHQnXG5jb25zdCBERUZBVUxUX0NPTkZJUk1BVElPTlMgPSA2XG5cbmNvbnN0IFdBUk5JTkdfVU5TVVBQT1JURURfUEFSQU1TID0gJ05vIE9wZXJhdGlvbjogdGhpcyBwcm92aWRlciBkb2VzIG5vdCBzdXBwb3J0J1xuY29uc3QgRVJST1JfTUlTU0lOR19BRERSRVNTID0gJ05vIE9wZXJhdGlvbjogYWRkcmVzcyBwYXJhbSBpcyBtaXNzaW5nJ1xuXG5leHBvcnQgdHlwZSBJc1N1cHBvcnRlZCA9IChjb2luOiBzdHJpbmcsIGNoYWluOiBzdHJpbmcpID0+IGJvb2xlYW5cbmV4cG9ydCB0eXBlIEJhbGFuY2VzUmVzcG9uc2UgPSBEYXRhUmVzcG9uc2U8QWNjb3VudFtdLCBhbnk+XG5leHBvcnQgdHlwZSBHZXRCYWxhbmNlID0gKGFjY291bnQ6IEFjY291bnQsIGNvbmZpZzogQmFsYW5jZUNvbmZpZykgPT4gUHJvbWlzZTxCYWxhbmNlc1Jlc3BvbnNlPlxuZXhwb3J0IHR5cGUgR2V0QmFsYW5jZXMgPSAoYWNjb3VudHM6IEFjY291bnRbXSwgY29uZmlnOiBCYWxhbmNlQ29uZmlnKSA9PiBQcm9taXNlPEJhbGFuY2VzUmVzcG9uc2U+XG5cbnR5cGUgQmFzZUJhbGFuY2VDb25maWcgPSBDb25maWcgJiB7XG4gIGNvbmZpcm1hdGlvbnM/OiBudW1iZXJcbiAgaXNTdXBwb3J0ZWQ6IElzU3VwcG9ydGVkXG4gIGdldEJhbGFuY2U/OiBHZXRCYWxhbmNlXG4gIGdldEJhbGFuY2VzPzogR2V0QmFsYW5jZXNcbn1cblxudHlwZSBTaW5nbGVCYWxhbmNlQ29uZmlnID0gQmFzZUJhbGFuY2VDb25maWcgJiB7XG4gIGdldEJhbGFuY2U6IEdldEJhbGFuY2VcbiAgZ2V0QmFsYW5jZXM/OiBuZXZlclxufVxuXG50eXBlIEJhdGNoQmFsYW5jZUNvbmZpZyA9IEJhc2VCYWxhbmNlQ29uZmlnICYge1xuICBnZXRCYWxhbmNlPzogbmV2ZXJcbiAgZ2V0QmFsYW5jZXM6IEdldEJhbGFuY2VzXG59XG5cbi8vIFNwbGl0cyB0eXBlcyAmIHJlLXVuaW9ucyB0byBhY2hpZXZlIFwib25seSBvbmUgb2YgZWl0aGVyIGdldEJhbGFuY2Ugb3IgZ2V0QmFsYW5jZXNcIiB0eXBlXG5leHBvcnQgdHlwZSBCYWxhbmNlQ29uZmlnID0gU2luZ2xlQmFsYW5jZUNvbmZpZyB8IEJhdGNoQmFsYW5jZUNvbmZpZ1xuXG5jb25zdCByZXF1aXJlQXJyYXkgPSAoam9iUnVuSUQ6IHN0cmluZywgZGF0YVBhdGg6IHN0cmluZywgZGF0YTogYW55KSA9PiB7XG4gIGNvbnN0IGlucHV0RGF0YSA9IDxBY2NvdW50W10+b2JqZWN0UGF0aC5nZXQoZGF0YSwgZGF0YVBhdGgpXG5cbiAgLy8gQ2hlY2sgaWYgaW5wdXQgZGF0YSBpcyB2YWxpZFxuICBpZiAoIWlucHV0RGF0YSB8fCAhQXJyYXkuaXNBcnJheShpbnB1dERhdGEpIHx8IGlucHV0RGF0YS5sZW5ndGggPT09IDApXG4gICAgdGhyb3cgbmV3IEFkYXB0ZXJFcnJvcih7XG4gICAgICBqb2JSdW5JRCxcbiAgICAgIG1lc3NhZ2U6IGBJbnB1dCwgYXQgJyR7ZGF0YVBhdGh9JyBwYXRoLCBtdXN0IGJlIGEgbm9uLWVtcHR5IGFycmF5LmAsXG4gICAgICBzdGF0dXNDb2RlOiA0MDAsXG4gICAgfSlcblxuICByZXR1cm4gaW5wdXREYXRhXG59XG5cbmNvbnN0IHRvVmFsaWRBY2NvdW50ID0gKGpvYlJ1bklEOiBzdHJpbmcsIGFjY291bnQ6IEFjY291bnQsIGNvbmZpZzogQmFsYW5jZUNvbmZpZyk6IEFjY291bnQgPT4ge1xuICAvLyBJcyBpdCBwb3NzaWJsZSB0byBwcm9jZXNzP1xuICBpZiAoIWFjY291bnQuYWRkcmVzcylcbiAgICB0aHJvdyBuZXcgQWRhcHRlckVycm9yKHtcbiAgICAgIGpvYlJ1bklELFxuICAgICAgbWVzc2FnZTogRVJST1JfTUlTU0lOR19BRERSRVNTLFxuICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgIH0pXG5cbiAgLy8gRGVmYXVsdHNcbiAgaWYgKCFhY2NvdW50LmNoYWluKSBhY2NvdW50LmNoYWluID0gJ21haW5uZXQnXG4gIGlmICghYWNjb3VudC5jb2luKSBhY2NvdW50LmNvaW4gPSAnYnRjJ1xuXG4gIC8vIERvIHdlIHN1cHBvcnQgcHJvY2Vzc2luZz9cbiAgY29uc3Qgc3VwcG9ydGVkID0gY29uZmlnLmlzU3VwcG9ydGVkKGFjY291bnQuY29pbiwgYWNjb3VudC5jaGFpbilcbiAgaWYgKCFzdXBwb3J0ZWQpXG4gICAgcmV0dXJuIHsgLi4uYWNjb3VudCwgd2FybmluZzogV0FSTklOR19VTlNVUFBPUlRFRF9QQVJBTVMgKyBgICR7YWNjb3VudC5jaGFpbn0gJHthY2NvdW50LmNvaW59YCB9XG5cbiAgLy8gSWYgd2FybmluZywgY2xlYXIgYW5kIGNvbnRpbnVlIHRvIHByb2Nlc3NpbmdcbiAgY29uc3QgeyB3YXJuaW5nLCAuLi5hY2NOb1dhcm5pbmcgfSA9IGFjY291bnRcbiAgcmV0dXJuIGFjY05vV2FybmluZ1xufVxuXG5jb25zdCB0b0dldEJhbGFuY2VzID0gKGdldEJhbGFuY2U6IEdldEJhbGFuY2UpID0+IChhY2NvdW50czogQWNjb3VudFtdLCBjb25maWc6IEJhbGFuY2VDb25maWcpID0+IHtcbiAgcmV0dXJuIGFjY291bnRzLm1hcCgoYWNjKSA9PiBnZXRCYWxhbmNlKGFjYywgY29uZmlnKSlcbn1cblxuZXhwb3J0IGNvbnN0IGlucHV0UGFyYW1ldGVyczogSW5wdXRQYXJhbWV0ZXJzID0ge1xuICBkYXRhUGF0aDogZmFsc2UsXG4gIGNvbmZpcm1hdGlvbnM6IGZhbHNlLFxuICBhZGRyZXNzZXM6IGZhbHNlLFxufVxuXG5leHBvcnQgY29uc3QgbWFrZTogRXhlY3V0ZUZhY3Rvcnk8QmFsYW5jZUNvbmZpZz4gPSAoY29uZmlnKSA9PiBhc3luYyAoaW5wdXQpID0+IHtcbiAgY29uc3QgdmFsaWRhdG9yID0gbmV3IFZhbGlkYXRvcihpbnB1dCwgaW5wdXRQYXJhbWV0ZXJzKVxuXG4gIGlmICghY29uZmlnKSB0aHJvdyBuZXcgRXJyb3IoJ05vIGNvbmZpZ3VyYXRpb24gc3VwcGxpZWQnKVxuXG4gIGNvbmZpZy5jb25maXJtYXRpb25zID0gdmFsaWRhdG9yLnZhbGlkYXRlZC5jb25maXJtYXRpb25zIHx8IERFRkFVTFRfQ09ORklSTUFUSU9OU1xuICBjb25zdCBqb2JSdW5JRCA9IHZhbGlkYXRvci52YWxpZGF0ZWQuaWRcbiAgY29uc3QgZGF0YVBhdGggPSB2YWxpZGF0b3IudmFsaWRhdGVkLmRhdGEuZGF0YVBhdGggfHwgREVGQVVMVF9EQVRBX1BBVEhcblxuICBjb25zdCBhY2NvdW50cyA9IHJlcXVpcmVBcnJheShqb2JSdW5JRCwgZGF0YVBhdGgsIGlucHV0LmRhdGEpLm1hcCgoYWNjKSA9PlxuICAgIHRvVmFsaWRBY2NvdW50KGpvYlJ1bklELCBhY2MsIGNvbmZpZyksXG4gIClcbiAgY29uc3QgYWNjb3VudHNUb1Byb2Nlc3MgPSBhY2NvdW50cy5maWx0ZXIoKGFjYykgPT4gIWFjYy53YXJuaW5nKVxuXG4gIGNvbnN0IGdldEJhbGFuY2VzID0gY29uZmlnLmdldEJhbGFuY2VzIHx8IHRvR2V0QmFsYW5jZXMoY29uZmlnLmdldEJhbGFuY2UpXG5cbiAgY29uc3Qga2V5ID0gKGFjYzogQWNjb3VudCkgPT4gYCR7YWNjLmNvaW59LSR7YWNjLmNoYWlufWBcbiAgY29uc3QgZ3JvdXBzID0gQXJyYXkuZnJvbSh1dGlsLmdyb3VwQnkoYWNjb3VudHNUb1Byb2Nlc3MsIGtleSkudmFsdWVzKCkpXG4gIGNvbnN0IHJlcXVlc3RzID0gZ3JvdXBzLmZsYXRNYXAoKGdyb3VwKSA9PiBnZXRCYWxhbmNlcyhncm91cCBhcyBBY2NvdW50W10sIGNvbmZpZykpXG4gIGNvbnN0IHJlc3BvbnNlcyA9IGF3YWl0IFByb21pc2UuYWxsKHJlcXVlc3RzKVxuICBjb25zdCByZXNwb25zZUxvb2t1cCA9IE9iamVjdC5mcm9tRW50cmllczxBY2NvdW50PihcbiAgICByZXNwb25zZXMuZmxhdE1hcCgocikgPT4gci5yZXN1bHQpLm1hcCgoYSkgPT4gW2Ake2EuYWRkcmVzc30tJHthLmNvaW59LSR7YS5jaGFpbn1gLCBhXSksXG4gIClcblxuICBjb25zdCBkYXRhOiBTZXF1ZW5jZVJlc3BvbnNlRGF0YTxBY2NvdW50PiA9IHtcbiAgICByZXNwb25zZXM6IHJlc3BvbnNlcy5tYXAoKHI6IGFueSkgPT4gci5wYXlsb2FkKSxcbiAgICByZXN1bHQ6IGFjY291bnRzLm1hcCgoYSkgPT4gcmVzcG9uc2VMb29rdXBbYCR7YS5hZGRyZXNzfS0ke2EuY29pbn0tJHthLmNoYWlufWBdIHx8IGEpLFxuICB9XG5cbiAgaWYgKCFjb25maWcudmVyYm9zZSkgZGVsZXRlIGRhdGEucmVzcG9uc2VzXG5cbiAgcmV0dXJuIHsgam9iUnVuSUQsIHN0YXR1c0NvZGU6IDIwMCwgZGF0YSwgcmVzdWx0OiBkYXRhLnJlc3VsdCB9XG59XG4iXX0=